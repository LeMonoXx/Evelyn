{"ast":null,"code":"import * as i0 from '@angular/core';\nimport { Injectable, Optional, Inject, NgModule, InjectionToken } from '@angular/core';\nimport { DOCUMENT, CommonModule } from '@angular/common';\nimport * as i1 from '@angular/common/http';\nimport { HttpHeaders, HttpParams, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { __awaiter } from 'tslib';\nimport { Subject, of, from, race, throwError, combineLatest, merge } from 'rxjs';\nimport { filter, tap, debounceTime, delay, switchMap, map, first, catchError, timeout, take, mergeMap } from 'rxjs/operators';\nimport fsha256 from 'fast-sha256';\n\nclass DateTimeProvider {}\n\nclass SystemDateTimeProvider extends DateTimeProvider {\n  now() {\n    return Date.now();\n  }\n\n  new() {\n    return new Date();\n  }\n\n}\n\nSystemDateTimeProvider.ɵfac = /* @__PURE__ */function () {\n  let ɵSystemDateTimeProvider_BaseFactory;\n  return function SystemDateTimeProvider_Factory(t) {\n    return (ɵSystemDateTimeProvider_BaseFactory || (ɵSystemDateTimeProvider_BaseFactory = i0.ɵɵgetInheritedFactory(SystemDateTimeProvider)))(t || SystemDateTimeProvider);\n  };\n}();\n\nSystemDateTimeProvider.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: SystemDateTimeProvider,\n  factory: SystemDateTimeProvider.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SystemDateTimeProvider, [{\n    type: Injectable\n  }], null, null);\n})();\n/**\r\n * Additional options that can be passed to tryLogin.\r\n */\n\n\nclass LoginOptions {\n  constructor() {\n    /**\r\n     * Set this to true to disable the nonce\r\n     * check which is used to avoid\r\n     * replay attacks.\r\n     * This flag should never be true in\r\n     * production environments.\r\n     */\n    this.disableNonceCheck = false;\n    /**\r\n     * Normally, you want to clear your hash fragment after\r\n     * the lib read the token(s) so that they are not displayed\r\n     * anymore in the url. If not, set this to true. For code flow\r\n     * this controls removing query string values.\r\n     */\n\n    this.preventClearHashAfterLogin = false;\n  }\n\n}\n/**\r\n * Defines the logging interface the OAuthService uses\r\n * internally. Is compatible with the `console` object,\r\n * but you can provide your own implementation as well\r\n * through dependency injection.\r\n */\n\n\nclass OAuthLogger {}\n/**\r\n * Defines a simple storage that can be used for\r\n * storing the tokens at client side.\r\n * Is compatible to localStorage and sessionStorage,\r\n * but you can also create your own implementations.\r\n */\n\n\nclass OAuthStorage {}\n\nclass MemoryStorage {\n  constructor() {\n    this.data = new Map();\n  }\n\n  getItem(key) {\n    return this.data.get(key);\n  }\n\n  removeItem(key) {\n    this.data.delete(key);\n  }\n\n  setItem(key, data) {\n    this.data.set(key, data);\n  }\n\n}\n\nMemoryStorage.ɵfac = function MemoryStorage_Factory(t) {\n  return new (t || MemoryStorage)();\n};\n\nMemoryStorage.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: MemoryStorage,\n  factory: MemoryStorage.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MemoryStorage, [{\n    type: Injectable\n  }], null, null);\n})();\n/**\r\n * Represents the received tokens, the received state\r\n * and the parsed claims from the id-token.\r\n */\n\n\nclass ReceivedTokens {}\n\nclass OAuthEvent {\n  constructor(type) {\n    this.type = type;\n  }\n\n}\n\nclass OAuthSuccessEvent extends OAuthEvent {\n  constructor(type, info = null) {\n    super(type);\n    this.info = info;\n  }\n\n}\n\nclass OAuthInfoEvent extends OAuthEvent {\n  constructor(type, info = null) {\n    super(type);\n    this.info = info;\n  }\n\n}\n\nclass OAuthErrorEvent extends OAuthEvent {\n  constructor(type, reason, params = null) {\n    super(type);\n    this.reason = reason;\n    this.params = params;\n  }\n\n} // see: https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_.22Unicode_Problem.22\n\n\nfunction b64DecodeUnicode(str) {\n  const base64 = str.replace(/\\-/g, '+').replace(/\\_/g, '/');\n  return decodeURIComponent(atob(base64).split('').map(function (c) {\n    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\n  }).join(''));\n}\n\nfunction base64UrlEncode(str) {\n  const base64 = btoa(str);\n  return base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\n}\n\nclass AuthConfig {\n  constructor(json) {\n    /**\r\n     * The client's id as registered with the auth server\r\n     */\n    this.clientId = '';\n    /**\r\n     * The client's redirectUri as registered with the auth server\r\n     */\n\n    this.redirectUri = '';\n    /**\r\n     * An optional second redirectUri where the auth server\r\n     * redirects the user to after logging out.\r\n     */\n\n    this.postLogoutRedirectUri = '';\n    /**\r\n     * Defines whether to use 'redirectUri' as a replacement\r\n     * of 'postLogoutRedirectUri' if the latter is not set.\r\n     */\n\n    this.redirectUriAsPostLogoutRedirectUriFallback = true;\n    /**\r\n     * The auth server's endpoint that allows to log\r\n     * the user in when using implicit flow.\r\n     */\n\n    this.loginUrl = '';\n    /**\r\n     * The requested scopes\r\n     */\n\n    this.scope = 'openid profile';\n    this.resource = '';\n    this.rngUrl = '';\n    /**\r\n     * Defines whether to use OpenId Connect during\r\n     * implicit flow.\r\n     */\n\n    this.oidc = true;\n    /**\r\n     * Defines whether to request an access token during\r\n     * implicit flow.\r\n     */\n\n    this.requestAccessToken = true;\n    this.options = null;\n    /**\r\n     * The issuer's uri.\r\n     */\n\n    this.issuer = '';\n    /**\r\n     * The logout url.\r\n     */\n\n    this.logoutUrl = '';\n    /**\r\n     * Defines whether to clear the hash fragment after logging in.\r\n     */\n\n    this.clearHashAfterLogin = true;\n    /**\r\n     * Url of the token endpoint as defined by OpenId Connect and OAuth 2.\r\n     */\n\n    this.tokenEndpoint = null;\n    /**\r\n     * Url of the revocation endpoint as defined by OpenId Connect and OAuth 2.\r\n     */\n\n    this.revocationEndpoint = null;\n    /**\r\n     * Names of known parameters sent out in the TokenResponse. https://tools.ietf.org/html/rfc6749#section-5.1\r\n     */\n\n    this.customTokenParameters = [];\n    /**\r\n     * Url of the userinfo endpoint as defined by OpenId Connect.\r\n     */\n\n    this.userinfoEndpoint = null;\n    this.responseType = '';\n    /**\r\n     * Defines whether additional debug information should\r\n     * be shown at the console. Note that in certain browsers\r\n     * the verbosity of the console needs to be explicitly set\r\n     * to include Debug level messages.\r\n     */\n\n    this.showDebugInformation = false;\n    /**\r\n     * The redirect uri used when doing silent refresh.\r\n     */\n\n    this.silentRefreshRedirectUri = '';\n    this.silentRefreshMessagePrefix = '';\n    /**\r\n     * Set this to true to display the iframe used for\r\n     * silent refresh for debugging.\r\n     */\n\n    this.silentRefreshShowIFrame = false;\n    /**\r\n     * Timeout for silent refresh.\r\n     * @internal\r\n     * depreacted b/c of typo, see silentRefreshTimeout\r\n     */\n\n    this.siletRefreshTimeout = 1000 * 20;\n    /**\r\n     * Timeout for silent refresh.\r\n     */\n\n    this.silentRefreshTimeout = 1000 * 20;\n    /**\r\n     * Some auth servers don't allow using password flow\r\n     * w/o a client secret while the standards do not\r\n     * demand for it. In this case, you can set a password\r\n     * here. As this password is exposed to the public\r\n     * it does not bring additional security and is therefore\r\n     * as good as using no password.\r\n     */\n\n    this.dummyClientSecret = null;\n    /**\r\n     * Defines whether https is required.\r\n     * The default value is remoteOnly which only allows\r\n     * http for localhost, while every other domains need\r\n     * to be used with https.\r\n     */\n\n    this.requireHttps = 'remoteOnly';\n    /**\r\n     * Defines whether every url provided by the discovery\r\n     * document has to start with the issuer's url.\r\n     */\n\n    this.strictDiscoveryDocumentValidation = true;\n    /**\r\n     * JSON Web Key Set (https://tools.ietf.org/html/rfc7517)\r\n     * with keys used to validate received id_tokens.\r\n     * This is taken out of the disovery document. Can be set manually too.\r\n     */\n\n    this.jwks = null;\n    /**\r\n     * Map with additional query parameter that are appended to\r\n     * the request when initializing implicit flow.\r\n     */\n\n    this.customQueryParams = null;\n    this.silentRefreshIFrameName = 'angular-oauth-oidc-silent-refresh-iframe';\n    /**\r\n     * Defines when the token_timeout event should be raised.\r\n     * If you set this to the default value 0.75, the event\r\n     * is triggered after 75% of the token's life time.\r\n     */\n\n    this.timeoutFactor = 0.75;\n    /**\r\n     * If true, the lib will try to check whether the user\r\n     * is still logged in on a regular basis as described\r\n     * in http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n     */\n\n    this.sessionChecksEnabled = false;\n    /**\r\n     * Interval in msec for checking the session\r\n     * according to http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n     */\n\n    this.sessionCheckIntervall = 3 * 1000;\n    /**\r\n     * Url for the iframe used for session checks\r\n     */\n\n    this.sessionCheckIFrameUrl = null;\n    /**\r\n     * Name of the iframe to use for session checks\r\n     */\n\n    this.sessionCheckIFrameName = 'angular-oauth-oidc-check-session-iframe';\n    /**\r\n     * This property has been introduced to disable at_hash checks\r\n     * and is indented for Identity Provider that does not deliver\r\n     * an at_hash EVEN THOUGH its recommended by the OIDC specs.\r\n     * Of course, when disabling these checks then we are bypassing\r\n     * a security check which means we are more vulnerable.\r\n     */\n\n    this.disableAtHashCheck = false;\n    /**\r\n     * Defines wether to check the subject of a refreshed token after silent refresh.\r\n     * Normally, it should be the same as before.\r\n     */\n\n    this.skipSubjectCheck = false;\n    this.useIdTokenHintForSilentRefresh = false;\n    /**\r\n     * Defined whether to skip the validation of the issuer in the discovery document.\r\n     * Normally, the discovey document's url starts with the url of the issuer.\r\n     */\n\n    this.skipIssuerCheck = false;\n    /**\r\n     * final state sent to issuer is built as follows:\r\n     * state = nonce + nonceStateSeparator + additional state\r\n     * Default separator is ';' (encoded %3B).\r\n     * In rare cases, this character might be forbidden or inconvenient to use by the issuer so it can be customized.\r\n     */\n\n    this.nonceStateSeparator = ';';\n    /**\r\n     * Set this to true to use HTTP BASIC auth for AJAX calls\r\n     */\n\n    this.useHttpBasicAuth = false;\n    /**\r\n     * The interceptors waits this time span if there is no token\r\n     */\n\n    this.waitForTokenInMsec = 0;\n    /**\r\n     * Code Flow is by defauld used together with PKCI which is also higly recommented.\r\n     * You can disbale it here by setting this flag to true.\r\n     * https://tools.ietf.org/html/rfc7636#section-1.1\r\n     */\n\n    this.disablePKCE = false;\n    /**\r\n     * Set this to true to preserve the requested route including query parameters after code flow login.\r\n     * This setting enables deep linking for the code flow.\r\n     */\n\n    this.preserveRequestedRoute = false;\n    /**\r\n     * This property allows you to override the method that is used to open the login url,\r\n     * allowing a way for implementations to specify their own method of routing to new\r\n     * urls.\r\n     */\n\n    this.openUri = uri => {\n      location.href = uri;\n    };\n\n    if (json) {\n      Object.assign(this, json);\n    }\n  }\n\n}\n/**\r\n * This custom encoder allows charactes like +, % and / to be used in passwords\r\n */\n\n\nclass WebHttpUrlEncodingCodec {\n  encodeKey(k) {\n    return encodeURIComponent(k);\n  }\n\n  encodeValue(v) {\n    return encodeURIComponent(v);\n  }\n\n  decodeKey(k) {\n    return decodeURIComponent(k);\n  }\n\n  decodeValue(v) {\n    return decodeURIComponent(v);\n  }\n\n}\n/**\r\n * Interface for Handlers that are hooked in to\r\n * validate tokens.\r\n */\n\n\nclass ValidationHandler {}\n/**\r\n * This abstract implementation of ValidationHandler already implements\r\n * the method validateAtHash. However, to make use of it,\r\n * you have to override the method calcHash.\r\n */\n\n\nclass AbstractValidationHandler {\n  /**\r\n   * Validates the at_hash in an id_token against the received access_token.\r\n   */\n  validateAtHash(params) {\n    return __awaiter(this, void 0, void 0, function* () {\n      let hashAlg = this.inferHashAlgorithm(params.idTokenHeader);\n      let tokenHash = yield this.calcHash(params.accessToken, hashAlg); // sha256(accessToken, { asString: true });\n\n      let leftMostHalf = tokenHash.substr(0, tokenHash.length / 2);\n      let atHash = base64UrlEncode(leftMostHalf);\n      let claimsAtHash = params.idTokenClaims['at_hash'].replace(/=/g, '');\n\n      if (atHash !== claimsAtHash) {\n        console.error('exptected at_hash: ' + atHash);\n        console.error('actual at_hash: ' + claimsAtHash);\n      }\n\n      return atHash === claimsAtHash;\n    });\n  }\n  /**\r\n   * Infers the name of the hash algorithm to use\r\n   * from the alg field of an id_token.\r\n   *\r\n   * @param jwtHeader the id_token's parsed header\r\n   */\n\n\n  inferHashAlgorithm(jwtHeader) {\n    let alg = jwtHeader['alg'];\n\n    if (!alg.match(/^.S[0-9]{3}$/)) {\n      throw new Error('Algorithm not supported: ' + alg);\n    }\n\n    return 'sha-' + alg.substr(2);\n  }\n\n}\n\nclass UrlHelperService {\n  getHashFragmentParams(customHashFragment) {\n    let hash = customHashFragment || window.location.hash;\n    hash = decodeURIComponent(hash);\n\n    if (hash.indexOf('#') !== 0) {\n      return {};\n    }\n\n    const questionMarkPosition = hash.indexOf('?');\n\n    if (questionMarkPosition > -1) {\n      hash = hash.substr(questionMarkPosition + 1);\n    } else {\n      hash = hash.substr(1);\n    }\n\n    return this.parseQueryString(hash);\n  }\n\n  parseQueryString(queryString) {\n    const data = {};\n    let pairs, pair, separatorIndex, escapedKey, escapedValue, key, value;\n\n    if (queryString === null) {\n      return data;\n    }\n\n    pairs = queryString.split('&');\n\n    for (let i = 0; i < pairs.length; i++) {\n      pair = pairs[i];\n      separatorIndex = pair.indexOf('=');\n\n      if (separatorIndex === -1) {\n        escapedKey = pair;\n        escapedValue = null;\n      } else {\n        escapedKey = pair.substr(0, separatorIndex);\n        escapedValue = pair.substr(separatorIndex + 1);\n      }\n\n      key = decodeURIComponent(escapedKey);\n      value = decodeURIComponent(escapedValue);\n\n      if (key.substr(0, 1) === '/') {\n        key = key.substr(1);\n      }\n\n      data[key] = value;\n    }\n\n    return data;\n  }\n\n}\n\nUrlHelperService.ɵfac = function UrlHelperService_Factory(t) {\n  return new (t || UrlHelperService)();\n};\n\nUrlHelperService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: UrlHelperService,\n  factory: UrlHelperService.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(UrlHelperService, [{\n    type: Injectable\n  }], null, null);\n})();\n/**\r\n * [js-sha256]{@link https://github.com/emn178/js-sha256}\r\n *\r\n * @version 0.9.0\r\n * @author Chen, Yi-Cyuan [emn178@gmail.com]\r\n * @copyright Chen, Yi-Cyuan 2014-2017\r\n * @license MIT\r\n */\n\n/*jslint bitwise: true */\n\n\nfunction factory() {\n  var ERROR = 'input is invalid type';\n  var WINDOW = typeof window === 'object';\n  var root = WINDOW ? window : {};\n\n  if (root.JS_SHA256_NO_WINDOW) {\n    WINDOW = false;\n  }\n\n  var WEB_WORKER = !WINDOW && typeof self === 'object';\n  var NODE_JS = !root.JS_SHA256_NO_NODE_JS && typeof process === 'object' && process.versions && process.versions.node;\n\n  if (NODE_JS) {\n    root = global;\n  } else if (WEB_WORKER) {\n    root = self;\n  }\n\n  var COMMON_JS = !root.JS_SHA256_NO_COMMON_JS && typeof module === 'object' && module.exports;\n  var AMD = typeof define === 'function' && define.amd;\n  var ARRAY_BUFFER = !root.JS_SHA256_NO_ARRAY_BUFFER && typeof ArrayBuffer !== 'undefined';\n  const HEX_CHARS = '0123456789abcdef'.split('');\n  const EXTRA = [-2147483648, 8388608, 32768, 128];\n  const SHIFT = [24, 16, 8, 0];\n  const K = [0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5, 0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174, 0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85, 0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070, 0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3, 0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2];\n  const OUTPUT_TYPES = ['hex', 'array', 'digest', 'arrayBuffer'];\n  var blocks = [];\n\n  if (root.JS_SHA256_NO_NODE_JS || !Array.isArray) {\n    Array.isArray = function (obj) {\n      return Object.prototype.toString.call(obj) === '[object Array]';\n    };\n  }\n\n  if (ARRAY_BUFFER && (root.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW || !ArrayBuffer.isView)) {\n    ArrayBuffer.isView = function (obj) {\n      return typeof obj === 'object' && obj.buffer && obj.buffer.constructor === ArrayBuffer;\n    };\n  }\n\n  var createOutputMethod = function (outputType, is224) {\n    return function (message) {\n      return new Sha256(is224, true).update(message)[outputType]();\n    };\n  };\n\n  var createMethod = function (is224) {\n    var method = createOutputMethod('hex', is224);\n\n    if (NODE_JS) {\n      method = nodeWrap(method, is224);\n    }\n\n    method.create = function () {\n      return new Sha256(is224);\n    };\n\n    method.update = function (message) {\n      return method.create().update(message);\n    };\n\n    for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\n      var type = OUTPUT_TYPES[i];\n      method[type] = createOutputMethod(type, is224);\n    }\n\n    return method;\n  };\n\n  var nodeWrap = function (method, is224) {\n    var crypto = eval(\"require('crypto')\");\n    var Buffer = eval(\"require('buffer').Buffer\");\n    var algorithm = is224 ? 'sha224' : 'sha256';\n\n    var nodeMethod = function (message) {\n      if (typeof message === 'string') {\n        return crypto.createHash(algorithm).update(message, 'utf8').digest('hex');\n      } else {\n        if (message === null || message === undefined) {\n          throw new Error(ERROR);\n        } else if (message.constructor === ArrayBuffer) {\n          message = new Uint8Array(message);\n        }\n      }\n\n      if (Array.isArray(message) || ArrayBuffer.isView(message) || message.constructor === Buffer) {\n        return crypto.createHash(algorithm).update(new Buffer(message)).digest('hex');\n      } else {\n        return method(message);\n      }\n    };\n\n    return nodeMethod;\n  };\n\n  var createHmacOutputMethod = function (outputType, is224) {\n    return function (key, message) {\n      return new HmacSha256(key, is224, true).update(message)[outputType]();\n    };\n  };\n\n  var createHmacMethod = function (is224) {\n    var method = createHmacOutputMethod('hex', is224);\n\n    method.create = function (key) {\n      return new HmacSha256(key, is224);\n    };\n\n    method.update = function (key, message) {\n      return method.create(key).update(message);\n    };\n\n    for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\n      var type = OUTPUT_TYPES[i];\n      method[type] = createHmacOutputMethod(type, is224);\n    }\n\n    return method;\n  };\n\n  function Sha256(is224, sharedMemory) {\n    if (sharedMemory) {\n      blocks[0] = blocks[16] = blocks[1] = blocks[2] = blocks[3] = blocks[4] = blocks[5] = blocks[6] = blocks[7] = blocks[8] = blocks[9] = blocks[10] = blocks[11] = blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\n      this.blocks = blocks;\n    } else {\n      this.blocks = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n    }\n\n    if (is224) {\n      this.h0 = 0xc1059ed8;\n      this.h1 = 0x367cd507;\n      this.h2 = 0x3070dd17;\n      this.h3 = 0xf70e5939;\n      this.h4 = 0xffc00b31;\n      this.h5 = 0x68581511;\n      this.h6 = 0x64f98fa7;\n      this.h7 = 0xbefa4fa4;\n    } else {\n      // 256\n      this.h0 = 0x6a09e667;\n      this.h1 = 0xbb67ae85;\n      this.h2 = 0x3c6ef372;\n      this.h3 = 0xa54ff53a;\n      this.h4 = 0x510e527f;\n      this.h5 = 0x9b05688c;\n      this.h6 = 0x1f83d9ab;\n      this.h7 = 0x5be0cd19;\n    }\n\n    this.block = this.start = this.bytes = this.hBytes = 0;\n    this.finalized = this.hashed = false;\n    this.first = true;\n    this.is224 = is224;\n  }\n\n  Sha256.prototype.update = function (message) {\n    if (this.finalized) {\n      return;\n    }\n\n    var notString,\n        type = typeof message;\n\n    if (type !== 'string') {\n      if (type === 'object') {\n        if (message === null) {\n          throw new Error(ERROR);\n        } else if (ARRAY_BUFFER && message.constructor === ArrayBuffer) {\n          message = new Uint8Array(message);\n        } else if (!Array.isArray(message)) {\n          if (!ARRAY_BUFFER || !ArrayBuffer.isView(message)) {\n            throw new Error(ERROR);\n          }\n        }\n      } else {\n        throw new Error(ERROR);\n      }\n\n      notString = true;\n    }\n\n    var code,\n        index = 0,\n        i,\n        length = message.length,\n        blocks = this.blocks;\n\n    while (index < length) {\n      if (this.hashed) {\n        this.hashed = false;\n        blocks[0] = this.block;\n        blocks[16] = blocks[1] = blocks[2] = blocks[3] = blocks[4] = blocks[5] = blocks[6] = blocks[7] = blocks[8] = blocks[9] = blocks[10] = blocks[11] = blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\n      }\n\n      if (notString) {\n        for (i = this.start; index < length && i < 64; ++index) {\n          blocks[i >> 2] |= message[index] << SHIFT[i++ & 3];\n        }\n      } else {\n        for (i = this.start; index < length && i < 64; ++index) {\n          code = message.charCodeAt(index);\n\n          if (code < 0x80) {\n            blocks[i >> 2] |= code << SHIFT[i++ & 3];\n          } else if (code < 0x800) {\n            blocks[i >> 2] |= (0xc0 | code >> 6) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code & 0x3f) << SHIFT[i++ & 3];\n          } else if (code < 0xd800 || code >= 0xe000) {\n            blocks[i >> 2] |= (0xe0 | code >> 12) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code >> 6 & 0x3f) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code & 0x3f) << SHIFT[i++ & 3];\n          } else {\n            code = 0x10000 + ((code & 0x3ff) << 10 | message.charCodeAt(++index) & 0x3ff);\n            blocks[i >> 2] |= (0xf0 | code >> 18) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code >> 12 & 0x3f) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code >> 6 & 0x3f) << SHIFT[i++ & 3];\n            blocks[i >> 2] |= (0x80 | code & 0x3f) << SHIFT[i++ & 3];\n          }\n        }\n      }\n\n      this.lastByteIndex = i;\n      this.bytes += i - this.start;\n\n      if (i >= 64) {\n        this.block = blocks[16];\n        this.start = i - 64;\n        this.hash();\n        this.hashed = true;\n      } else {\n        this.start = i;\n      }\n    }\n\n    if (this.bytes > 4294967295) {\n      this.hBytes += this.bytes / 4294967296 << 0;\n      this.bytes = this.bytes % 4294967296;\n    }\n\n    return this;\n  };\n\n  Sha256.prototype.finalize = function () {\n    if (this.finalized) {\n      return;\n    }\n\n    this.finalized = true;\n    var blocks = this.blocks,\n        i = this.lastByteIndex;\n    blocks[16] = this.block;\n    blocks[i >> 2] |= EXTRA[i & 3];\n    this.block = blocks[16];\n\n    if (i >= 56) {\n      if (!this.hashed) {\n        this.hash();\n      }\n\n      blocks[0] = this.block;\n      blocks[16] = blocks[1] = blocks[2] = blocks[3] = blocks[4] = blocks[5] = blocks[6] = blocks[7] = blocks[8] = blocks[9] = blocks[10] = blocks[11] = blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\n    }\n\n    blocks[14] = this.hBytes << 3 | this.bytes >>> 29;\n    blocks[15] = this.bytes << 3;\n    this.hash();\n  };\n\n  Sha256.prototype.hash = function () {\n    var a = this.h0,\n        b = this.h1,\n        c = this.h2,\n        d = this.h3,\n        e = this.h4,\n        f = this.h5,\n        g = this.h6,\n        h = this.h7,\n        blocks = this.blocks,\n        j,\n        s0,\n        s1,\n        maj,\n        t1,\n        t2,\n        ch,\n        ab,\n        da,\n        cd,\n        bc;\n\n    for (j = 16; j < 64; ++j) {\n      // rightrotate\n      t1 = blocks[j - 15];\n      s0 = (t1 >>> 7 | t1 << 25) ^ (t1 >>> 18 | t1 << 14) ^ t1 >>> 3;\n      t1 = blocks[j - 2];\n      s1 = (t1 >>> 17 | t1 << 15) ^ (t1 >>> 19 | t1 << 13) ^ t1 >>> 10;\n      blocks[j] = blocks[j - 16] + s0 + blocks[j - 7] + s1 << 0;\n    }\n\n    bc = b & c;\n\n    for (j = 0; j < 64; j += 4) {\n      if (this.first) {\n        if (this.is224) {\n          ab = 300032;\n          t1 = blocks[0] - 1413257819;\n          h = t1 - 150054599 << 0;\n          d = t1 + 24177077 << 0;\n        } else {\n          ab = 704751109;\n          t1 = blocks[0] - 210244248;\n          h = t1 - 1521486534 << 0;\n          d = t1 + 143694565 << 0;\n        }\n\n        this.first = false;\n      } else {\n        s0 = (a >>> 2 | a << 30) ^ (a >>> 13 | a << 19) ^ (a >>> 22 | a << 10);\n        s1 = (e >>> 6 | e << 26) ^ (e >>> 11 | e << 21) ^ (e >>> 25 | e << 7);\n        ab = a & b;\n        maj = ab ^ a & c ^ bc;\n        ch = e & f ^ ~e & g;\n        t1 = h + s1 + ch + K[j] + blocks[j];\n        t2 = s0 + maj;\n        h = d + t1 << 0;\n        d = t1 + t2 << 0;\n      }\n\n      s0 = (d >>> 2 | d << 30) ^ (d >>> 13 | d << 19) ^ (d >>> 22 | d << 10);\n      s1 = (h >>> 6 | h << 26) ^ (h >>> 11 | h << 21) ^ (h >>> 25 | h << 7);\n      da = d & a;\n      maj = da ^ d & b ^ ab;\n      ch = h & e ^ ~h & f;\n      t1 = g + s1 + ch + K[j + 1] + blocks[j + 1];\n      t2 = s0 + maj;\n      g = c + t1 << 0;\n      c = t1 + t2 << 0;\n      s0 = (c >>> 2 | c << 30) ^ (c >>> 13 | c << 19) ^ (c >>> 22 | c << 10);\n      s1 = (g >>> 6 | g << 26) ^ (g >>> 11 | g << 21) ^ (g >>> 25 | g << 7);\n      cd = c & d;\n      maj = cd ^ c & a ^ da;\n      ch = g & h ^ ~g & e;\n      t1 = f + s1 + ch + K[j + 2] + blocks[j + 2];\n      t2 = s0 + maj;\n      f = b + t1 << 0;\n      b = t1 + t2 << 0;\n      s0 = (b >>> 2 | b << 30) ^ (b >>> 13 | b << 19) ^ (b >>> 22 | b << 10);\n      s1 = (f >>> 6 | f << 26) ^ (f >>> 11 | f << 21) ^ (f >>> 25 | f << 7);\n      bc = b & c;\n      maj = bc ^ b & d ^ cd;\n      ch = f & g ^ ~f & h;\n      t1 = e + s1 + ch + K[j + 3] + blocks[j + 3];\n      t2 = s0 + maj;\n      e = a + t1 << 0;\n      a = t1 + t2 << 0;\n    }\n\n    this.h0 = this.h0 + a << 0;\n    this.h1 = this.h1 + b << 0;\n    this.h2 = this.h2 + c << 0;\n    this.h3 = this.h3 + d << 0;\n    this.h4 = this.h4 + e << 0;\n    this.h5 = this.h5 + f << 0;\n    this.h6 = this.h6 + g << 0;\n    this.h7 = this.h7 + h << 0;\n  };\n\n  Sha256.prototype.hex = function () {\n    this.finalize();\n    var h0 = this.h0,\n        h1 = this.h1,\n        h2 = this.h2,\n        h3 = this.h3,\n        h4 = this.h4,\n        h5 = this.h5,\n        h6 = this.h6,\n        h7 = this.h7;\n    var hex = HEX_CHARS[h0 >> 28 & 0x0F] + HEX_CHARS[h0 >> 24 & 0x0F] + HEX_CHARS[h0 >> 20 & 0x0F] + HEX_CHARS[h0 >> 16 & 0x0F] + HEX_CHARS[h0 >> 12 & 0x0F] + HEX_CHARS[h0 >> 8 & 0x0F] + HEX_CHARS[h0 >> 4 & 0x0F] + HEX_CHARS[h0 & 0x0F] + HEX_CHARS[h1 >> 28 & 0x0F] + HEX_CHARS[h1 >> 24 & 0x0F] + HEX_CHARS[h1 >> 20 & 0x0F] + HEX_CHARS[h1 >> 16 & 0x0F] + HEX_CHARS[h1 >> 12 & 0x0F] + HEX_CHARS[h1 >> 8 & 0x0F] + HEX_CHARS[h1 >> 4 & 0x0F] + HEX_CHARS[h1 & 0x0F] + HEX_CHARS[h2 >> 28 & 0x0F] + HEX_CHARS[h2 >> 24 & 0x0F] + HEX_CHARS[h2 >> 20 & 0x0F] + HEX_CHARS[h2 >> 16 & 0x0F] + HEX_CHARS[h2 >> 12 & 0x0F] + HEX_CHARS[h2 >> 8 & 0x0F] + HEX_CHARS[h2 >> 4 & 0x0F] + HEX_CHARS[h2 & 0x0F] + HEX_CHARS[h3 >> 28 & 0x0F] + HEX_CHARS[h3 >> 24 & 0x0F] + HEX_CHARS[h3 >> 20 & 0x0F] + HEX_CHARS[h3 >> 16 & 0x0F] + HEX_CHARS[h3 >> 12 & 0x0F] + HEX_CHARS[h3 >> 8 & 0x0F] + HEX_CHARS[h3 >> 4 & 0x0F] + HEX_CHARS[h3 & 0x0F] + HEX_CHARS[h4 >> 28 & 0x0F] + HEX_CHARS[h4 >> 24 & 0x0F] + HEX_CHARS[h4 >> 20 & 0x0F] + HEX_CHARS[h4 >> 16 & 0x0F] + HEX_CHARS[h4 >> 12 & 0x0F] + HEX_CHARS[h4 >> 8 & 0x0F] + HEX_CHARS[h4 >> 4 & 0x0F] + HEX_CHARS[h4 & 0x0F] + HEX_CHARS[h5 >> 28 & 0x0F] + HEX_CHARS[h5 >> 24 & 0x0F] + HEX_CHARS[h5 >> 20 & 0x0F] + HEX_CHARS[h5 >> 16 & 0x0F] + HEX_CHARS[h5 >> 12 & 0x0F] + HEX_CHARS[h5 >> 8 & 0x0F] + HEX_CHARS[h5 >> 4 & 0x0F] + HEX_CHARS[h5 & 0x0F] + HEX_CHARS[h6 >> 28 & 0x0F] + HEX_CHARS[h6 >> 24 & 0x0F] + HEX_CHARS[h6 >> 20 & 0x0F] + HEX_CHARS[h6 >> 16 & 0x0F] + HEX_CHARS[h6 >> 12 & 0x0F] + HEX_CHARS[h6 >> 8 & 0x0F] + HEX_CHARS[h6 >> 4 & 0x0F] + HEX_CHARS[h6 & 0x0F];\n\n    if (!this.is224) {\n      hex += HEX_CHARS[h7 >> 28 & 0x0F] + HEX_CHARS[h7 >> 24 & 0x0F] + HEX_CHARS[h7 >> 20 & 0x0F] + HEX_CHARS[h7 >> 16 & 0x0F] + HEX_CHARS[h7 >> 12 & 0x0F] + HEX_CHARS[h7 >> 8 & 0x0F] + HEX_CHARS[h7 >> 4 & 0x0F] + HEX_CHARS[h7 & 0x0F];\n    }\n\n    return hex;\n  };\n\n  Sha256.prototype.toString = Sha256.prototype.hex;\n\n  Sha256.prototype.digest = function () {\n    this.finalize();\n    var h0 = this.h0,\n        h1 = this.h1,\n        h2 = this.h2,\n        h3 = this.h3,\n        h4 = this.h4,\n        h5 = this.h5,\n        h6 = this.h6,\n        h7 = this.h7;\n    var arr = [h0 >> 24 & 0xFF, h0 >> 16 & 0xFF, h0 >> 8 & 0xFF, h0 & 0xFF, h1 >> 24 & 0xFF, h1 >> 16 & 0xFF, h1 >> 8 & 0xFF, h1 & 0xFF, h2 >> 24 & 0xFF, h2 >> 16 & 0xFF, h2 >> 8 & 0xFF, h2 & 0xFF, h3 >> 24 & 0xFF, h3 >> 16 & 0xFF, h3 >> 8 & 0xFF, h3 & 0xFF, h4 >> 24 & 0xFF, h4 >> 16 & 0xFF, h4 >> 8 & 0xFF, h4 & 0xFF, h5 >> 24 & 0xFF, h5 >> 16 & 0xFF, h5 >> 8 & 0xFF, h5 & 0xFF, h6 >> 24 & 0xFF, h6 >> 16 & 0xFF, h6 >> 8 & 0xFF, h6 & 0xFF];\n\n    if (!this.is224) {\n      arr.push(h7 >> 24 & 0xFF, h7 >> 16 & 0xFF, h7 >> 8 & 0xFF, h7 & 0xFF);\n    }\n\n    return arr;\n  };\n\n  Sha256.prototype.array = Sha256.prototype.digest;\n\n  Sha256.prototype.arrayBuffer = function () {\n    this.finalize();\n    var buffer = new ArrayBuffer(this.is224 ? 28 : 32);\n    var dataView = new DataView(buffer);\n    dataView.setUint32(0, this.h0);\n    dataView.setUint32(4, this.h1);\n    dataView.setUint32(8, this.h2);\n    dataView.setUint32(12, this.h3);\n    dataView.setUint32(16, this.h4);\n    dataView.setUint32(20, this.h5);\n    dataView.setUint32(24, this.h6);\n\n    if (!this.is224) {\n      dataView.setUint32(28, this.h7);\n    }\n\n    return buffer;\n  };\n\n  function HmacSha256(key, is224, sharedMemory) {\n    var i,\n        type = typeof key;\n\n    if (type === 'string') {\n      var bytes = [],\n          length = key.length,\n          index = 0,\n          code;\n\n      for (i = 0; i < length; ++i) {\n        code = key.charCodeAt(i);\n\n        if (code < 0x80) {\n          bytes[index++] = code;\n        } else if (code < 0x800) {\n          bytes[index++] = 0xc0 | code >> 6;\n          bytes[index++] = 0x80 | code & 0x3f;\n        } else if (code < 0xd800 || code >= 0xe000) {\n          bytes[index++] = 0xe0 | code >> 12;\n          bytes[index++] = 0x80 | code >> 6 & 0x3f;\n          bytes[index++] = 0x80 | code & 0x3f;\n        } else {\n          code = 0x10000 + ((code & 0x3ff) << 10 | key.charCodeAt(++i) & 0x3ff);\n          bytes[index++] = 0xf0 | code >> 18;\n          bytes[index++] = 0x80 | code >> 12 & 0x3f;\n          bytes[index++] = 0x80 | code >> 6 & 0x3f;\n          bytes[index++] = 0x80 | code & 0x3f;\n        }\n      }\n\n      key = bytes;\n    } else {\n      if (type === 'object') {\n        if (key === null) {\n          throw new Error(ERROR);\n        } else if (ARRAY_BUFFER && key.constructor === ArrayBuffer) {\n          key = new Uint8Array(key);\n        } else if (!Array.isArray(key)) {\n          if (!ARRAY_BUFFER || !ArrayBuffer.isView(key)) {\n            throw new Error(ERROR);\n          }\n        }\n      } else {\n        throw new Error(ERROR);\n      }\n    }\n\n    if (key.length > 64) {\n      key = new Sha256(is224, true).update(key).array();\n    }\n\n    var oKeyPad = [],\n        iKeyPad = [];\n\n    for (i = 0; i < 64; ++i) {\n      var b = key[i] || 0;\n      oKeyPad[i] = 0x5c ^ b;\n      iKeyPad[i] = 0x36 ^ b;\n    }\n\n    Sha256.call(this, is224, sharedMemory);\n    this.update(iKeyPad);\n    this.oKeyPad = oKeyPad;\n    this.inner = true;\n    this.sharedMemory = sharedMemory;\n  }\n\n  HmacSha256.prototype = new Sha256();\n\n  HmacSha256.prototype.finalize = function () {\n    Sha256.prototype.finalize.call(this);\n\n    if (this.inner) {\n      this.inner = false;\n      var innerHash = this.array();\n      Sha256.call(this, this.is224, this.sharedMemory);\n      this.update(this.oKeyPad);\n      this.update(innerHash);\n      Sha256.prototype.finalize.call(this);\n    }\n  };\n\n  var exports = createMethod();\n  exports.sha256 = exports;\n  exports.sha224 = createMethod(true);\n  exports.sha256.hmac = createHmacMethod();\n  exports.sha224.hmac = createHmacMethod(true);\n  return exports;\n}\n\nconst sha256 = factory();\n/**\r\n * Abstraction for crypto algorithms\r\n */\n\nclass HashHandler {}\n\nfunction decodeUTF8(s) {\n  if (typeof s !== 'string') throw new TypeError('expected string');\n  var i,\n      d = s,\n      b = new Uint8Array(d.length);\n\n  for (i = 0; i < d.length; i++) b[i] = d.charCodeAt(i);\n\n  return b;\n}\n\nfunction encodeUTF8(arr) {\n  var i,\n      s = [];\n\n  for (i = 0; i < arr.length; i++) s.push(String.fromCharCode(arr[i]));\n\n  return s.join('');\n}\n\nclass DefaultHashHandler {\n  calcHash(valueToHash, algorithm) {\n    return __awaiter(this, void 0, void 0, function* () {\n      // const encoder = new TextEncoder();\n      // const hashArray = await window.crypto.subtle.digest(algorithm, data);\n      // const data = encoder.encode(valueToHash);\n      // const fhash = fsha256(valueToHash);\n      const candHash = encodeUTF8(fsha256(decodeUTF8(valueToHash))); // const hashArray = (sha256 as any).array(valueToHash);\n      // // const hashString = this.toHashString(hashArray);\n      // const hashString = this.toHashString2(hashArray);\n      // console.debug('hash orig - cand', candHash, hashString);\n      // alert(1);\n\n      return candHash;\n    });\n  }\n\n  toHashString2(byteArray) {\n    let result = '';\n\n    for (let e of byteArray) {\n      result += String.fromCharCode(e);\n    }\n\n    return result;\n  }\n\n  toHashString(buffer) {\n    const byteArray = new Uint8Array(buffer);\n    let result = '';\n\n    for (let e of byteArray) {\n      result += String.fromCharCode(e);\n    }\n\n    return result;\n  }\n\n}\n\nDefaultHashHandler.ɵfac = function DefaultHashHandler_Factory(t) {\n  return new (t || DefaultHashHandler)();\n};\n\nDefaultHashHandler.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: DefaultHashHandler,\n  factory: DefaultHashHandler.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(DefaultHashHandler, [{\n    type: Injectable\n  }], null, null);\n})();\n/**\r\n * Service for logging in and logging out with\r\n * OIDC and OAuth2. Supports implicit flow and\r\n * password flow.\r\n */\n\n\nclass OAuthService extends AuthConfig {\n  constructor(ngZone, http, storage, tokenValidationHandler, config, urlHelper, logger, crypto, document, dateTimeService) {\n    var _a;\n\n    super();\n    this.ngZone = ngZone;\n    this.http = http;\n    this.config = config;\n    this.urlHelper = urlHelper;\n    this.logger = logger;\n    this.crypto = crypto;\n    this.dateTimeService = dateTimeService;\n    /**\r\n     * @internal\r\n     * Deprecated:  use property events instead\r\n     */\n\n    this.discoveryDocumentLoaded = false;\n    /**\r\n     * The received (passed around) state, when logging\r\n     * in with implicit flow.\r\n     */\n\n    this.state = '';\n    this.eventsSubject = new Subject();\n    this.discoveryDocumentLoadedSubject = new Subject();\n    this.grantTypesSupported = [];\n    this.inImplicitFlow = false;\n    this.saveNoncesInLocalStorage = false;\n    this.debug('angular-oauth2-oidc v10'); // See https://github.com/manfredsteyer/angular-oauth2-oidc/issues/773 for why this is needed\n\n    this.document = document;\n\n    if (!config) {\n      config = {};\n    }\n\n    this.discoveryDocumentLoaded$ = this.discoveryDocumentLoadedSubject.asObservable();\n    this.events = this.eventsSubject.asObservable();\n\n    if (tokenValidationHandler) {\n      this.tokenValidationHandler = tokenValidationHandler;\n    }\n\n    if (config) {\n      this.configure(config);\n    }\n\n    try {\n      if (storage) {\n        this.setStorage(storage);\n      } else if (typeof sessionStorage !== 'undefined') {\n        this.setStorage(sessionStorage);\n      }\n    } catch (e) {\n      console.error('No OAuthStorage provided and cannot access default (sessionStorage).' + 'Consider providing a custom OAuthStorage implementation in your module.', e);\n    } // in IE, sessionStorage does not always survive a redirect\n\n\n    if (this.checkLocalStorageAccessable()) {\n      const ua = (_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent;\n      const msie = (ua === null || ua === void 0 ? void 0 : ua.includes('MSIE ')) || (ua === null || ua === void 0 ? void 0 : ua.includes('Trident'));\n\n      if (msie) {\n        this.saveNoncesInLocalStorage = true;\n      }\n    }\n\n    this.setupRefreshTimer();\n  }\n\n  checkLocalStorageAccessable() {\n    if (typeof window === 'undefined') return false;\n    const test = 'test';\n\n    try {\n      if (typeof window['localStorage'] === 'undefined') return false;\n      localStorage.setItem(test, test);\n      localStorage.removeItem(test);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n  /**\r\n   * Use this method to configure the service\r\n   * @param config the configuration\r\n   */\n\n\n  configure(config) {\n    // For the sake of downward compatibility with\n    // original configuration API\n    Object.assign(this, new AuthConfig(), config);\n    this.config = Object.assign({}, new AuthConfig(), config);\n\n    if (this.sessionChecksEnabled) {\n      this.setupSessionCheck();\n    }\n\n    this.configChanged();\n  }\n\n  configChanged() {\n    this.setupRefreshTimer();\n  }\n\n  restartSessionChecksIfStillLoggedIn() {\n    if (this.hasValidIdToken()) {\n      this.initSessionCheck();\n    }\n  }\n\n  restartRefreshTimerIfStillLoggedIn() {\n    this.setupExpirationTimers();\n  }\n\n  setupSessionCheck() {\n    this.events.pipe(filter(e => e.type === 'token_received')).subscribe(e => {\n      this.initSessionCheck();\n    });\n  }\n  /**\r\n   * Will setup up silent refreshing for when the token is\r\n   * about to expire. When the user is logged out via this.logOut method, the\r\n   * silent refreshing will pause and not refresh the tokens until the user is\r\n   * logged back in via receiving a new token.\r\n   * @param params Additional parameter to pass\r\n   * @param listenTo Setup automatic refresh of a specific token type\r\n   */\n\n\n  setupAutomaticSilentRefresh(params = {}, listenTo, noPrompt = true) {\n    let shouldRunSilentRefresh = true;\n    this.clearAutomaticRefreshTimer();\n    this.automaticRefreshSubscription = this.events.pipe(tap(e => {\n      if (e.type === 'token_received') {\n        shouldRunSilentRefresh = true;\n      } else if (e.type === 'logout') {\n        shouldRunSilentRefresh = false;\n      }\n    }), filter(e => e.type === 'token_expires' && (listenTo == null || listenTo === 'any' || e.info === listenTo)), debounceTime(1000)).subscribe(_ => {\n      if (shouldRunSilentRefresh) {\n        // this.silentRefresh(params, noPrompt).catch(_ => {\n        this.refreshInternal(params, noPrompt).catch(_ => {\n          this.debug('Automatic silent refresh did not work');\n        });\n      }\n    });\n    this.restartRefreshTimerIfStillLoggedIn();\n  }\n\n  refreshInternal(params, noPrompt) {\n    if (!this.useSilentRefresh && this.responseType === 'code') {\n      return this.refreshToken();\n    } else {\n      return this.silentRefresh(params, noPrompt);\n    }\n  }\n  /**\r\n   * Convenience method that first calls `loadDiscoveryDocument(...)` and\r\n   * directly chains using the `then(...)` part of the promise to call\r\n   * the `tryLogin(...)` method.\r\n   *\r\n   * @param options LoginOptions to pass through to `tryLogin(...)`\r\n   */\n\n\n  loadDiscoveryDocumentAndTryLogin(options = null) {\n    return this.loadDiscoveryDocument().then(doc => {\n      return this.tryLogin(options);\n    });\n  }\n  /**\r\n   * Convenience method that first calls `loadDiscoveryDocumentAndTryLogin(...)`\r\n   * and if then chains to `initLoginFlow()`, but only if there is no valid\r\n   * IdToken or no valid AccessToken.\r\n   *\r\n   * @param options LoginOptions to pass through to `tryLogin(...)`\r\n   */\n\n\n  loadDiscoveryDocumentAndLogin(options = null) {\n    options = options || {};\n    return this.loadDiscoveryDocumentAndTryLogin(options).then(_ => {\n      if (!this.hasValidIdToken() || !this.hasValidAccessToken()) {\n        const state = typeof options.state === 'string' ? options.state : '';\n        this.initLoginFlow(state);\n        return false;\n      } else {\n        return true;\n      }\n    });\n  }\n\n  debug(...args) {\n    if (this.showDebugInformation) {\n      this.logger.debug.apply(this.logger, args);\n    }\n  }\n\n  validateUrlFromDiscoveryDocument(url) {\n    const errors = [];\n    const httpsCheck = this.validateUrlForHttps(url);\n    const issuerCheck = this.validateUrlAgainstIssuer(url);\n\n    if (!httpsCheck) {\n      errors.push('https for all urls required. Also for urls received by discovery.');\n    }\n\n    if (!issuerCheck) {\n      errors.push('Every url in discovery document has to start with the issuer url.' + 'Also see property strictDiscoveryDocumentValidation.');\n    }\n\n    return errors;\n  }\n\n  validateUrlForHttps(url) {\n    if (!url) {\n      return true;\n    }\n\n    const lcUrl = url.toLowerCase();\n\n    if (this.requireHttps === false) {\n      return true;\n    }\n\n    if ((lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/) || lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/)) && this.requireHttps === 'remoteOnly') {\n      return true;\n    }\n\n    return lcUrl.startsWith('https://');\n  }\n\n  assertUrlNotNullAndCorrectProtocol(url, description) {\n    if (!url) {\n      throw new Error(`'${description}' should not be null`);\n    }\n\n    if (!this.validateUrlForHttps(url)) {\n      throw new Error(`'${description}' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).`);\n    }\n  }\n\n  validateUrlAgainstIssuer(url) {\n    if (!this.strictDiscoveryDocumentValidation) {\n      return true;\n    }\n\n    if (!url) {\n      return true;\n    }\n\n    return url.toLowerCase().startsWith(this.issuer.toLowerCase());\n  }\n\n  setupRefreshTimer() {\n    if (typeof window === 'undefined') {\n      this.debug('timer not supported on this plattform');\n      return;\n    }\n\n    if (this.hasValidIdToken() || this.hasValidAccessToken()) {\n      this.clearAccessTokenTimer();\n      this.clearIdTokenTimer();\n      this.setupExpirationTimers();\n    }\n\n    if (this.tokenReceivedSubscription) this.tokenReceivedSubscription.unsubscribe();\n    this.tokenReceivedSubscription = this.events.pipe(filter(e => e.type === 'token_received')).subscribe(_ => {\n      this.clearAccessTokenTimer();\n      this.clearIdTokenTimer();\n      this.setupExpirationTimers();\n    });\n  }\n\n  setupExpirationTimers() {\n    if (this.hasValidAccessToken()) {\n      this.setupAccessTokenTimer();\n    }\n\n    if (this.hasValidIdToken()) {\n      this.setupIdTokenTimer();\n    }\n  }\n\n  setupAccessTokenTimer() {\n    const expiration = this.getAccessTokenExpiration();\n    const storedAt = this.getAccessTokenStoredAt();\n    const timeout = this.calcTimeout(storedAt, expiration);\n    this.ngZone.runOutsideAngular(() => {\n      this.accessTokenTimeoutSubscription = of(new OAuthInfoEvent('token_expires', 'access_token')).pipe(delay(timeout)).subscribe(e => {\n        this.ngZone.run(() => {\n          this.eventsSubject.next(e);\n        });\n      });\n    });\n  }\n\n  setupIdTokenTimer() {\n    const expiration = this.getIdTokenExpiration();\n    const storedAt = this.getIdTokenStoredAt();\n    const timeout = this.calcTimeout(storedAt, expiration);\n    this.ngZone.runOutsideAngular(() => {\n      this.idTokenTimeoutSubscription = of(new OAuthInfoEvent('token_expires', 'id_token')).pipe(delay(timeout)).subscribe(e => {\n        this.ngZone.run(() => {\n          this.eventsSubject.next(e);\n        });\n      });\n    });\n  }\n  /**\r\n   * Stops timers for automatic refresh.\r\n   * To restart it, call setupAutomaticSilentRefresh again.\r\n   */\n\n\n  stopAutomaticRefresh() {\n    this.clearAccessTokenTimer();\n    this.clearIdTokenTimer();\n    this.clearAutomaticRefreshTimer();\n  }\n\n  clearAccessTokenTimer() {\n    if (this.accessTokenTimeoutSubscription) {\n      this.accessTokenTimeoutSubscription.unsubscribe();\n    }\n  }\n\n  clearIdTokenTimer() {\n    if (this.idTokenTimeoutSubscription) {\n      this.idTokenTimeoutSubscription.unsubscribe();\n    }\n  }\n\n  clearAutomaticRefreshTimer() {\n    if (this.automaticRefreshSubscription) {\n      this.automaticRefreshSubscription.unsubscribe();\n    }\n  }\n\n  calcTimeout(storedAt, expiration) {\n    const now = this.dateTimeService.now();\n    const delta = (expiration - storedAt) * this.timeoutFactor - (now - storedAt);\n    return Math.max(0, delta);\n  }\n  /**\r\n   * DEPRECATED. Use a provider for OAuthStorage instead:\r\n   *\r\n   * { provide: OAuthStorage, useFactory: oAuthStorageFactory }\r\n   * export function oAuthStorageFactory(): OAuthStorage { return localStorage; }\r\n   * Sets a custom storage used to store the received\r\n   * tokens on client side. By default, the browser's\r\n   * sessionStorage is used.\r\n   * @ignore\r\n   *\r\n   * @param storage\r\n   */\n\n\n  setStorage(storage) {\n    this._storage = storage;\n    this.configChanged();\n  }\n  /**\r\n   * Loads the discovery document to configure most\r\n   * properties of this service. The url of the discovery\r\n   * document is infered from the issuer's url according\r\n   * to the OpenId Connect spec. To use another url you\r\n   * can pass it to to optional parameter fullUrl.\r\n   *\r\n   * @param fullUrl\r\n   */\n\n\n  loadDiscoveryDocument(fullUrl = null) {\n    return new Promise((resolve, reject) => {\n      if (!fullUrl) {\n        fullUrl = this.issuer || '';\n\n        if (!fullUrl.endsWith('/')) {\n          fullUrl += '/';\n        }\n\n        fullUrl += '.well-known/openid-configuration';\n      }\n\n      if (!this.validateUrlForHttps(fullUrl)) {\n        reject(\"issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n        return;\n      }\n\n      this.http.get(fullUrl).subscribe(doc => {\n        if (!this.validateDiscoveryDocument(doc)) {\n          this.eventsSubject.next(new OAuthErrorEvent('discovery_document_validation_error', null));\n          reject('discovery_document_validation_error');\n          return;\n        }\n\n        this.loginUrl = doc.authorization_endpoint;\n        this.logoutUrl = doc.end_session_endpoint || this.logoutUrl;\n        this.grantTypesSupported = doc.grant_types_supported;\n        this.issuer = doc.issuer;\n        this.tokenEndpoint = doc.token_endpoint;\n        this.userinfoEndpoint = doc.userinfo_endpoint || this.userinfoEndpoint;\n        this.jwksUri = doc.jwks_uri;\n        this.sessionCheckIFrameUrl = doc.check_session_iframe || this.sessionCheckIFrameUrl;\n        this.discoveryDocumentLoaded = true;\n        this.discoveryDocumentLoadedSubject.next(doc);\n        this.revocationEndpoint = doc.revocation_endpoint || this.revocationEndpoint;\n\n        if (this.sessionChecksEnabled) {\n          this.restartSessionChecksIfStillLoggedIn();\n        }\n\n        this.loadJwks().then(jwks => {\n          const result = {\n            discoveryDocument: doc,\n            jwks: jwks\n          };\n          const event = new OAuthSuccessEvent('discovery_document_loaded', result);\n          this.eventsSubject.next(event);\n          resolve(event);\n          return;\n        }).catch(err => {\n          this.eventsSubject.next(new OAuthErrorEvent('discovery_document_load_error', err));\n          reject(err);\n          return;\n        });\n      }, err => {\n        this.logger.error('error loading discovery document', err);\n        this.eventsSubject.next(new OAuthErrorEvent('discovery_document_load_error', err));\n        reject(err);\n      });\n    });\n  }\n\n  loadJwks() {\n    return new Promise((resolve, reject) => {\n      if (this.jwksUri) {\n        this.http.get(this.jwksUri).subscribe(jwks => {\n          this.jwks = jwks;\n          this.eventsSubject.next(new OAuthSuccessEvent('discovery_document_loaded'));\n          resolve(jwks);\n        }, err => {\n          this.logger.error('error loading jwks', err);\n          this.eventsSubject.next(new OAuthErrorEvent('jwks_load_error', err));\n          reject(err);\n        });\n      } else {\n        resolve(null);\n      }\n    });\n  }\n\n  validateDiscoveryDocument(doc) {\n    let errors;\n\n    if (!this.skipIssuerCheck && doc.issuer !== this.issuer) {\n      this.logger.error('invalid issuer in discovery document', 'expected: ' + this.issuer, 'current: ' + doc.issuer);\n      return false;\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.authorization_endpoint);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating authorization_endpoint in discovery document', errors);\n      return false;\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.end_session_endpoint);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating end_session_endpoint in discovery document', errors);\n      return false;\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.token_endpoint);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating token_endpoint in discovery document', errors);\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.revocation_endpoint);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating revocation_endpoint in discovery document', errors);\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.userinfo_endpoint);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating userinfo_endpoint in discovery document', errors);\n      return false;\n    }\n\n    errors = this.validateUrlFromDiscoveryDocument(doc.jwks_uri);\n\n    if (errors.length > 0) {\n      this.logger.error('error validating jwks_uri in discovery document', errors);\n      return false;\n    }\n\n    if (this.sessionChecksEnabled && !doc.check_session_iframe) {\n      this.logger.warn('sessionChecksEnabled is activated but discovery document' + ' does not contain a check_session_iframe field');\n    }\n\n    return true;\n  }\n  /**\r\n   * Uses password flow to exchange userName and password for an\r\n   * access_token. After receiving the access_token, this method\r\n   * uses it to query the userinfo endpoint in order to get information\r\n   * about the user in question.\r\n   *\r\n   * When using this, make sure that the property oidc is set to false.\r\n   * Otherwise stricter validations take place that make this operation\r\n   * fail.\r\n   *\r\n   * @param userName\r\n   * @param password\r\n   * @param headers Optional additional http-headers.\r\n   */\n\n\n  fetchTokenUsingPasswordFlowAndLoadUserProfile(userName, password, headers = new HttpHeaders()) {\n    return this.fetchTokenUsingPasswordFlow(userName, password, headers).then(() => this.loadUserProfile());\n  }\n  /**\r\n   * Loads the user profile by accessing the user info endpoint defined by OpenId Connect.\r\n   *\r\n   * When using this with OAuth2 password flow, make sure that the property oidc is set to false.\r\n   * Otherwise stricter validations take place that make this operation fail.\r\n   */\n\n\n  loadUserProfile() {\n    if (!this.hasValidAccessToken()) {\n      throw new Error('Can not load User Profile without access_token');\n    }\n\n    if (!this.validateUrlForHttps(this.userinfoEndpoint)) {\n      throw new Error(\"userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n    }\n\n    return new Promise((resolve, reject) => {\n      const headers = new HttpHeaders().set('Authorization', 'Bearer ' + this.getAccessToken());\n      this.http.get(this.userinfoEndpoint, {\n        headers,\n        observe: 'response',\n        responseType: 'text'\n      }).subscribe(response => {\n        this.debug('userinfo received', JSON.stringify(response));\n\n        if (response.headers.get('content-type').startsWith('application/json')) {\n          let info = JSON.parse(response.body);\n          const existingClaims = this.getIdentityClaims() || {};\n\n          if (!this.skipSubjectCheck) {\n            if (this.oidc && (!existingClaims['sub'] || info.sub !== existingClaims['sub'])) {\n              const err = 'if property oidc is true, the received user-id (sub) has to be the user-id ' + 'of the user that has logged in with oidc.\\n' + 'if you are not using oidc but just oauth2 password flow set oidc to false';\n              reject(err);\n              return;\n            }\n          }\n\n          info = Object.assign({}, existingClaims, info);\n\n          this._storage.setItem('id_token_claims_obj', JSON.stringify(info));\n\n          this.eventsSubject.next(new OAuthSuccessEvent('user_profile_loaded'));\n          resolve({\n            info\n          });\n        } else {\n          this.debug('userinfo is not JSON, treating it as JWE/JWS');\n          this.eventsSubject.next(new OAuthSuccessEvent('user_profile_loaded'));\n          resolve(JSON.parse(response.body));\n        }\n      }, err => {\n        this.logger.error('error loading user info', err);\n        this.eventsSubject.next(new OAuthErrorEvent('user_profile_load_error', err));\n        reject(err);\n      });\n    });\n  }\n  /**\r\n   * Uses password flow to exchange userName and password for an access_token.\r\n   * @param userName\r\n   * @param password\r\n   * @param headers Optional additional http-headers.\r\n   */\n\n\n  fetchTokenUsingPasswordFlow(userName, password, headers = new HttpHeaders()) {\n    const parameters = {\n      username: userName,\n      password: password\n    };\n    return this.fetchTokenUsingGrant('password', parameters, headers);\n  }\n  /**\r\n   * Uses a custom grant type to retrieve tokens.\r\n   * @param grantType Grant type.\r\n   * @param parameters Parameters to pass.\r\n   * @param headers Optional additional HTTP headers.\r\n   */\n\n\n  fetchTokenUsingGrant(grantType, parameters, headers = new HttpHeaders()) {\n    this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\n    /**\r\n     * A `HttpParameterCodec` that uses `encodeURIComponent` and `decodeURIComponent` to\r\n     * serialize and parse URL parameter keys and values.\r\n     *\r\n     * @stable\r\n     */\n\n    let params = new HttpParams({\n      encoder: new WebHttpUrlEncodingCodec()\n    }).set('grant_type', grantType).set('scope', this.scope);\n\n    if (this.useHttpBasicAuth) {\n      const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\n      headers = headers.set('Authorization', 'Basic ' + header);\n    }\n\n    if (!this.useHttpBasicAuth) {\n      params = params.set('client_id', this.clientId);\n    }\n\n    if (!this.useHttpBasicAuth && this.dummyClientSecret) {\n      params = params.set('client_secret', this.dummyClientSecret);\n    }\n\n    if (this.customQueryParams) {\n      for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\n        params = params.set(key, this.customQueryParams[key]);\n      }\n    } // set explicit parameters last, to allow overwriting\n\n\n    for (const key of Object.keys(parameters)) {\n      params = params.set(key, parameters[key]);\n    }\n\n    headers = headers.set('Content-Type', 'application/x-www-form-urlencoded');\n    return new Promise((resolve, reject) => {\n      this.http.post(this.tokenEndpoint, params, {\n        headers\n      }).subscribe(tokenResponse => {\n        this.debug('tokenResponse', tokenResponse);\n        this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in || this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\n\n        if (this.oidc && tokenResponse.id_token) {\n          this.processIdToken(tokenResponse.id_token, tokenResponse.access_token).then(result => {\n            this.storeIdToken(result);\n            resolve(tokenResponse);\n          });\n        }\n\n        this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n        resolve(tokenResponse);\n      }, err => {\n        this.logger.error('Error performing ${grantType} flow', err);\n        this.eventsSubject.next(new OAuthErrorEvent('token_error', err));\n        reject(err);\n      });\n    });\n  }\n  /**\r\n   * Refreshes the token using a refresh_token.\r\n   * This does not work for implicit flow, b/c\r\n   * there is no refresh_token in this flow.\r\n   * A solution for this is provided by the\r\n   * method silentRefresh.\r\n   */\n\n\n  refreshToken() {\n    this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\n    return new Promise((resolve, reject) => {\n      let params = new HttpParams({\n        encoder: new WebHttpUrlEncodingCodec()\n      }).set('grant_type', 'refresh_token').set('scope', this.scope).set('refresh_token', this._storage.getItem('refresh_token'));\n      let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\n\n      if (this.useHttpBasicAuth) {\n        const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\n        headers = headers.set('Authorization', 'Basic ' + header);\n      }\n\n      if (!this.useHttpBasicAuth) {\n        params = params.set('client_id', this.clientId);\n      }\n\n      if (!this.useHttpBasicAuth && this.dummyClientSecret) {\n        params = params.set('client_secret', this.dummyClientSecret);\n      }\n\n      if (this.customQueryParams) {\n        for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\n          params = params.set(key, this.customQueryParams[key]);\n        }\n      }\n\n      this.http.post(this.tokenEndpoint, params, {\n        headers\n      }).pipe(switchMap(tokenResponse => {\n        if (tokenResponse.id_token) {\n          return from(this.processIdToken(tokenResponse.id_token, tokenResponse.access_token, true)).pipe(tap(result => this.storeIdToken(result)), map(_ => tokenResponse));\n        } else {\n          return of(tokenResponse);\n        }\n      })).subscribe(tokenResponse => {\n        this.debug('refresh tokenResponse', tokenResponse);\n        this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in || this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\n        this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n        this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\n        resolve(tokenResponse);\n      }, err => {\n        this.logger.error('Error refreshing token', err);\n        this.eventsSubject.next(new OAuthErrorEvent('token_refresh_error', err));\n        reject(err);\n      });\n    });\n  }\n\n  removeSilentRefreshEventListener() {\n    if (this.silentRefreshPostMessageEventListener) {\n      window.removeEventListener('message', this.silentRefreshPostMessageEventListener);\n      this.silentRefreshPostMessageEventListener = null;\n    }\n  }\n\n  setupSilentRefreshEventListener() {\n    this.removeSilentRefreshEventListener();\n\n    this.silentRefreshPostMessageEventListener = e => {\n      const message = this.processMessageEventMessage(e);\n      this.tryLogin({\n        customHashFragment: message,\n        preventClearHashAfterLogin: true,\n        customRedirectUri: this.silentRefreshRedirectUri || this.redirectUri\n      }).catch(err => this.debug('tryLogin during silent refresh failed', err));\n    };\n\n    window.addEventListener('message', this.silentRefreshPostMessageEventListener);\n  }\n  /**\r\n   * Performs a silent refresh for implicit flow.\r\n   * Use this method to get new tokens when/before\r\n   * the existing tokens expire.\r\n   */\n\n\n  silentRefresh(params = {}, noPrompt = true) {\n    const claims = this.getIdentityClaims() || {};\n\n    if (this.useIdTokenHintForSilentRefresh && this.hasValidIdToken()) {\n      params['id_token_hint'] = this.getIdToken();\n    }\n\n    if (!this.validateUrlForHttps(this.loginUrl)) {\n      throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n    }\n\n    if (typeof this.document === 'undefined') {\n      throw new Error('silent refresh is not supported on this platform');\n    }\n\n    const existingIframe = this.document.getElementById(this.silentRefreshIFrameName);\n\n    if (existingIframe) {\n      this.document.body.removeChild(existingIframe);\n    }\n\n    this.silentRefreshSubject = claims['sub'];\n    const iframe = this.document.createElement('iframe');\n    iframe.id = this.silentRefreshIFrameName;\n    this.setupSilentRefreshEventListener();\n    const redirectUri = this.silentRefreshRedirectUri || this.redirectUri;\n    this.createLoginUrl(null, null, redirectUri, noPrompt, params).then(url => {\n      iframe.setAttribute('src', url);\n\n      if (!this.silentRefreshShowIFrame) {\n        iframe.style['display'] = 'none';\n      }\n\n      this.document.body.appendChild(iframe);\n    });\n    const errors = this.events.pipe(filter(e => e instanceof OAuthErrorEvent), first());\n    const success = this.events.pipe(filter(e => e.type === 'token_received'), first());\n    const timeout = of(new OAuthErrorEvent('silent_refresh_timeout', null)).pipe(delay(this.silentRefreshTimeout));\n    return race([errors, success, timeout]).pipe(map(e => {\n      if (e instanceof OAuthErrorEvent) {\n        if (e.type === 'silent_refresh_timeout') {\n          this.eventsSubject.next(e);\n        } else {\n          e = new OAuthErrorEvent('silent_refresh_error', e);\n          this.eventsSubject.next(e);\n        }\n\n        throw e;\n      } else if (e.type === 'token_received') {\n        e = new OAuthSuccessEvent('silently_refreshed');\n        this.eventsSubject.next(e);\n      }\n\n      return e;\n    })).toPromise();\n  }\n  /**\r\n   * This method exists for backwards compatibility.\r\n   * {@link OAuthService#initLoginFlowInPopup} handles both code\r\n   * and implicit flows.\r\n   */\n\n\n  initImplicitFlowInPopup(options) {\n    return this.initLoginFlowInPopup(options);\n  }\n\n  initLoginFlowInPopup(options) {\n    options = options || {};\n    return this.createLoginUrl(null, null, this.silentRefreshRedirectUri, false, {\n      display: 'popup'\n    }).then(url => {\n      return new Promise((resolve, reject) => {\n        /**\r\n         * Error handling section\r\n         */\n        const checkForPopupClosedInterval = 500;\n        let windowRef = null; // If we got no window reference we open a window\n        // else we are using the window already opened\n\n        if (!options.windowRef) {\n          windowRef = window.open(url, 'ngx-oauth2-oidc-login', this.calculatePopupFeatures(options));\n        } else if (options.windowRef && !options.windowRef.closed) {\n          windowRef = options.windowRef;\n          windowRef.location.href = url;\n        }\n\n        let checkForPopupClosedTimer;\n\n        const tryLogin = hash => {\n          this.tryLogin({\n            customHashFragment: hash,\n            preventClearHashAfterLogin: true,\n            customRedirectUri: this.silentRefreshRedirectUri\n          }).then(() => {\n            cleanup();\n            resolve(true);\n          }, err => {\n            cleanup();\n            reject(err);\n          });\n        };\n\n        const checkForPopupClosed = () => {\n          if (!windowRef || windowRef.closed) {\n            cleanup();\n            reject(new OAuthErrorEvent('popup_closed', {}));\n          }\n        };\n\n        if (!windowRef) {\n          reject(new OAuthErrorEvent('popup_blocked', {}));\n        } else {\n          checkForPopupClosedTimer = window.setInterval(checkForPopupClosed, checkForPopupClosedInterval);\n        }\n\n        const cleanup = () => {\n          window.clearInterval(checkForPopupClosedTimer);\n          window.removeEventListener('storage', storageListener);\n          window.removeEventListener('message', listener);\n\n          if (windowRef !== null) {\n            windowRef.close();\n          }\n\n          windowRef = null;\n        };\n\n        const listener = e => {\n          const message = this.processMessageEventMessage(e);\n\n          if (message && message !== null) {\n            window.removeEventListener('storage', storageListener);\n            tryLogin(message);\n          } else {\n            console.log('false event firing');\n          }\n        };\n\n        const storageListener = event => {\n          if (event.key === 'auth_hash') {\n            window.removeEventListener('message', listener);\n            tryLogin(event.newValue);\n          }\n        };\n\n        window.addEventListener('message', listener);\n        window.addEventListener('storage', storageListener);\n      });\n    });\n  }\n\n  calculatePopupFeatures(options) {\n    // Specify an static height and width and calculate centered position\n    const height = options.height || 470;\n    const width = options.width || 500;\n    const left = window.screenLeft + (window.outerWidth - width) / 2;\n    const top = window.screenTop + (window.outerHeight - height) / 2;\n    return `location=no,toolbar=no,width=${width},height=${height},top=${top},left=${left}`;\n  }\n\n  processMessageEventMessage(e) {\n    let expectedPrefix = '#';\n\n    if (this.silentRefreshMessagePrefix) {\n      expectedPrefix += this.silentRefreshMessagePrefix;\n    }\n\n    if (!e || !e.data || typeof e.data !== 'string') {\n      return;\n    }\n\n    const prefixedMessage = e.data;\n\n    if (!prefixedMessage.startsWith(expectedPrefix)) {\n      return;\n    }\n\n    return '#' + prefixedMessage.substr(expectedPrefix.length);\n  }\n\n  canPerformSessionCheck() {\n    if (!this.sessionChecksEnabled) {\n      return false;\n    }\n\n    if (!this.sessionCheckIFrameUrl) {\n      console.warn('sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl');\n      return false;\n    }\n\n    const sessionState = this.getSessionState();\n\n    if (!sessionState) {\n      console.warn('sessionChecksEnabled is activated but there is no session_state');\n      return false;\n    }\n\n    if (typeof this.document === 'undefined') {\n      return false;\n    }\n\n    return true;\n  }\n\n  setupSessionCheckEventListener() {\n    this.removeSessionCheckEventListener();\n\n    this.sessionCheckEventListener = e => {\n      const origin = e.origin.toLowerCase();\n      const issuer = this.issuer.toLowerCase();\n      this.debug('sessionCheckEventListener');\n\n      if (!issuer.startsWith(origin)) {\n        this.debug('sessionCheckEventListener', 'wrong origin', origin, 'expected', issuer, 'event', e);\n        return;\n      } // only run in Angular zone if it is 'changed' or 'error'\n\n\n      switch (e.data) {\n        case 'unchanged':\n          this.ngZone.run(() => {\n            this.handleSessionUnchanged();\n          });\n          break;\n\n        case 'changed':\n          this.ngZone.run(() => {\n            this.handleSessionChange();\n          });\n          break;\n\n        case 'error':\n          this.ngZone.run(() => {\n            this.handleSessionError();\n          });\n          break;\n      }\n\n      this.debug('got info from session check inframe', e);\n    }; // prevent Angular from refreshing the view on every message (runs in intervals)\n\n\n    this.ngZone.runOutsideAngular(() => {\n      window.addEventListener('message', this.sessionCheckEventListener);\n    });\n  }\n\n  handleSessionUnchanged() {\n    this.debug('session check', 'session unchanged');\n    this.eventsSubject.next(new OAuthInfoEvent('session_unchanged'));\n  }\n\n  handleSessionChange() {\n    this.eventsSubject.next(new OAuthInfoEvent('session_changed'));\n    this.stopSessionCheckTimer();\n\n    if (!this.useSilentRefresh && this.responseType === 'code') {\n      this.refreshToken().then(_ => {\n        this.debug('token refresh after session change worked');\n      }).catch(_ => {\n        this.debug('token refresh did not work after session changed');\n        this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\n        this.logOut(true);\n      });\n    } else if (this.silentRefreshRedirectUri) {\n      this.silentRefresh().catch(_ => this.debug('silent refresh failed after session changed'));\n      this.waitForSilentRefreshAfterSessionChange();\n    } else {\n      this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\n      this.logOut(true);\n    }\n  }\n\n  waitForSilentRefreshAfterSessionChange() {\n    this.events.pipe(filter(e => e.type === 'silently_refreshed' || e.type === 'silent_refresh_timeout' || e.type === 'silent_refresh_error'), first()).subscribe(e => {\n      if (e.type !== 'silently_refreshed') {\n        this.debug('silent refresh did not work after session changed');\n        this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\n        this.logOut(true);\n      }\n    });\n  }\n\n  handleSessionError() {\n    this.stopSessionCheckTimer();\n    this.eventsSubject.next(new OAuthInfoEvent('session_error'));\n  }\n\n  removeSessionCheckEventListener() {\n    if (this.sessionCheckEventListener) {\n      window.removeEventListener('message', this.sessionCheckEventListener);\n      this.sessionCheckEventListener = null;\n    }\n  }\n\n  initSessionCheck() {\n    if (!this.canPerformSessionCheck()) {\n      return;\n    }\n\n    const existingIframe = this.document.getElementById(this.sessionCheckIFrameName);\n\n    if (existingIframe) {\n      this.document.body.removeChild(existingIframe);\n    }\n\n    const iframe = this.document.createElement('iframe');\n    iframe.id = this.sessionCheckIFrameName;\n    this.setupSessionCheckEventListener();\n    const url = this.sessionCheckIFrameUrl;\n    iframe.setAttribute('src', url);\n    iframe.style.display = 'none';\n    this.document.body.appendChild(iframe);\n    this.startSessionCheckTimer();\n  }\n\n  startSessionCheckTimer() {\n    this.stopSessionCheckTimer();\n    this.ngZone.runOutsideAngular(() => {\n      this.sessionCheckTimer = setInterval(this.checkSession.bind(this), this.sessionCheckIntervall);\n    });\n  }\n\n  stopSessionCheckTimer() {\n    if (this.sessionCheckTimer) {\n      clearInterval(this.sessionCheckTimer);\n      this.sessionCheckTimer = null;\n    }\n  }\n\n  checkSession() {\n    const iframe = this.document.getElementById(this.sessionCheckIFrameName);\n\n    if (!iframe) {\n      this.logger.warn('checkSession did not find iframe', this.sessionCheckIFrameName);\n    }\n\n    const sessionState = this.getSessionState();\n\n    if (!sessionState) {\n      this.stopSessionCheckTimer();\n    }\n\n    const message = this.clientId + ' ' + sessionState;\n    iframe.contentWindow.postMessage(message, this.issuer);\n  }\n\n  createLoginUrl(state = '', loginHint = '', customRedirectUri = '', noPrompt = false, params = {}) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const that = this;\n      let redirectUri;\n\n      if (customRedirectUri) {\n        redirectUri = customRedirectUri;\n      } else {\n        redirectUri = this.redirectUri;\n      }\n\n      const nonce = yield this.createAndSaveNonce();\n\n      if (state) {\n        state = nonce + this.config.nonceStateSeparator + encodeURIComponent(state);\n      } else {\n        state = nonce;\n      }\n\n      if (!this.requestAccessToken && !this.oidc) {\n        throw new Error('Either requestAccessToken or oidc or both must be true');\n      }\n\n      if (this.config.responseType) {\n        this.responseType = this.config.responseType;\n      } else {\n        if (this.oidc && this.requestAccessToken) {\n          this.responseType = 'id_token token';\n        } else if (this.oidc && !this.requestAccessToken) {\n          this.responseType = 'id_token';\n        } else {\n          this.responseType = 'token';\n        }\n      }\n\n      const seperationChar = that.loginUrl.indexOf('?') > -1 ? '&' : '?';\n      let scope = that.scope;\n\n      if (this.oidc && !scope.match(/(^|\\s)openid($|\\s)/)) {\n        scope = 'openid ' + scope;\n      }\n\n      let url = that.loginUrl + seperationChar + 'response_type=' + encodeURIComponent(that.responseType) + '&client_id=' + encodeURIComponent(that.clientId) + '&state=' + encodeURIComponent(state) + '&redirect_uri=' + encodeURIComponent(redirectUri) + '&scope=' + encodeURIComponent(scope);\n\n      if (this.responseType.includes('code') && !this.disablePKCE) {\n        const [challenge, verifier] = yield this.createChallangeVerifierPairForPKCE();\n\n        if (this.saveNoncesInLocalStorage && typeof window['localStorage'] !== 'undefined') {\n          localStorage.setItem('PKCE_verifier', verifier);\n        } else {\n          this._storage.setItem('PKCE_verifier', verifier);\n        }\n\n        url += '&code_challenge=' + challenge;\n        url += '&code_challenge_method=S256';\n      }\n\n      if (loginHint) {\n        url += '&login_hint=' + encodeURIComponent(loginHint);\n      }\n\n      if (that.resource) {\n        url += '&resource=' + encodeURIComponent(that.resource);\n      }\n\n      if (that.oidc) {\n        url += '&nonce=' + encodeURIComponent(nonce);\n      }\n\n      if (noPrompt) {\n        url += '&prompt=none';\n      }\n\n      for (const key of Object.keys(params)) {\n        url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);\n      }\n\n      if (this.customQueryParams) {\n        for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\n          url += '&' + key + '=' + encodeURIComponent(this.customQueryParams[key]);\n        }\n      }\n\n      return url;\n    });\n  }\n\n  initImplicitFlowInternal(additionalState = '', params = '') {\n    if (this.inImplicitFlow) {\n      return;\n    }\n\n    this.inImplicitFlow = true;\n\n    if (!this.validateUrlForHttps(this.loginUrl)) {\n      throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n    }\n\n    let addParams = {};\n    let loginHint = null;\n\n    if (typeof params === 'string') {\n      loginHint = params;\n    } else if (typeof params === 'object') {\n      addParams = params;\n    }\n\n    this.createLoginUrl(additionalState, loginHint, null, false, addParams).then(this.config.openUri).catch(error => {\n      console.error('Error in initImplicitFlow', error);\n      this.inImplicitFlow = false;\n    });\n  }\n  /**\r\n   * Starts the implicit flow and redirects to user to\r\n   * the auth servers' login url.\r\n   *\r\n   * @param additionalState Optional state that is passed around.\r\n   *  You'll find this state in the property `state` after `tryLogin` logged in the user.\r\n   * @param params Hash with additional parameter. If it is a string, it is used for the\r\n   *               parameter loginHint (for the sake of compatibility with former versions)\r\n   */\n\n\n  initImplicitFlow(additionalState = '', params = '') {\n    if (this.loginUrl !== '') {\n      this.initImplicitFlowInternal(additionalState, params);\n    } else {\n      this.events.pipe(filter(e => e.type === 'discovery_document_loaded')).subscribe(_ => this.initImplicitFlowInternal(additionalState, params));\n    }\n  }\n  /**\r\n   * Reset current implicit flow\r\n   *\r\n   * @description This method allows resetting the current implict flow in order to be initialized again.\r\n   */\n\n\n  resetImplicitFlow() {\n    this.inImplicitFlow = false;\n  }\n\n  callOnTokenReceivedIfExists(options) {\n    const that = this;\n\n    if (options.onTokenReceived) {\n      const tokenParams = {\n        idClaims: that.getIdentityClaims(),\n        idToken: that.getIdToken(),\n        accessToken: that.getAccessToken(),\n        state: that.state\n      };\n      options.onTokenReceived(tokenParams);\n    }\n  }\n\n  storeAccessTokenResponse(accessToken, refreshToken, expiresIn, grantedScopes, customParameters) {\n    this._storage.setItem('access_token', accessToken);\n\n    if (grantedScopes && !Array.isArray(grantedScopes)) {\n      this._storage.setItem('granted_scopes', JSON.stringify(grantedScopes.split(' ')));\n    } else if (grantedScopes && Array.isArray(grantedScopes)) {\n      this._storage.setItem('granted_scopes', JSON.stringify(grantedScopes));\n    }\n\n    this._storage.setItem('access_token_stored_at', '' + this.dateTimeService.now());\n\n    if (expiresIn) {\n      const expiresInMilliSeconds = expiresIn * 1000;\n      const now = this.dateTimeService.new();\n      const expiresAt = now.getTime() + expiresInMilliSeconds;\n\n      this._storage.setItem('expires_at', '' + expiresAt);\n    }\n\n    if (refreshToken) {\n      this._storage.setItem('refresh_token', refreshToken);\n    }\n\n    if (customParameters) {\n      customParameters.forEach((value, key) => {\n        this._storage.setItem(key, value);\n      });\n    }\n  }\n  /**\r\n   * Delegates to tryLoginImplicitFlow for the sake of competability\r\n   * @param options Optional options.\r\n   */\n\n\n  tryLogin(options = null) {\n    if (this.config.responseType === 'code') {\n      return this.tryLoginCodeFlow(options).then(_ => true);\n    } else {\n      return this.tryLoginImplicitFlow(options);\n    }\n  }\n\n  parseQueryString(queryString) {\n    if (!queryString || queryString.length === 0) {\n      return {};\n    }\n\n    if (queryString.charAt(0) === '?') {\n      queryString = queryString.substr(1);\n    }\n\n    return this.urlHelper.parseQueryString(queryString);\n  }\n\n  tryLoginCodeFlow(options = null) {\n    return __awaiter(this, void 0, void 0, function* () {\n      options = options || {};\n      const querySource = options.customHashFragment ? options.customHashFragment.substring(1) : window.location.search;\n      const parts = this.getCodePartsFromUrl(querySource);\n      const code = parts['code'];\n      const state = parts['state'];\n      const sessionState = parts['session_state'];\n\n      if (!options.preventClearHashAfterLogin) {\n        const href = location.origin + location.pathname + location.search.replace(/code=[^&\\$]*/, '').replace(/scope=[^&\\$]*/, '').replace(/state=[^&\\$]*/, '').replace(/session_state=[^&\\$]*/, '').replace(/^\\?&/, '?').replace(/&$/, '').replace(/^\\?$/, '').replace(/&+/g, '&').replace(/\\?&/, '?').replace(/\\?$/, '') + location.hash;\n        history.replaceState(null, window.name, href);\n      }\n\n      let [nonceInState, userState] = this.parseState(state);\n      this.state = userState;\n\n      if (parts['error']) {\n        this.debug('error trying to login');\n        this.handleLoginError(options, parts);\n        const err = new OAuthErrorEvent('code_error', {}, parts);\n        this.eventsSubject.next(err);\n        return Promise.reject(err);\n      }\n\n      if (!options.disableNonceCheck) {\n        if (!nonceInState) {\n          this.saveRequestedRoute();\n          return Promise.resolve();\n        }\n\n        if (!options.disableOAuth2StateCheck) {\n          const success = this.validateNonce(nonceInState);\n\n          if (!success) {\n            const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\n            this.eventsSubject.next(event);\n            return Promise.reject(event);\n          }\n        }\n\n        this.storeSessionState(sessionState);\n\n        if (code) {\n          yield this.getTokenFromCode(code, options);\n          this.restoreRequestedRoute();\n          return Promise.resolve();\n        } else {\n          return Promise.resolve();\n        }\n      }\n\n      return Promise.reject();\n    });\n  }\n\n  saveRequestedRoute() {\n    if (this.config.preserveRequestedRoute) {\n      this._storage.setItem('requested_route', window.location.pathname + window.location.search);\n    }\n  }\n\n  restoreRequestedRoute() {\n    const requestedRoute = this._storage.getItem('requested_route');\n\n    if (requestedRoute) {\n      history.replaceState(null, '', window.location.origin + requestedRoute);\n    }\n  }\n  /**\r\n   * Retrieve the returned auth code from the redirect uri that has been called.\r\n   * If required also check hash, as we could use hash location strategy.\r\n   */\n\n\n  getCodePartsFromUrl(queryString) {\n    if (!queryString || queryString.length === 0) {\n      return this.urlHelper.getHashFragmentParams();\n    } // normalize query string\n\n\n    if (queryString.charAt(0) === '?') {\n      queryString = queryString.substr(1);\n    }\n\n    return this.urlHelper.parseQueryString(queryString);\n  }\n  /**\r\n   * Get token using an intermediate code. Works for the Authorization Code flow.\r\n   */\n\n\n  getTokenFromCode(code, options) {\n    let params = new HttpParams({\n      encoder: new WebHttpUrlEncodingCodec()\n    }).set('grant_type', 'authorization_code').set('code', code).set('redirect_uri', options.customRedirectUri || this.redirectUri);\n\n    if (!this.disablePKCE) {\n      let PKCEVerifier;\n\n      if (this.saveNoncesInLocalStorage && typeof window['localStorage'] !== 'undefined') {\n        PKCEVerifier = localStorage.getItem('PKCE_verifier');\n      } else {\n        PKCEVerifier = this._storage.getItem('PKCE_verifier');\n      }\n\n      if (!PKCEVerifier) {\n        console.warn('No PKCE verifier found in oauth storage!');\n      } else {\n        params = params.set('code_verifier', PKCEVerifier);\n      }\n    }\n\n    return this.fetchAndProcessToken(params, options);\n  }\n\n  fetchAndProcessToken(params, options) {\n    options = options || {};\n    this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\n    let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\n\n    if (this.useHttpBasicAuth) {\n      const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\n      headers = headers.set('Authorization', 'Basic ' + header);\n    }\n\n    if (!this.useHttpBasicAuth) {\n      params = params.set('client_id', this.clientId);\n    }\n\n    if (!this.useHttpBasicAuth && this.dummyClientSecret) {\n      params = params.set('client_secret', this.dummyClientSecret);\n    }\n\n    return new Promise((resolve, reject) => {\n      if (this.customQueryParams) {\n        for (let key of Object.getOwnPropertyNames(this.customQueryParams)) {\n          params = params.set(key, this.customQueryParams[key]);\n        }\n      }\n\n      this.http.post(this.tokenEndpoint, params, {\n        headers\n      }).subscribe(tokenResponse => {\n        this.debug('refresh tokenResponse', tokenResponse);\n        this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in || this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\n\n        if (this.oidc && tokenResponse.id_token) {\n          this.processIdToken(tokenResponse.id_token, tokenResponse.access_token, options.disableNonceCheck).then(result => {\n            this.storeIdToken(result);\n            this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n            this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\n            resolve(tokenResponse);\n          }).catch(reason => {\n            this.eventsSubject.next(new OAuthErrorEvent('token_validation_error', reason));\n            console.error('Error validating tokens');\n            console.error(reason);\n            reject(reason);\n          });\n        } else {\n          this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n          this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\n          resolve(tokenResponse);\n        }\n      }, err => {\n        console.error('Error getting token', err);\n        this.eventsSubject.next(new OAuthErrorEvent('token_refresh_error', err));\n        reject(err);\n      });\n    });\n  }\n  /**\r\n   * Checks whether there are tokens in the hash fragment\r\n   * as a result of the implicit flow. These tokens are\r\n   * parsed, validated and used to sign the user in to the\r\n   * current client.\r\n   *\r\n   * @param options Optional options.\r\n   */\n\n\n  tryLoginImplicitFlow(options = null) {\n    options = options || {};\n    let parts;\n\n    if (options.customHashFragment) {\n      parts = this.urlHelper.getHashFragmentParams(options.customHashFragment);\n    } else {\n      parts = this.urlHelper.getHashFragmentParams();\n    }\n\n    this.debug('parsed url', parts);\n    const state = parts['state'];\n    let [nonceInState, userState] = this.parseState(state);\n    this.state = userState;\n\n    if (parts['error']) {\n      this.debug('error trying to login');\n      this.handleLoginError(options, parts);\n      const err = new OAuthErrorEvent('token_error', {}, parts);\n      this.eventsSubject.next(err);\n      return Promise.reject(err);\n    }\n\n    const accessToken = parts['access_token'];\n    const idToken = parts['id_token'];\n    const sessionState = parts['session_state'];\n    const grantedScopes = parts['scope'];\n\n    if (!this.requestAccessToken && !this.oidc) {\n      return Promise.reject('Either requestAccessToken or oidc (or both) must be true.');\n    }\n\n    if (this.requestAccessToken && !accessToken) {\n      return Promise.resolve(false);\n    }\n\n    if (this.requestAccessToken && !options.disableOAuth2StateCheck && !state) {\n      return Promise.resolve(false);\n    }\n\n    if (this.oidc && !idToken) {\n      return Promise.resolve(false);\n    }\n\n    if (this.sessionChecksEnabled && !sessionState) {\n      this.logger.warn('session checks (Session Status Change Notification) ' + 'were activated in the configuration but the id_token ' + 'does not contain a session_state claim');\n    }\n\n    if (this.requestAccessToken && !options.disableNonceCheck) {\n      const success = this.validateNonce(nonceInState);\n\n      if (!success) {\n        const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\n        this.eventsSubject.next(event);\n        return Promise.reject(event);\n      }\n    }\n\n    if (this.requestAccessToken) {\n      this.storeAccessTokenResponse(accessToken, null, parts['expires_in'] || this.fallbackAccessTokenExpirationTimeInSec, grantedScopes);\n    }\n\n    if (!this.oidc) {\n      this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n\n      if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\n        this.clearLocationHash();\n      }\n\n      this.callOnTokenReceivedIfExists(options);\n      return Promise.resolve(true);\n    }\n\n    return this.processIdToken(idToken, accessToken, options.disableNonceCheck).then(result => {\n      if (options.validationHandler) {\n        return options.validationHandler({\n          accessToken: accessToken,\n          idClaims: result.idTokenClaims,\n          idToken: result.idToken,\n          state: state\n        }).then(_ => result);\n      }\n\n      return result;\n    }).then(result => {\n      this.storeIdToken(result);\n      this.storeSessionState(sessionState);\n\n      if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\n        this.clearLocationHash();\n      }\n\n      this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\n      this.callOnTokenReceivedIfExists(options);\n      this.inImplicitFlow = false;\n      return true;\n    }).catch(reason => {\n      this.eventsSubject.next(new OAuthErrorEvent('token_validation_error', reason));\n      this.logger.error('Error validating tokens');\n      this.logger.error(reason);\n      return Promise.reject(reason);\n    });\n  }\n\n  parseState(state) {\n    let nonce = state;\n    let userState = '';\n\n    if (state) {\n      const idx = state.indexOf(this.config.nonceStateSeparator);\n\n      if (idx > -1) {\n        nonce = state.substr(0, idx);\n        userState = state.substr(idx + this.config.nonceStateSeparator.length);\n      }\n    }\n\n    return [nonce, userState];\n  }\n\n  validateNonce(nonceInState) {\n    let savedNonce;\n\n    if (this.saveNoncesInLocalStorage && typeof window['localStorage'] !== 'undefined') {\n      savedNonce = localStorage.getItem('nonce');\n    } else {\n      savedNonce = this._storage.getItem('nonce');\n    }\n\n    if (savedNonce !== nonceInState) {\n      const err = 'Validating access_token failed, wrong state/nonce.';\n      console.error(err, savedNonce, nonceInState);\n      return false;\n    }\n\n    return true;\n  }\n\n  storeIdToken(idToken) {\n    this._storage.setItem('id_token', idToken.idToken);\n\n    this._storage.setItem('id_token_claims_obj', idToken.idTokenClaimsJson);\n\n    this._storage.setItem('id_token_expires_at', '' + idToken.idTokenExpiresAt);\n\n    this._storage.setItem('id_token_stored_at', '' + this.dateTimeService.now());\n  }\n\n  storeSessionState(sessionState) {\n    this._storage.setItem('session_state', sessionState);\n  }\n\n  getSessionState() {\n    return this._storage.getItem('session_state');\n  }\n\n  handleLoginError(options, parts) {\n    if (options.onLoginError) {\n      options.onLoginError(parts);\n    }\n\n    if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\n      this.clearLocationHash();\n    }\n  }\n\n  getClockSkewInMsec(defaultSkewMsc = 600000) {\n    if (!this.clockSkewInSec) {\n      return defaultSkewMsc;\n    }\n\n    return this.clockSkewInSec * 1000;\n  }\n  /**\r\n   * @ignore\r\n   */\n\n\n  processIdToken(idToken, accessToken, skipNonceCheck = false) {\n    const tokenParts = idToken.split('.');\n    const headerBase64 = this.padBase64(tokenParts[0]);\n    const headerJson = b64DecodeUnicode(headerBase64);\n    const header = JSON.parse(headerJson);\n    const claimsBase64 = this.padBase64(tokenParts[1]);\n    const claimsJson = b64DecodeUnicode(claimsBase64);\n    const claims = JSON.parse(claimsJson);\n    let savedNonce;\n\n    if (this.saveNoncesInLocalStorage && typeof window['localStorage'] !== 'undefined') {\n      savedNonce = localStorage.getItem('nonce');\n    } else {\n      savedNonce = this._storage.getItem('nonce');\n    }\n\n    if (Array.isArray(claims.aud)) {\n      if (claims.aud.every(v => v !== this.clientId)) {\n        const err = 'Wrong audience: ' + claims.aud.join(',');\n        this.logger.warn(err);\n        return Promise.reject(err);\n      }\n    } else {\n      if (claims.aud !== this.clientId) {\n        const err = 'Wrong audience: ' + claims.aud;\n        this.logger.warn(err);\n        return Promise.reject(err);\n      }\n    }\n\n    if (!claims.sub) {\n      const err = 'No sub claim in id_token';\n      this.logger.warn(err);\n      return Promise.reject(err);\n    }\n    /* For now, we only check whether the sub against\r\n     * silentRefreshSubject when sessionChecksEnabled is on\r\n     * We will reconsider in a later version to do this\r\n     * in every other case too.\r\n     */\n\n\n    if (this.sessionChecksEnabled && this.silentRefreshSubject && this.silentRefreshSubject !== claims['sub']) {\n      const err = 'After refreshing, we got an id_token for another user (sub). ' + `Expected sub: ${this.silentRefreshSubject}, received sub: ${claims['sub']}`;\n      this.logger.warn(err);\n      return Promise.reject(err);\n    }\n\n    if (!claims.iat) {\n      const err = 'No iat claim in id_token';\n      this.logger.warn(err);\n      return Promise.reject(err);\n    }\n\n    if (!this.skipIssuerCheck && claims.iss !== this.issuer) {\n      const err = 'Wrong issuer: ' + claims.iss;\n      this.logger.warn(err);\n      return Promise.reject(err);\n    }\n\n    if (!skipNonceCheck && claims.nonce !== savedNonce) {\n      const err = 'Wrong nonce: ' + claims.nonce;\n      this.logger.warn(err);\n      return Promise.reject(err);\n    } // at_hash is not applicable to authorization code flow\n    // addressing https://github.com/manfredsteyer/angular-oauth2-oidc/issues/661\n    // i.e. Based on spec the at_hash check is only true for implicit code flow on Ping Federate\n    // https://www.pingidentity.com/developer/en/resources/openid-connect-developers-guide.html\n\n\n    if (this.hasOwnProperty('responseType') && (this.responseType === 'code' || this.responseType === 'id_token')) {\n      this.disableAtHashCheck = true;\n    }\n\n    if (!this.disableAtHashCheck && this.requestAccessToken && !claims['at_hash']) {\n      const err = 'An at_hash is needed!';\n      this.logger.warn(err);\n      return Promise.reject(err);\n    }\n\n    const now = this.dateTimeService.now();\n    const issuedAtMSec = claims.iat * 1000;\n    const expiresAtMSec = claims.exp * 1000;\n    const clockSkewInMSec = this.getClockSkewInMsec(); // (this.getClockSkewInMsec() || 600) * 1000;\n\n    if (issuedAtMSec - clockSkewInMSec >= now || expiresAtMSec + clockSkewInMSec <= now) {\n      const err = 'Token has expired';\n      console.error(err);\n      console.error({\n        now: now,\n        issuedAtMSec: issuedAtMSec,\n        expiresAtMSec: expiresAtMSec\n      });\n      return Promise.reject(err);\n    }\n\n    const validationParams = {\n      accessToken: accessToken,\n      idToken: idToken,\n      jwks: this.jwks,\n      idTokenClaims: claims,\n      idTokenHeader: header,\n      loadKeys: () => this.loadJwks()\n    };\n\n    if (this.disableAtHashCheck) {\n      return this.checkSignature(validationParams).then(_ => {\n        const result = {\n          idToken: idToken,\n          idTokenClaims: claims,\n          idTokenClaimsJson: claimsJson,\n          idTokenHeader: header,\n          idTokenHeaderJson: headerJson,\n          idTokenExpiresAt: expiresAtMSec\n        };\n        return result;\n      });\n    }\n\n    return this.checkAtHash(validationParams).then(atHashValid => {\n      if (!this.disableAtHashCheck && this.requestAccessToken && !atHashValid) {\n        const err = 'Wrong at_hash';\n        this.logger.warn(err);\n        return Promise.reject(err);\n      }\n\n      return this.checkSignature(validationParams).then(_ => {\n        const atHashCheckEnabled = !this.disableAtHashCheck;\n        const result = {\n          idToken: idToken,\n          idTokenClaims: claims,\n          idTokenClaimsJson: claimsJson,\n          idTokenHeader: header,\n          idTokenHeaderJson: headerJson,\n          idTokenExpiresAt: expiresAtMSec\n        };\n\n        if (atHashCheckEnabled) {\n          return this.checkAtHash(validationParams).then(atHashValid => {\n            if (this.requestAccessToken && !atHashValid) {\n              const err = 'Wrong at_hash';\n              this.logger.warn(err);\n              return Promise.reject(err);\n            } else {\n              return result;\n            }\n          });\n        } else {\n          return result;\n        }\n      });\n    });\n  }\n  /**\r\n   * Returns the received claims about the user.\r\n   */\n\n\n  getIdentityClaims() {\n    const claims = this._storage.getItem('id_token_claims_obj');\n\n    if (!claims) {\n      return null;\n    }\n\n    return JSON.parse(claims);\n  }\n  /**\r\n   * Returns the granted scopes from the server.\r\n   */\n\n\n  getGrantedScopes() {\n    const scopes = this._storage.getItem('granted_scopes');\n\n    if (!scopes) {\n      return null;\n    }\n\n    return JSON.parse(scopes);\n  }\n  /**\r\n   * Returns the current id_token.\r\n   */\n\n\n  getIdToken() {\n    return this._storage ? this._storage.getItem('id_token') : null;\n  }\n\n  padBase64(base64data) {\n    while (base64data.length % 4 !== 0) {\n      base64data += '=';\n    }\n\n    return base64data;\n  }\n  /**\r\n   * Returns the current access_token.\r\n   */\n\n\n  getAccessToken() {\n    return this._storage ? this._storage.getItem('access_token') : null;\n  }\n\n  getRefreshToken() {\n    return this._storage ? this._storage.getItem('refresh_token') : null;\n  }\n  /**\r\n   * Returns the expiration date of the access_token\r\n   * as milliseconds since 1970.\r\n   */\n\n\n  getAccessTokenExpiration() {\n    if (!this._storage.getItem('expires_at')) {\n      return null;\n    }\n\n    return parseInt(this._storage.getItem('expires_at'), 10);\n  }\n\n  getAccessTokenStoredAt() {\n    return parseInt(this._storage.getItem('access_token_stored_at'), 10);\n  }\n\n  getIdTokenStoredAt() {\n    return parseInt(this._storage.getItem('id_token_stored_at'), 10);\n  }\n  /**\r\n   * Returns the expiration date of the id_token\r\n   * as milliseconds since 1970.\r\n   */\n\n\n  getIdTokenExpiration() {\n    if (!this._storage.getItem('id_token_expires_at')) {\n      return null;\n    }\n\n    return parseInt(this._storage.getItem('id_token_expires_at'), 10);\n  }\n  /**\r\n   * Checkes, whether there is a valid access_token.\r\n   */\n\n\n  hasValidAccessToken() {\n    if (this.getAccessToken()) {\n      const expiresAt = this._storage.getItem('expires_at');\n\n      const now = this.dateTimeService.new();\n\n      if (expiresAt && parseInt(expiresAt, 10) < now.getTime() - this.getClockSkewInMsec()) {\n        return false;\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n  /**\r\n   * Checks whether there is a valid id_token.\r\n   */\n\n\n  hasValidIdToken() {\n    if (this.getIdToken()) {\n      const expiresAt = this._storage.getItem('id_token_expires_at');\n\n      const now = this.dateTimeService.new();\n\n      if (expiresAt && parseInt(expiresAt, 10) < now.getTime() - this.getClockSkewInMsec()) {\n        return false;\n      }\n\n      return true;\n    }\n\n    return false;\n  }\n  /**\r\n   * Retrieve a saved custom property of the TokenReponse object. Only if predefined in authconfig.\r\n   */\n\n\n  getCustomTokenResponseProperty(requestedProperty) {\n    return this._storage && this.config.customTokenParameters && this.config.customTokenParameters.indexOf(requestedProperty) >= 0 && this._storage.getItem(requestedProperty) !== null ? JSON.parse(this._storage.getItem(requestedProperty)) : null;\n  }\n  /**\r\n   * Returns the auth-header that can be used\r\n   * to transmit the access_token to a service\r\n   */\n\n\n  authorizationHeader() {\n    return 'Bearer ' + this.getAccessToken();\n  }\n\n  logOut(customParameters = {}, state = '') {\n    let noRedirectToLogoutUrl = false;\n\n    if (typeof customParameters === 'boolean') {\n      noRedirectToLogoutUrl = customParameters;\n      customParameters = {};\n    }\n\n    const id_token = this.getIdToken();\n\n    this._storage.removeItem('access_token');\n\n    this._storage.removeItem('id_token');\n\n    this._storage.removeItem('refresh_token');\n\n    if (this.saveNoncesInLocalStorage) {\n      localStorage.removeItem('nonce');\n      localStorage.removeItem('PKCE_verifier');\n    } else {\n      this._storage.removeItem('nonce');\n\n      this._storage.removeItem('PKCE_verifier');\n    }\n\n    this._storage.removeItem('expires_at');\n\n    this._storage.removeItem('id_token_claims_obj');\n\n    this._storage.removeItem('id_token_expires_at');\n\n    this._storage.removeItem('id_token_stored_at');\n\n    this._storage.removeItem('access_token_stored_at');\n\n    this._storage.removeItem('granted_scopes');\n\n    this._storage.removeItem('session_state');\n\n    if (this.config.customTokenParameters) {\n      this.config.customTokenParameters.forEach(customParam => this._storage.removeItem(customParam));\n    }\n\n    this.silentRefreshSubject = null;\n    this.eventsSubject.next(new OAuthInfoEvent('logout'));\n\n    if (!this.logoutUrl) {\n      return;\n    }\n\n    if (noRedirectToLogoutUrl) {\n      return;\n    }\n\n    if (!id_token && !this.postLogoutRedirectUri) {\n      return;\n    }\n\n    let logoutUrl;\n\n    if (!this.validateUrlForHttps(this.logoutUrl)) {\n      throw new Error(\"logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n    } // For backward compatibility\n\n\n    if (this.logoutUrl.indexOf('{{') > -1) {\n      logoutUrl = this.logoutUrl.replace(/\\{\\{id_token\\}\\}/, encodeURIComponent(id_token)).replace(/\\{\\{client_id\\}\\}/, encodeURIComponent(this.clientId));\n    } else {\n      let params = new HttpParams({\n        encoder: new WebHttpUrlEncodingCodec()\n      });\n\n      if (id_token) {\n        params = params.set('id_token_hint', id_token);\n      }\n\n      const postLogoutUrl = this.postLogoutRedirectUri || this.redirectUriAsPostLogoutRedirectUriFallback && this.redirectUri || '';\n\n      if (postLogoutUrl) {\n        params = params.set('post_logout_redirect_uri', postLogoutUrl);\n\n        if (state) {\n          params = params.set('state', state);\n        }\n      }\n\n      for (let key in customParameters) {\n        params = params.set(key, customParameters[key]);\n      }\n\n      logoutUrl = this.logoutUrl + (this.logoutUrl.indexOf('?') > -1 ? '&' : '?') + params.toString();\n    }\n\n    this.config.openUri(logoutUrl);\n  }\n  /**\r\n   * @ignore\r\n   */\n\n\n  createAndSaveNonce() {\n    const that = this;\n    return this.createNonce().then(function (nonce) {\n      // Use localStorage for nonce if possible\n      // localStorage is the only storage who survives a\n      // redirect in ALL browsers (also IE)\n      // Otherwiese we'd force teams who have to support\n      // IE into using localStorage for everything\n      if (that.saveNoncesInLocalStorage && typeof window['localStorage'] !== 'undefined') {\n        localStorage.setItem('nonce', nonce);\n      } else {\n        that._storage.setItem('nonce', nonce);\n      }\n\n      return nonce;\n    });\n  }\n  /**\r\n   * @ignore\r\n   */\n\n\n  ngOnDestroy() {\n    this.clearAccessTokenTimer();\n    this.clearIdTokenTimer();\n    this.removeSilentRefreshEventListener();\n    const silentRefreshFrame = this.document.getElementById(this.silentRefreshIFrameName);\n\n    if (silentRefreshFrame) {\n      silentRefreshFrame.remove();\n    }\n\n    this.stopSessionCheckTimer();\n    this.removeSessionCheckEventListener();\n    const sessionCheckFrame = this.document.getElementById(this.sessionCheckIFrameName);\n\n    if (sessionCheckFrame) {\n      sessionCheckFrame.remove();\n    }\n  }\n\n  createNonce() {\n    return new Promise(resolve => {\n      if (this.rngUrl) {\n        throw new Error('createNonce with rng-web-api has not been implemented so far');\n      }\n      /*\r\n       * This alphabet is from:\r\n       * https://tools.ietf.org/html/rfc7636#section-4.1\r\n       *\r\n       * [A-Z] / [a-z] / [0-9] / \"-\" / \".\" / \"_\" / \"~\"\r\n       */\n\n\n      const unreserved = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\n      let size = 45;\n      let id = '';\n      const crypto = typeof self === 'undefined' ? null : self.crypto || self['msCrypto'];\n\n      if (crypto) {\n        let bytes = new Uint8Array(size);\n        crypto.getRandomValues(bytes); // Needed for IE\n\n        if (!bytes.map) {\n          bytes.map = Array.prototype.map;\n        }\n\n        bytes = bytes.map(x => unreserved.charCodeAt(x % unreserved.length));\n        id = String.fromCharCode.apply(null, bytes);\n      } else {\n        while (0 < size--) {\n          id += unreserved[Math.random() * unreserved.length | 0];\n        }\n      }\n\n      resolve(base64UrlEncode(id));\n    });\n  }\n\n  checkAtHash(params) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.tokenValidationHandler) {\n        this.logger.warn('No tokenValidationHandler configured. Cannot check at_hash.');\n        return true;\n      }\n\n      return this.tokenValidationHandler.validateAtHash(params);\n    });\n  }\n\n  checkSignature(params) {\n    if (!this.tokenValidationHandler) {\n      this.logger.warn('No tokenValidationHandler configured. Cannot check signature.');\n      return Promise.resolve(null);\n    }\n\n    return this.tokenValidationHandler.validateSignature(params);\n  }\n  /**\r\n   * Start the implicit flow or the code flow,\r\n   * depending on your configuration.\r\n   */\n\n\n  initLoginFlow(additionalState = '', params = {}) {\n    if (this.responseType === 'code') {\n      return this.initCodeFlow(additionalState, params);\n    } else {\n      return this.initImplicitFlow(additionalState, params);\n    }\n  }\n  /**\r\n   * Starts the authorization code flow and redirects to user to\r\n   * the auth servers login url.\r\n   */\n\n\n  initCodeFlow(additionalState = '', params = {}) {\n    if (this.loginUrl !== '') {\n      this.initCodeFlowInternal(additionalState, params);\n    } else {\n      this.events.pipe(filter(e => e.type === 'discovery_document_loaded')).subscribe(_ => this.initCodeFlowInternal(additionalState, params));\n    }\n  }\n\n  initCodeFlowInternal(additionalState = '', params = {}) {\n    if (!this.validateUrlForHttps(this.loginUrl)) {\n      throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\n    }\n\n    let addParams = {};\n    let loginHint = null;\n\n    if (typeof params === 'string') {\n      loginHint = params;\n    } else if (typeof params === 'object') {\n      addParams = params;\n    }\n\n    this.createLoginUrl(additionalState, loginHint, null, false, addParams).then(this.config.openUri).catch(error => {\n      console.error('Error in initAuthorizationCodeFlow');\n      console.error(error);\n    });\n  }\n\n  createChallangeVerifierPairForPKCE() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.crypto) {\n        throw new Error('PKCE support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?');\n      }\n\n      const verifier = yield this.createNonce();\n      const challengeRaw = yield this.crypto.calcHash(verifier, 'sha-256');\n      const challenge = base64UrlEncode(challengeRaw);\n      return [challenge, verifier];\n    });\n  }\n\n  extractRecognizedCustomParameters(tokenResponse) {\n    let foundParameters = new Map();\n\n    if (!this.config.customTokenParameters) {\n      return foundParameters;\n    }\n\n    this.config.customTokenParameters.forEach(recognizedParameter => {\n      if (tokenResponse[recognizedParameter]) {\n        foundParameters.set(recognizedParameter, JSON.stringify(tokenResponse[recognizedParameter]));\n      }\n    });\n    return foundParameters;\n  }\n  /**\r\n   * Revokes the auth token to secure the vulnarability\r\n   * of the token issued allowing the authorization server to clean\r\n   * up any security credentials associated with the authorization\r\n   */\n\n\n  revokeTokenAndLogout(customParameters = {}, ignoreCorsIssues = false) {\n    let revokeEndpoint = this.revocationEndpoint;\n    let accessToken = this.getAccessToken();\n    let refreshToken = this.getRefreshToken();\n\n    if (!accessToken) {\n      return;\n    }\n\n    let params = new HttpParams({\n      encoder: new WebHttpUrlEncodingCodec()\n    });\n    let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\n\n    if (this.useHttpBasicAuth) {\n      const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\n      headers = headers.set('Authorization', 'Basic ' + header);\n    }\n\n    if (!this.useHttpBasicAuth) {\n      params = params.set('client_id', this.clientId);\n    }\n\n    if (!this.useHttpBasicAuth && this.dummyClientSecret) {\n      params = params.set('client_secret', this.dummyClientSecret);\n    }\n\n    if (this.customQueryParams) {\n      for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\n        params = params.set(key, this.customQueryParams[key]);\n      }\n    }\n\n    return new Promise((resolve, reject) => {\n      let revokeAccessToken;\n      let revokeRefreshToken;\n\n      if (accessToken) {\n        let revokationParams = params.set('token', accessToken).set('token_type_hint', 'access_token');\n        revokeAccessToken = this.http.post(revokeEndpoint, revokationParams, {\n          headers\n        });\n      } else {\n        revokeAccessToken = of(null);\n      }\n\n      if (refreshToken) {\n        let revokationParams = params.set('token', refreshToken).set('token_type_hint', 'refresh_token');\n        revokeRefreshToken = this.http.post(revokeEndpoint, revokationParams, {\n          headers\n        });\n      } else {\n        revokeRefreshToken = of(null);\n      }\n\n      if (ignoreCorsIssues) {\n        revokeAccessToken = revokeAccessToken.pipe(catchError(err => {\n          if (err.status === 0) {\n            return of(null);\n          }\n\n          return throwError(err);\n        }));\n        revokeRefreshToken = revokeRefreshToken.pipe(catchError(err => {\n          if (err.status === 0) {\n            return of(null);\n          }\n\n          return throwError(err);\n        }));\n      }\n\n      combineLatest([revokeAccessToken, revokeRefreshToken]).subscribe(res => {\n        this.logOut(customParameters);\n        resolve(res);\n        this.logger.info('Token successfully revoked');\n      }, err => {\n        this.logger.error('Error revoking token', err);\n        this.eventsSubject.next(new OAuthErrorEvent('token_revoke_error', err));\n        reject(err);\n      });\n    });\n  }\n  /**\r\n   * Clear location.hash if it's present\r\n   */\n\n\n  clearLocationHash() {\n    // Checking for empty hash is necessary for Firefox\n    // as setting an empty hash to an empty string adds # to the URL\n    if (location.hash != '') {\n      location.hash = '';\n    }\n  }\n\n}\n\nOAuthService.ɵfac = function OAuthService_Factory(t) {\n  return new (t || OAuthService)(i0.ɵɵinject(i0.NgZone), i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(OAuthStorage, 8), i0.ɵɵinject(ValidationHandler, 8), i0.ɵɵinject(AuthConfig, 8), i0.ɵɵinject(UrlHelperService), i0.ɵɵinject(OAuthLogger), i0.ɵɵinject(HashHandler, 8), i0.ɵɵinject(DOCUMENT), i0.ɵɵinject(DateTimeProvider));\n};\n\nOAuthService.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: OAuthService,\n  factory: OAuthService.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OAuthService, [{\n    type: Injectable\n  }], function () {\n    return [{\n      type: i0.NgZone\n    }, {\n      type: i1.HttpClient\n    }, {\n      type: OAuthStorage,\n      decorators: [{\n        type: Optional\n      }]\n    }, {\n      type: ValidationHandler,\n      decorators: [{\n        type: Optional\n      }]\n    }, {\n      type: AuthConfig,\n      decorators: [{\n        type: Optional\n      }]\n    }, {\n      type: UrlHelperService\n    }, {\n      type: OAuthLogger\n    }, {\n      type: HashHandler,\n      decorators: [{\n        type: Optional\n      }]\n    }, {\n      type: undefined,\n      decorators: [{\n        type: Inject,\n        args: [DOCUMENT]\n      }]\n    }, {\n      type: DateTimeProvider\n    }];\n  }, null);\n})();\n\nclass OAuthModuleConfig {}\n\nclass OAuthResourceServerConfig {}\n\nclass OAuthResourceServerErrorHandler {}\n\nclass OAuthNoopResourceServerErrorHandler {\n  handleError(err) {\n    return throwError(err);\n  }\n\n}\n\nclass DefaultOAuthInterceptor {\n  constructor(oAuthService, errorHandler, moduleConfig) {\n    this.oAuthService = oAuthService;\n    this.errorHandler = errorHandler;\n    this.moduleConfig = moduleConfig;\n  }\n\n  checkUrl(url) {\n    if (this.moduleConfig.resourceServer.customUrlValidation) {\n      return this.moduleConfig.resourceServer.customUrlValidation(url);\n    }\n\n    if (this.moduleConfig.resourceServer.allowedUrls) {\n      return !!this.moduleConfig.resourceServer.allowedUrls.find(u => url.toLowerCase().startsWith(u.toLowerCase()));\n    }\n\n    return true;\n  }\n\n  intercept(req, next) {\n    const url = req.url.toLowerCase();\n\n    if (!this.moduleConfig || !this.moduleConfig.resourceServer || !this.checkUrl(url)) {\n      return next.handle(req);\n    }\n\n    const sendAccessToken = this.moduleConfig.resourceServer.sendAccessToken;\n\n    if (!sendAccessToken) {\n      return next.handle(req).pipe(catchError(err => this.errorHandler.handleError(err)));\n    }\n\n    return merge(of(this.oAuthService.getAccessToken()).pipe(filter(token => !!token)), this.oAuthService.events.pipe(filter(e => e.type === 'token_received'), timeout(this.oAuthService.waitForTokenInMsec || 0), catchError(_ => of(null)), // timeout is not an error\n    map(_ => this.oAuthService.getAccessToken()))).pipe(take(1), mergeMap(token => {\n      if (token) {\n        const header = 'Bearer ' + token;\n        const headers = req.headers.set('Authorization', header);\n        req = req.clone({\n          headers\n        });\n      }\n\n      return next.handle(req).pipe(catchError(err => this.errorHandler.handleError(err)));\n    }));\n  }\n\n}\n\nDefaultOAuthInterceptor.ɵfac = function DefaultOAuthInterceptor_Factory(t) {\n  return new (t || DefaultOAuthInterceptor)(i0.ɵɵinject(OAuthService), i0.ɵɵinject(OAuthResourceServerErrorHandler), i0.ɵɵinject(OAuthModuleConfig, 8));\n};\n\nDefaultOAuthInterceptor.ɵprov = /* @__PURE__ */i0.ɵɵdefineInjectable({\n  token: DefaultOAuthInterceptor,\n  factory: DefaultOAuthInterceptor.ɵfac\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(DefaultOAuthInterceptor, [{\n    type: Injectable\n  }], function () {\n    return [{\n      type: OAuthService\n    }, {\n      type: OAuthResourceServerErrorHandler\n    }, {\n      type: OAuthModuleConfig,\n      decorators: [{\n        type: Optional\n      }]\n    }];\n  }, null);\n})();\n/**\r\n * A validation handler that isn't validating nothing.\r\n * Can be used to skip validation (at your own risk).\r\n */\n\n\nclass NullValidationHandler {\n  validateSignature(validationParams) {\n    return Promise.resolve(null);\n  }\n\n  validateAtHash(validationParams) {\n    return Promise.resolve(true);\n  }\n\n}\n\nfunction createDefaultLogger() {\n  return console;\n}\n\nfunction createDefaultStorage() {\n  return typeof sessionStorage !== 'undefined' ? sessionStorage : new MemoryStorage();\n}\n\nclass OAuthModule {\n  static forRoot(config = null, validationHandlerClass = NullValidationHandler) {\n    return {\n      ngModule: OAuthModule,\n      providers: [OAuthService, UrlHelperService, {\n        provide: OAuthLogger,\n        useFactory: createDefaultLogger\n      }, {\n        provide: OAuthStorage,\n        useFactory: createDefaultStorage\n      }, {\n        provide: ValidationHandler,\n        useClass: validationHandlerClass\n      }, {\n        provide: HashHandler,\n        useClass: DefaultHashHandler\n      }, {\n        provide: OAuthResourceServerErrorHandler,\n        useClass: OAuthNoopResourceServerErrorHandler\n      }, {\n        provide: OAuthModuleConfig,\n        useValue: config\n      }, {\n        provide: HTTP_INTERCEPTORS,\n        useClass: DefaultOAuthInterceptor,\n        multi: true\n      }, {\n        provide: DateTimeProvider,\n        useClass: SystemDateTimeProvider\n      }]\n    };\n  }\n\n}\n\nOAuthModule.ɵfac = function OAuthModule_Factory(t) {\n  return new (t || OAuthModule)();\n};\n\nOAuthModule.ɵmod = /* @__PURE__ */i0.ɵɵdefineNgModule({\n  type: OAuthModule\n});\nOAuthModule.ɵinj = /* @__PURE__ */i0.ɵɵdefineInjector({\n  imports: [[CommonModule]]\n});\n\n(function () {\n  (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(OAuthModule, [{\n    type: NgModule,\n    args: [{\n      imports: [CommonModule],\n      declarations: [],\n      exports: []\n    }]\n  }], null, null);\n})();\n\nconst err = `PLEASE READ THIS CAREFULLY:\n\nBeginning with angular-oauth2-oidc version 9, the JwksValidationHandler\nhas been moved to an library of its own. If you need it for implementing\nOAuth2/OIDC **implicit flow**, please install it using npm:\n\n  npm i angular-oauth2-oidc-jwks --save\n\nAfter that, you can import it into your application:\n\n  import { JwksValidationHandler } from 'angular-oauth2-oidc-jwks';\n\nPlease note, that this dependency is not needed for the **code flow**,\nwhich is nowadays the **recommented** one for single page applications.\nThis also results in smaller bundle sizes.\n`;\n/**\r\n * This is just a dummy of the JwksValidationHandler\r\n * telling the users that the real one has been moved\r\n * to an library of its own, namely angular-oauth2-oidc-utils\r\n */\n\nclass JwksValidationHandler extends NullValidationHandler {\n  constructor() {\n    super();\n    console.error(err);\n  }\n\n}\n\nconst AUTH_CONFIG = new InjectionToken('AUTH_CONFIG');\n/**\r\n * Generated bundle index. Do not edit.\r\n */\n\nexport { AUTH_CONFIG, AbstractValidationHandler, AuthConfig, DateTimeProvider, DefaultHashHandler, DefaultOAuthInterceptor, HashHandler, JwksValidationHandler, LoginOptions, MemoryStorage, NullValidationHandler, OAuthErrorEvent, OAuthEvent, OAuthInfoEvent, OAuthLogger, OAuthModule, OAuthModuleConfig, OAuthNoopResourceServerErrorHandler, OAuthResourceServerConfig, OAuthResourceServerErrorHandler, OAuthService, OAuthStorage, OAuthSuccessEvent, ReceivedTokens, SystemDateTimeProvider, UrlHelperService, ValidationHandler };","map":{"version":3,"sources":["D:/Repositories/EveTrader/node_modules/angular-oauth2-oidc/fesm2015/angular-oauth2-oidc.mjs"],"names":["i0","Injectable","Optional","Inject","NgModule","InjectionToken","DOCUMENT","CommonModule","i1","HttpHeaders","HttpParams","HTTP_INTERCEPTORS","__awaiter","Subject","of","from","race","throwError","combineLatest","merge","filter","tap","debounceTime","delay","switchMap","map","first","catchError","timeout","take","mergeMap","fsha256","DateTimeProvider","SystemDateTimeProvider","now","Date","new","ɵfac","ɵprov","type","LoginOptions","constructor","disableNonceCheck","preventClearHashAfterLogin","OAuthLogger","OAuthStorage","MemoryStorage","data","Map","getItem","key","get","removeItem","delete","setItem","set","ReceivedTokens","OAuthEvent","OAuthSuccessEvent","info","OAuthInfoEvent","OAuthErrorEvent","reason","params","b64DecodeUnicode","str","base64","replace","decodeURIComponent","atob","split","c","charCodeAt","toString","slice","join","base64UrlEncode","btoa","AuthConfig","json","clientId","redirectUri","postLogoutRedirectUri","redirectUriAsPostLogoutRedirectUriFallback","loginUrl","scope","resource","rngUrl","oidc","requestAccessToken","options","issuer","logoutUrl","clearHashAfterLogin","tokenEndpoint","revocationEndpoint","customTokenParameters","userinfoEndpoint","responseType","showDebugInformation","silentRefreshRedirectUri","silentRefreshMessagePrefix","silentRefreshShowIFrame","siletRefreshTimeout","silentRefreshTimeout","dummyClientSecret","requireHttps","strictDiscoveryDocumentValidation","jwks","customQueryParams","silentRefreshIFrameName","timeoutFactor","sessionChecksEnabled","sessionCheckIntervall","sessionCheckIFrameUrl","sessionCheckIFrameName","disableAtHashCheck","skipSubjectCheck","useIdTokenHintForSilentRefresh","skipIssuerCheck","nonceStateSeparator","useHttpBasicAuth","waitForTokenInMsec","disablePKCE","preserveRequestedRoute","openUri","uri","location","href","Object","assign","WebHttpUrlEncodingCodec","encodeKey","k","encodeURIComponent","encodeValue","v","decodeKey","decodeValue","ValidationHandler","AbstractValidationHandler","validateAtHash","hashAlg","inferHashAlgorithm","idTokenHeader","tokenHash","calcHash","accessToken","leftMostHalf","substr","length","atHash","claimsAtHash","idTokenClaims","console","error","jwtHeader","alg","match","Error","UrlHelperService","getHashFragmentParams","customHashFragment","hash","window","indexOf","questionMarkPosition","parseQueryString","queryString","pairs","pair","separatorIndex","escapedKey","escapedValue","value","i","factory","ERROR","WINDOW","root","JS_SHA256_NO_WINDOW","WEB_WORKER","self","NODE_JS","JS_SHA256_NO_NODE_JS","process","versions","node","global","COMMON_JS","JS_SHA256_NO_COMMON_JS","module","exports","AMD","define","amd","ARRAY_BUFFER","JS_SHA256_NO_ARRAY_BUFFER","ArrayBuffer","HEX_CHARS","EXTRA","SHIFT","K","OUTPUT_TYPES","blocks","Array","isArray","obj","prototype","call","JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW","isView","buffer","createOutputMethod","outputType","is224","message","Sha256","update","createMethod","method","nodeWrap","create","crypto","eval","Buffer","algorithm","nodeMethod","createHash","digest","undefined","Uint8Array","createHmacOutputMethod","HmacSha256","createHmacMethod","sharedMemory","h0","h1","h2","h3","h4","h5","h6","h7","block","start","bytes","hBytes","finalized","hashed","notString","code","index","lastByteIndex","finalize","a","b","d","e","f","g","h","j","s0","s1","maj","t1","t2","ch","ab","da","cd","bc","hex","arr","push","array","arrayBuffer","dataView","DataView","setUint32","oKeyPad","iKeyPad","inner","innerHash","sha256","sha224","hmac","HashHandler","decodeUTF8","s","TypeError","encodeUTF8","String","fromCharCode","DefaultHashHandler","valueToHash","candHash","toHashString2","byteArray","result","toHashString","OAuthService","ngZone","http","storage","tokenValidationHandler","config","urlHelper","logger","document","dateTimeService","_a","discoveryDocumentLoaded","state","eventsSubject","discoveryDocumentLoadedSubject","grantTypesSupported","inImplicitFlow","saveNoncesInLocalStorage","debug","discoveryDocumentLoaded$","asObservable","events","configure","setStorage","sessionStorage","checkLocalStorageAccessable","ua","navigator","userAgent","msie","includes","setupRefreshTimer","test","localStorage","setupSessionCheck","configChanged","restartSessionChecksIfStillLoggedIn","hasValidIdToken","initSessionCheck","restartRefreshTimerIfStillLoggedIn","setupExpirationTimers","pipe","subscribe","setupAutomaticSilentRefresh","listenTo","noPrompt","shouldRunSilentRefresh","clearAutomaticRefreshTimer","automaticRefreshSubscription","_","refreshInternal","catch","useSilentRefresh","refreshToken","silentRefresh","loadDiscoveryDocumentAndTryLogin","loadDiscoveryDocument","then","doc","tryLogin","loadDiscoveryDocumentAndLogin","hasValidAccessToken","initLoginFlow","args","apply","validateUrlFromDiscoveryDocument","url","errors","httpsCheck","validateUrlForHttps","issuerCheck","validateUrlAgainstIssuer","lcUrl","toLowerCase","startsWith","assertUrlNotNullAndCorrectProtocol","description","clearAccessTokenTimer","clearIdTokenTimer","tokenReceivedSubscription","unsubscribe","setupAccessTokenTimer","setupIdTokenTimer","expiration","getAccessTokenExpiration","storedAt","getAccessTokenStoredAt","calcTimeout","runOutsideAngular","accessTokenTimeoutSubscription","run","next","getIdTokenExpiration","getIdTokenStoredAt","idTokenTimeoutSubscription","stopAutomaticRefresh","delta","Math","max","_storage","fullUrl","Promise","resolve","reject","endsWith","validateDiscoveryDocument","authorization_endpoint","end_session_endpoint","grant_types_supported","token_endpoint","userinfo_endpoint","jwksUri","jwks_uri","check_session_iframe","revocation_endpoint","loadJwks","discoveryDocument","event","err","warn","fetchTokenUsingPasswordFlowAndLoadUserProfile","userName","password","headers","fetchTokenUsingPasswordFlow","loadUserProfile","getAccessToken","observe","response","JSON","stringify","parse","body","existingClaims","getIdentityClaims","sub","parameters","username","fetchTokenUsingGrant","grantType","encoder","header","getOwnPropertyNames","keys","post","tokenResponse","storeAccessTokenResponse","access_token","refresh_token","expires_in","fallbackAccessTokenExpirationTimeInSec","extractRecognizedCustomParameters","id_token","processIdToken","storeIdToken","removeSilentRefreshEventListener","silentRefreshPostMessageEventListener","removeEventListener","setupSilentRefreshEventListener","processMessageEventMessage","customRedirectUri","addEventListener","claims","getIdToken","existingIframe","getElementById","removeChild","silentRefreshSubject","iframe","createElement","id","createLoginUrl","setAttribute","style","appendChild","success","toPromise","initImplicitFlowInPopup","initLoginFlowInPopup","display","checkForPopupClosedInterval","windowRef","open","calculatePopupFeatures","closed","checkForPopupClosedTimer","cleanup","checkForPopupClosed","setInterval","clearInterval","storageListener","listener","close","log","newValue","height","width","left","screenLeft","outerWidth","top","screenTop","outerHeight","expectedPrefix","prefixedMessage","canPerformSessionCheck","sessionState","getSessionState","setupSessionCheckEventListener","removeSessionCheckEventListener","sessionCheckEventListener","origin","handleSessionUnchanged","handleSessionChange","handleSessionError","stopSessionCheckTimer","logOut","waitForSilentRefreshAfterSessionChange","startSessionCheckTimer","sessionCheckTimer","checkSession","bind","contentWindow","postMessage","loginHint","that","nonce","createAndSaveNonce","seperationChar","challenge","verifier","createChallangeVerifierPairForPKCE","initImplicitFlowInternal","additionalState","addParams","initImplicitFlow","resetImplicitFlow","callOnTokenReceivedIfExists","onTokenReceived","tokenParams","idClaims","idToken","expiresIn","grantedScopes","customParameters","expiresInMilliSeconds","expiresAt","getTime","forEach","tryLoginCodeFlow","tryLoginImplicitFlow","charAt","querySource","substring","search","parts","getCodePartsFromUrl","pathname","history","replaceState","name","nonceInState","userState","parseState","handleLoginError","saveRequestedRoute","disableOAuth2StateCheck","validateNonce","storeSessionState","getTokenFromCode","restoreRequestedRoute","requestedRoute","PKCEVerifier","fetchAndProcessToken","clearLocationHash","validationHandler","idx","savedNonce","idTokenClaimsJson","idTokenExpiresAt","onLoginError","getClockSkewInMsec","defaultSkewMsc","clockSkewInSec","skipNonceCheck","tokenParts","headerBase64","padBase64","headerJson","claimsBase64","claimsJson","aud","every","iat","iss","hasOwnProperty","issuedAtMSec","expiresAtMSec","exp","clockSkewInMSec","validationParams","loadKeys","checkSignature","idTokenHeaderJson","checkAtHash","atHashValid","atHashCheckEnabled","getGrantedScopes","scopes","base64data","getRefreshToken","parseInt","getCustomTokenResponseProperty","requestedProperty","authorizationHeader","noRedirectToLogoutUrl","customParam","postLogoutUrl","createNonce","ngOnDestroy","silentRefreshFrame","remove","sessionCheckFrame","unreserved","size","getRandomValues","x","random","validateSignature","initCodeFlow","initCodeFlowInternal","challengeRaw","foundParameters","recognizedParameter","revokeTokenAndLogout","ignoreCorsIssues","revokeEndpoint","revokeAccessToken","revokeRefreshToken","revokationParams","status","res","NgZone","HttpClient","decorators","OAuthModuleConfig","OAuthResourceServerConfig","OAuthResourceServerErrorHandler","OAuthNoopResourceServerErrorHandler","handleError","DefaultOAuthInterceptor","oAuthService","errorHandler","moduleConfig","checkUrl","resourceServer","customUrlValidation","allowedUrls","find","u","intercept","req","handle","sendAccessToken","token","clone","NullValidationHandler","createDefaultLogger","createDefaultStorage","OAuthModule","forRoot","validationHandlerClass","ngModule","providers","provide","useFactory","useClass","useValue","multi","ɵmod","ɵinj","imports","declarations","JwksValidationHandler","AUTH_CONFIG"],"mappings":"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","sourcesContent":["import * as i0 from '@angular/core';\nimport { Injectable, Optional, Inject, NgModule, InjectionToken } from '@angular/core';\nimport { DOCUMENT, CommonModule } from '@angular/common';\nimport * as i1 from '@angular/common/http';\nimport { HttpHeaders, HttpParams, HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { __awaiter } from 'tslib';\nimport { Subject, of, from, race, throwError, combineLatest, merge } from 'rxjs';\nimport { filter, tap, debounceTime, delay, switchMap, map, first, catchError, timeout, take, mergeMap } from 'rxjs/operators';\nimport fsha256 from 'fast-sha256';\n\nclass DateTimeProvider {\r\n}\r\nclass SystemDateTimeProvider extends DateTimeProvider {\r\n    now() {\r\n        return Date.now();\r\n    }\r\n    new() {\r\n        return new Date();\r\n    }\r\n}\r\nSystemDateTimeProvider.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: SystemDateTimeProvider, deps: null, target: i0.ɵɵFactoryTarget.Injectable });\r\nSystemDateTimeProvider.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: SystemDateTimeProvider });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: SystemDateTimeProvider, decorators: [{\r\n            type: Injectable\r\n        }] });\n\n/**\r\n * Additional options that can be passed to tryLogin.\r\n */\r\nclass LoginOptions {\r\n    constructor() {\r\n        /**\r\n         * Set this to true to disable the nonce\r\n         * check which is used to avoid\r\n         * replay attacks.\r\n         * This flag should never be true in\r\n         * production environments.\r\n         */\r\n        this.disableNonceCheck = false;\r\n        /**\r\n         * Normally, you want to clear your hash fragment after\r\n         * the lib read the token(s) so that they are not displayed\r\n         * anymore in the url. If not, set this to true. For code flow\r\n         * this controls removing query string values.\r\n         */\r\n        this.preventClearHashAfterLogin = false;\r\n    }\r\n}\r\n/**\r\n * Defines the logging interface the OAuthService uses\r\n * internally. Is compatible with the `console` object,\r\n * but you can provide your own implementation as well\r\n * through dependency injection.\r\n */\r\nclass OAuthLogger {\r\n}\r\n/**\r\n * Defines a simple storage that can be used for\r\n * storing the tokens at client side.\r\n * Is compatible to localStorage and sessionStorage,\r\n * but you can also create your own implementations.\r\n */\r\nclass OAuthStorage {\r\n}\r\nclass MemoryStorage {\r\n    constructor() {\r\n        this.data = new Map();\r\n    }\r\n    getItem(key) {\r\n        return this.data.get(key);\r\n    }\r\n    removeItem(key) {\r\n        this.data.delete(key);\r\n    }\r\n    setItem(key, data) {\r\n        this.data.set(key, data);\r\n    }\r\n}\r\nMemoryStorage.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: MemoryStorage, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\r\nMemoryStorage.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: MemoryStorage });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: MemoryStorage, decorators: [{\r\n            type: Injectable\r\n        }] });\r\n/**\r\n * Represents the received tokens, the received state\r\n * and the parsed claims from the id-token.\r\n */\r\nclass ReceivedTokens {\r\n}\n\nclass OAuthEvent {\r\n    constructor(type) {\r\n        this.type = type;\r\n    }\r\n}\r\nclass OAuthSuccessEvent extends OAuthEvent {\r\n    constructor(type, info = null) {\r\n        super(type);\r\n        this.info = info;\r\n    }\r\n}\r\nclass OAuthInfoEvent extends OAuthEvent {\r\n    constructor(type, info = null) {\r\n        super(type);\r\n        this.info = info;\r\n    }\r\n}\r\nclass OAuthErrorEvent extends OAuthEvent {\r\n    constructor(type, reason, params = null) {\r\n        super(type);\r\n        this.reason = reason;\r\n        this.params = params;\r\n    }\r\n}\n\n// see: https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_.22Unicode_Problem.22\r\nfunction b64DecodeUnicode(str) {\r\n    const base64 = str.replace(/\\-/g, '+').replace(/\\_/g, '/');\r\n    return decodeURIComponent(atob(base64)\r\n        .split('')\r\n        .map(function (c) {\r\n        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);\r\n    })\r\n        .join(''));\r\n}\r\nfunction base64UrlEncode(str) {\r\n    const base64 = btoa(str);\r\n    return base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\r\n}\n\nclass AuthConfig {\r\n    constructor(json) {\r\n        /**\r\n         * The client's id as registered with the auth server\r\n         */\r\n        this.clientId = '';\r\n        /**\r\n         * The client's redirectUri as registered with the auth server\r\n         */\r\n        this.redirectUri = '';\r\n        /**\r\n         * An optional second redirectUri where the auth server\r\n         * redirects the user to after logging out.\r\n         */\r\n        this.postLogoutRedirectUri = '';\r\n        /**\r\n         * Defines whether to use 'redirectUri' as a replacement\r\n         * of 'postLogoutRedirectUri' if the latter is not set.\r\n         */\r\n        this.redirectUriAsPostLogoutRedirectUriFallback = true;\r\n        /**\r\n         * The auth server's endpoint that allows to log\r\n         * the user in when using implicit flow.\r\n         */\r\n        this.loginUrl = '';\r\n        /**\r\n         * The requested scopes\r\n         */\r\n        this.scope = 'openid profile';\r\n        this.resource = '';\r\n        this.rngUrl = '';\r\n        /**\r\n         * Defines whether to use OpenId Connect during\r\n         * implicit flow.\r\n         */\r\n        this.oidc = true;\r\n        /**\r\n         * Defines whether to request an access token during\r\n         * implicit flow.\r\n         */\r\n        this.requestAccessToken = true;\r\n        this.options = null;\r\n        /**\r\n         * The issuer's uri.\r\n         */\r\n        this.issuer = '';\r\n        /**\r\n         * The logout url.\r\n         */\r\n        this.logoutUrl = '';\r\n        /**\r\n         * Defines whether to clear the hash fragment after logging in.\r\n         */\r\n        this.clearHashAfterLogin = true;\r\n        /**\r\n         * Url of the token endpoint as defined by OpenId Connect and OAuth 2.\r\n         */\r\n        this.tokenEndpoint = null;\r\n        /**\r\n         * Url of the revocation endpoint as defined by OpenId Connect and OAuth 2.\r\n         */\r\n        this.revocationEndpoint = null;\r\n        /**\r\n         * Names of known parameters sent out in the TokenResponse. https://tools.ietf.org/html/rfc6749#section-5.1\r\n         */\r\n        this.customTokenParameters = [];\r\n        /**\r\n         * Url of the userinfo endpoint as defined by OpenId Connect.\r\n         */\r\n        this.userinfoEndpoint = null;\r\n        this.responseType = '';\r\n        /**\r\n         * Defines whether additional debug information should\r\n         * be shown at the console. Note that in certain browsers\r\n         * the verbosity of the console needs to be explicitly set\r\n         * to include Debug level messages.\r\n         */\r\n        this.showDebugInformation = false;\r\n        /**\r\n         * The redirect uri used when doing silent refresh.\r\n         */\r\n        this.silentRefreshRedirectUri = '';\r\n        this.silentRefreshMessagePrefix = '';\r\n        /**\r\n         * Set this to true to display the iframe used for\r\n         * silent refresh for debugging.\r\n         */\r\n        this.silentRefreshShowIFrame = false;\r\n        /**\r\n         * Timeout for silent refresh.\r\n         * @internal\r\n         * depreacted b/c of typo, see silentRefreshTimeout\r\n         */\r\n        this.siletRefreshTimeout = 1000 * 20;\r\n        /**\r\n         * Timeout for silent refresh.\r\n         */\r\n        this.silentRefreshTimeout = 1000 * 20;\r\n        /**\r\n         * Some auth servers don't allow using password flow\r\n         * w/o a client secret while the standards do not\r\n         * demand for it. In this case, you can set a password\r\n         * here. As this password is exposed to the public\r\n         * it does not bring additional security and is therefore\r\n         * as good as using no password.\r\n         */\r\n        this.dummyClientSecret = null;\r\n        /**\r\n         * Defines whether https is required.\r\n         * The default value is remoteOnly which only allows\r\n         * http for localhost, while every other domains need\r\n         * to be used with https.\r\n         */\r\n        this.requireHttps = 'remoteOnly';\r\n        /**\r\n         * Defines whether every url provided by the discovery\r\n         * document has to start with the issuer's url.\r\n         */\r\n        this.strictDiscoveryDocumentValidation = true;\r\n        /**\r\n         * JSON Web Key Set (https://tools.ietf.org/html/rfc7517)\r\n         * with keys used to validate received id_tokens.\r\n         * This is taken out of the disovery document. Can be set manually too.\r\n         */\r\n        this.jwks = null;\r\n        /**\r\n         * Map with additional query parameter that are appended to\r\n         * the request when initializing implicit flow.\r\n         */\r\n        this.customQueryParams = null;\r\n        this.silentRefreshIFrameName = 'angular-oauth-oidc-silent-refresh-iframe';\r\n        /**\r\n         * Defines when the token_timeout event should be raised.\r\n         * If you set this to the default value 0.75, the event\r\n         * is triggered after 75% of the token's life time.\r\n         */\r\n        this.timeoutFactor = 0.75;\r\n        /**\r\n         * If true, the lib will try to check whether the user\r\n         * is still logged in on a regular basis as described\r\n         * in http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n         */\r\n        this.sessionChecksEnabled = false;\r\n        /**\r\n         * Interval in msec for checking the session\r\n         * according to http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification\r\n         */\r\n        this.sessionCheckIntervall = 3 * 1000;\r\n        /**\r\n         * Url for the iframe used for session checks\r\n         */\r\n        this.sessionCheckIFrameUrl = null;\r\n        /**\r\n         * Name of the iframe to use for session checks\r\n         */\r\n        this.sessionCheckIFrameName = 'angular-oauth-oidc-check-session-iframe';\r\n        /**\r\n         * This property has been introduced to disable at_hash checks\r\n         * and is indented for Identity Provider that does not deliver\r\n         * an at_hash EVEN THOUGH its recommended by the OIDC specs.\r\n         * Of course, when disabling these checks then we are bypassing\r\n         * a security check which means we are more vulnerable.\r\n         */\r\n        this.disableAtHashCheck = false;\r\n        /**\r\n         * Defines wether to check the subject of a refreshed token after silent refresh.\r\n         * Normally, it should be the same as before.\r\n         */\r\n        this.skipSubjectCheck = false;\r\n        this.useIdTokenHintForSilentRefresh = false;\r\n        /**\r\n         * Defined whether to skip the validation of the issuer in the discovery document.\r\n         * Normally, the discovey document's url starts with the url of the issuer.\r\n         */\r\n        this.skipIssuerCheck = false;\r\n        /**\r\n         * final state sent to issuer is built as follows:\r\n         * state = nonce + nonceStateSeparator + additional state\r\n         * Default separator is ';' (encoded %3B).\r\n         * In rare cases, this character might be forbidden or inconvenient to use by the issuer so it can be customized.\r\n         */\r\n        this.nonceStateSeparator = ';';\r\n        /**\r\n         * Set this to true to use HTTP BASIC auth for AJAX calls\r\n         */\r\n        this.useHttpBasicAuth = false;\r\n        /**\r\n         * The interceptors waits this time span if there is no token\r\n         */\r\n        this.waitForTokenInMsec = 0;\r\n        /**\r\n         * Code Flow is by defauld used together with PKCI which is also higly recommented.\r\n         * You can disbale it here by setting this flag to true.\r\n         * https://tools.ietf.org/html/rfc7636#section-1.1\r\n         */\r\n        this.disablePKCE = false;\r\n        /**\r\n         * Set this to true to preserve the requested route including query parameters after code flow login.\r\n         * This setting enables deep linking for the code flow.\r\n         */\r\n        this.preserveRequestedRoute = false;\r\n        /**\r\n         * This property allows you to override the method that is used to open the login url,\r\n         * allowing a way for implementations to specify their own method of routing to new\r\n         * urls.\r\n         */\r\n        this.openUri = (uri) => {\r\n            location.href = uri;\r\n        };\r\n        if (json) {\r\n            Object.assign(this, json);\r\n        }\r\n    }\r\n}\n\n/**\r\n * This custom encoder allows charactes like +, % and / to be used in passwords\r\n */\r\nclass WebHttpUrlEncodingCodec {\r\n    encodeKey(k) {\r\n        return encodeURIComponent(k);\r\n    }\r\n    encodeValue(v) {\r\n        return encodeURIComponent(v);\r\n    }\r\n    decodeKey(k) {\r\n        return decodeURIComponent(k);\r\n    }\r\n    decodeValue(v) {\r\n        return decodeURIComponent(v);\r\n    }\r\n}\n\n/**\r\n * Interface for Handlers that are hooked in to\r\n * validate tokens.\r\n */\r\nclass ValidationHandler {\r\n}\r\n/**\r\n * This abstract implementation of ValidationHandler already implements\r\n * the method validateAtHash. However, to make use of it,\r\n * you have to override the method calcHash.\r\n */\r\nclass AbstractValidationHandler {\r\n    /**\r\n     * Validates the at_hash in an id_token against the received access_token.\r\n     */\r\n    validateAtHash(params) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            let hashAlg = this.inferHashAlgorithm(params.idTokenHeader);\r\n            let tokenHash = yield this.calcHash(params.accessToken, hashAlg); // sha256(accessToken, { asString: true });\r\n            let leftMostHalf = tokenHash.substr(0, tokenHash.length / 2);\r\n            let atHash = base64UrlEncode(leftMostHalf);\r\n            let claimsAtHash = params.idTokenClaims['at_hash'].replace(/=/g, '');\r\n            if (atHash !== claimsAtHash) {\r\n                console.error('exptected at_hash: ' + atHash);\r\n                console.error('actual at_hash: ' + claimsAtHash);\r\n            }\r\n            return atHash === claimsAtHash;\r\n        });\r\n    }\r\n    /**\r\n     * Infers the name of the hash algorithm to use\r\n     * from the alg field of an id_token.\r\n     *\r\n     * @param jwtHeader the id_token's parsed header\r\n     */\r\n    inferHashAlgorithm(jwtHeader) {\r\n        let alg = jwtHeader['alg'];\r\n        if (!alg.match(/^.S[0-9]{3}$/)) {\r\n            throw new Error('Algorithm not supported: ' + alg);\r\n        }\r\n        return 'sha-' + alg.substr(2);\r\n    }\r\n}\n\nclass UrlHelperService {\r\n    getHashFragmentParams(customHashFragment) {\r\n        let hash = customHashFragment || window.location.hash;\r\n        hash = decodeURIComponent(hash);\r\n        if (hash.indexOf('#') !== 0) {\r\n            return {};\r\n        }\r\n        const questionMarkPosition = hash.indexOf('?');\r\n        if (questionMarkPosition > -1) {\r\n            hash = hash.substr(questionMarkPosition + 1);\r\n        }\r\n        else {\r\n            hash = hash.substr(1);\r\n        }\r\n        return this.parseQueryString(hash);\r\n    }\r\n    parseQueryString(queryString) {\r\n        const data = {};\r\n        let pairs, pair, separatorIndex, escapedKey, escapedValue, key, value;\r\n        if (queryString === null) {\r\n            return data;\r\n        }\r\n        pairs = queryString.split('&');\r\n        for (let i = 0; i < pairs.length; i++) {\r\n            pair = pairs[i];\r\n            separatorIndex = pair.indexOf('=');\r\n            if (separatorIndex === -1) {\r\n                escapedKey = pair;\r\n                escapedValue = null;\r\n            }\r\n            else {\r\n                escapedKey = pair.substr(0, separatorIndex);\r\n                escapedValue = pair.substr(separatorIndex + 1);\r\n            }\r\n            key = decodeURIComponent(escapedKey);\r\n            value = decodeURIComponent(escapedValue);\r\n            if (key.substr(0, 1) === '/') {\r\n                key = key.substr(1);\r\n            }\r\n            data[key] = value;\r\n        }\r\n        return data;\r\n    }\r\n}\r\nUrlHelperService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: UrlHelperService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\r\nUrlHelperService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: UrlHelperService });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: UrlHelperService, decorators: [{\r\n            type: Injectable\r\n        }] });\n\n/**\r\n * [js-sha256]{@link https://github.com/emn178/js-sha256}\r\n *\r\n * @version 0.9.0\r\n * @author Chen, Yi-Cyuan [emn178@gmail.com]\r\n * @copyright Chen, Yi-Cyuan 2014-2017\r\n * @license MIT\r\n */\r\n/*jslint bitwise: true */\r\nfunction factory() {\r\n    var ERROR = 'input is invalid type';\r\n    var WINDOW = typeof window === 'object';\r\n    var root = WINDOW ? window : {};\r\n    if (root.JS_SHA256_NO_WINDOW) {\r\n        WINDOW = false;\r\n    }\r\n    var WEB_WORKER = !WINDOW && typeof self === 'object';\r\n    var NODE_JS = !root.JS_SHA256_NO_NODE_JS && typeof process === 'object' && process.versions && process.versions.node;\r\n    if (NODE_JS) {\r\n        root = global;\r\n    }\r\n    else if (WEB_WORKER) {\r\n        root = self;\r\n    }\r\n    var COMMON_JS = !root.JS_SHA256_NO_COMMON_JS && typeof module === 'object' && module.exports;\r\n    var AMD = typeof define === 'function' && define.amd;\r\n    var ARRAY_BUFFER = !root.JS_SHA256_NO_ARRAY_BUFFER && typeof ArrayBuffer !== 'undefined';\r\n    const HEX_CHARS = '0123456789abcdef'.split('');\r\n    const EXTRA = [-2147483648, 8388608, 32768, 128];\r\n    const SHIFT = [24, 16, 8, 0];\r\n    const K = [\r\n        0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,\r\n        0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,\r\n        0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,\r\n        0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,\r\n        0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,\r\n        0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,\r\n        0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,\r\n        0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2\r\n    ];\r\n    const OUTPUT_TYPES = ['hex', 'array', 'digest', 'arrayBuffer'];\r\n    var blocks = [];\r\n    if (root.JS_SHA256_NO_NODE_JS || !Array.isArray) {\r\n        Array.isArray = function (obj) {\r\n            return Object.prototype.toString.call(obj) === '[object Array]';\r\n        };\r\n    }\r\n    if (ARRAY_BUFFER && (root.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW || !ArrayBuffer.isView)) {\r\n        ArrayBuffer.isView = function (obj) {\r\n            return typeof obj === 'object' && obj.buffer && obj.buffer.constructor === ArrayBuffer;\r\n        };\r\n    }\r\n    var createOutputMethod = function (outputType, is224) {\r\n        return function (message) {\r\n            return new Sha256(is224, true).update(message)[outputType]();\r\n        };\r\n    };\r\n    var createMethod = function (is224) {\r\n        var method = createOutputMethod('hex', is224);\r\n        if (NODE_JS) {\r\n            method = nodeWrap(method, is224);\r\n        }\r\n        method.create = function () {\r\n            return new Sha256(is224);\r\n        };\r\n        method.update = function (message) {\r\n            return method.create().update(message);\r\n        };\r\n        for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\r\n            var type = OUTPUT_TYPES[i];\r\n            method[type] = createOutputMethod(type, is224);\r\n        }\r\n        return method;\r\n    };\r\n    var nodeWrap = function (method, is224) {\r\n        var crypto = eval(\"require('crypto')\");\r\n        var Buffer = eval(\"require('buffer').Buffer\");\r\n        var algorithm = is224 ? 'sha224' : 'sha256';\r\n        var nodeMethod = function (message) {\r\n            if (typeof message === 'string') {\r\n                return crypto.createHash(algorithm).update(message, 'utf8').digest('hex');\r\n            }\r\n            else {\r\n                if (message === null || message === undefined) {\r\n                    throw new Error(ERROR);\r\n                }\r\n                else if (message.constructor === ArrayBuffer) {\r\n                    message = new Uint8Array(message);\r\n                }\r\n            }\r\n            if (Array.isArray(message) || ArrayBuffer.isView(message) ||\r\n                message.constructor === Buffer) {\r\n                return crypto.createHash(algorithm).update(new Buffer(message)).digest('hex');\r\n            }\r\n            else {\r\n                return method(message);\r\n            }\r\n        };\r\n        return nodeMethod;\r\n    };\r\n    var createHmacOutputMethod = function (outputType, is224) {\r\n        return function (key, message) {\r\n            return new HmacSha256(key, is224, true).update(message)[outputType]();\r\n        };\r\n    };\r\n    var createHmacMethod = function (is224) {\r\n        var method = createHmacOutputMethod('hex', is224);\r\n        method.create = function (key) {\r\n            return new HmacSha256(key, is224);\r\n        };\r\n        method.update = function (key, message) {\r\n            return method.create(key).update(message);\r\n        };\r\n        for (var i = 0; i < OUTPUT_TYPES.length; ++i) {\r\n            var type = OUTPUT_TYPES[i];\r\n            method[type] = createHmacOutputMethod(type, is224);\r\n        }\r\n        return method;\r\n    };\r\n    function Sha256(is224, sharedMemory) {\r\n        if (sharedMemory) {\r\n            blocks[0] = blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n                blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n                    blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n                        blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n            this.blocks = blocks;\r\n        }\r\n        else {\r\n            this.blocks = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\r\n        }\r\n        if (is224) {\r\n            this.h0 = 0xc1059ed8;\r\n            this.h1 = 0x367cd507;\r\n            this.h2 = 0x3070dd17;\r\n            this.h3 = 0xf70e5939;\r\n            this.h4 = 0xffc00b31;\r\n            this.h5 = 0x68581511;\r\n            this.h6 = 0x64f98fa7;\r\n            this.h7 = 0xbefa4fa4;\r\n        }\r\n        else { // 256\r\n            this.h0 = 0x6a09e667;\r\n            this.h1 = 0xbb67ae85;\r\n            this.h2 = 0x3c6ef372;\r\n            this.h3 = 0xa54ff53a;\r\n            this.h4 = 0x510e527f;\r\n            this.h5 = 0x9b05688c;\r\n            this.h6 = 0x1f83d9ab;\r\n            this.h7 = 0x5be0cd19;\r\n        }\r\n        this.block = this.start = this.bytes = this.hBytes = 0;\r\n        this.finalized = this.hashed = false;\r\n        this.first = true;\r\n        this.is224 = is224;\r\n    }\r\n    Sha256.prototype.update = function (message) {\r\n        if (this.finalized) {\r\n            return;\r\n        }\r\n        var notString, type = typeof message;\r\n        if (type !== 'string') {\r\n            if (type === 'object') {\r\n                if (message === null) {\r\n                    throw new Error(ERROR);\r\n                }\r\n                else if (ARRAY_BUFFER && message.constructor === ArrayBuffer) {\r\n                    message = new Uint8Array(message);\r\n                }\r\n                else if (!Array.isArray(message)) {\r\n                    if (!ARRAY_BUFFER || !ArrayBuffer.isView(message)) {\r\n                        throw new Error(ERROR);\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                throw new Error(ERROR);\r\n            }\r\n            notString = true;\r\n        }\r\n        var code, index = 0, i, length = message.length, blocks = this.blocks;\r\n        while (index < length) {\r\n            if (this.hashed) {\r\n                this.hashed = false;\r\n                blocks[0] = this.block;\r\n                blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n                    blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n                        blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n                            blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n            }\r\n            if (notString) {\r\n                for (i = this.start; index < length && i < 64; ++index) {\r\n                    blocks[i >> 2] |= message[index] << SHIFT[i++ & 3];\r\n                }\r\n            }\r\n            else {\r\n                for (i = this.start; index < length && i < 64; ++index) {\r\n                    code = message.charCodeAt(index);\r\n                    if (code < 0x80) {\r\n                        blocks[i >> 2] |= code << SHIFT[i++ & 3];\r\n                    }\r\n                    else if (code < 0x800) {\r\n                        blocks[i >> 2] |= (0xc0 | (code >> 6)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n                    }\r\n                    else if (code < 0xd800 || code >= 0xe000) {\r\n                        blocks[i >> 2] |= (0xe0 | (code >> 12)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | ((code >> 6) & 0x3f)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n                    }\r\n                    else {\r\n                        code = 0x10000 + (((code & 0x3ff) << 10) | (message.charCodeAt(++index) & 0x3ff));\r\n                        blocks[i >> 2] |= (0xf0 | (code >> 18)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | ((code >> 12) & 0x3f)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | ((code >> 6) & 0x3f)) << SHIFT[i++ & 3];\r\n                        blocks[i >> 2] |= (0x80 | (code & 0x3f)) << SHIFT[i++ & 3];\r\n                    }\r\n                }\r\n            }\r\n            this.lastByteIndex = i;\r\n            this.bytes += i - this.start;\r\n            if (i >= 64) {\r\n                this.block = blocks[16];\r\n                this.start = i - 64;\r\n                this.hash();\r\n                this.hashed = true;\r\n            }\r\n            else {\r\n                this.start = i;\r\n            }\r\n        }\r\n        if (this.bytes > 4294967295) {\r\n            this.hBytes += this.bytes / 4294967296 << 0;\r\n            this.bytes = this.bytes % 4294967296;\r\n        }\r\n        return this;\r\n    };\r\n    Sha256.prototype.finalize = function () {\r\n        if (this.finalized) {\r\n            return;\r\n        }\r\n        this.finalized = true;\r\n        var blocks = this.blocks, i = this.lastByteIndex;\r\n        blocks[16] = this.block;\r\n        blocks[i >> 2] |= EXTRA[i & 3];\r\n        this.block = blocks[16];\r\n        if (i >= 56) {\r\n            if (!this.hashed) {\r\n                this.hash();\r\n            }\r\n            blocks[0] = this.block;\r\n            blocks[16] = blocks[1] = blocks[2] = blocks[3] =\r\n                blocks[4] = blocks[5] = blocks[6] = blocks[7] =\r\n                    blocks[8] = blocks[9] = blocks[10] = blocks[11] =\r\n                        blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;\r\n        }\r\n        blocks[14] = this.hBytes << 3 | this.bytes >>> 29;\r\n        blocks[15] = this.bytes << 3;\r\n        this.hash();\r\n    };\r\n    Sha256.prototype.hash = function () {\r\n        var a = this.h0, b = this.h1, c = this.h2, d = this.h3, e = this.h4, f = this.h5, g = this.h6, h = this.h7, blocks = this.blocks, j, s0, s1, maj, t1, t2, ch, ab, da, cd, bc;\r\n        for (j = 16; j < 64; ++j) {\r\n            // rightrotate\r\n            t1 = blocks[j - 15];\r\n            s0 = ((t1 >>> 7) | (t1 << 25)) ^ ((t1 >>> 18) | (t1 << 14)) ^ (t1 >>> 3);\r\n            t1 = blocks[j - 2];\r\n            s1 = ((t1 >>> 17) | (t1 << 15)) ^ ((t1 >>> 19) | (t1 << 13)) ^ (t1 >>> 10);\r\n            blocks[j] = blocks[j - 16] + s0 + blocks[j - 7] + s1 << 0;\r\n        }\r\n        bc = b & c;\r\n        for (j = 0; j < 64; j += 4) {\r\n            if (this.first) {\r\n                if (this.is224) {\r\n                    ab = 300032;\r\n                    t1 = blocks[0] - 1413257819;\r\n                    h = t1 - 150054599 << 0;\r\n                    d = t1 + 24177077 << 0;\r\n                }\r\n                else {\r\n                    ab = 704751109;\r\n                    t1 = blocks[0] - 210244248;\r\n                    h = t1 - 1521486534 << 0;\r\n                    d = t1 + 143694565 << 0;\r\n                }\r\n                this.first = false;\r\n            }\r\n            else {\r\n                s0 = ((a >>> 2) | (a << 30)) ^ ((a >>> 13) | (a << 19)) ^ ((a >>> 22) | (a << 10));\r\n                s1 = ((e >>> 6) | (e << 26)) ^ ((e >>> 11) | (e << 21)) ^ ((e >>> 25) | (e << 7));\r\n                ab = a & b;\r\n                maj = ab ^ (a & c) ^ bc;\r\n                ch = (e & f) ^ (~e & g);\r\n                t1 = h + s1 + ch + K[j] + blocks[j];\r\n                t2 = s0 + maj;\r\n                h = d + t1 << 0;\r\n                d = t1 + t2 << 0;\r\n            }\r\n            s0 = ((d >>> 2) | (d << 30)) ^ ((d >>> 13) | (d << 19)) ^ ((d >>> 22) | (d << 10));\r\n            s1 = ((h >>> 6) | (h << 26)) ^ ((h >>> 11) | (h << 21)) ^ ((h >>> 25) | (h << 7));\r\n            da = d & a;\r\n            maj = da ^ (d & b) ^ ab;\r\n            ch = (h & e) ^ (~h & f);\r\n            t1 = g + s1 + ch + K[j + 1] + blocks[j + 1];\r\n            t2 = s0 + maj;\r\n            g = c + t1 << 0;\r\n            c = t1 + t2 << 0;\r\n            s0 = ((c >>> 2) | (c << 30)) ^ ((c >>> 13) | (c << 19)) ^ ((c >>> 22) | (c << 10));\r\n            s1 = ((g >>> 6) | (g << 26)) ^ ((g >>> 11) | (g << 21)) ^ ((g >>> 25) | (g << 7));\r\n            cd = c & d;\r\n            maj = cd ^ (c & a) ^ da;\r\n            ch = (g & h) ^ (~g & e);\r\n            t1 = f + s1 + ch + K[j + 2] + blocks[j + 2];\r\n            t2 = s0 + maj;\r\n            f = b + t1 << 0;\r\n            b = t1 + t2 << 0;\r\n            s0 = ((b >>> 2) | (b << 30)) ^ ((b >>> 13) | (b << 19)) ^ ((b >>> 22) | (b << 10));\r\n            s1 = ((f >>> 6) | (f << 26)) ^ ((f >>> 11) | (f << 21)) ^ ((f >>> 25) | (f << 7));\r\n            bc = b & c;\r\n            maj = bc ^ (b & d) ^ cd;\r\n            ch = (f & g) ^ (~f & h);\r\n            t1 = e + s1 + ch + K[j + 3] + blocks[j + 3];\r\n            t2 = s0 + maj;\r\n            e = a + t1 << 0;\r\n            a = t1 + t2 << 0;\r\n        }\r\n        this.h0 = this.h0 + a << 0;\r\n        this.h1 = this.h1 + b << 0;\r\n        this.h2 = this.h2 + c << 0;\r\n        this.h3 = this.h3 + d << 0;\r\n        this.h4 = this.h4 + e << 0;\r\n        this.h5 = this.h5 + f << 0;\r\n        this.h6 = this.h6 + g << 0;\r\n        this.h7 = this.h7 + h << 0;\r\n    };\r\n    Sha256.prototype.hex = function () {\r\n        this.finalize();\r\n        var h0 = this.h0, h1 = this.h1, h2 = this.h2, h3 = this.h3, h4 = this.h4, h5 = this.h5, h6 = this.h6, h7 = this.h7;\r\n        var hex = HEX_CHARS[(h0 >> 28) & 0x0F] + HEX_CHARS[(h0 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h0 >> 20) & 0x0F] + HEX_CHARS[(h0 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h0 >> 12) & 0x0F] + HEX_CHARS[(h0 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h0 >> 4) & 0x0F] + HEX_CHARS[h0 & 0x0F] +\r\n            HEX_CHARS[(h1 >> 28) & 0x0F] + HEX_CHARS[(h1 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h1 >> 20) & 0x0F] + HEX_CHARS[(h1 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h1 >> 12) & 0x0F] + HEX_CHARS[(h1 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h1 >> 4) & 0x0F] + HEX_CHARS[h1 & 0x0F] +\r\n            HEX_CHARS[(h2 >> 28) & 0x0F] + HEX_CHARS[(h2 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h2 >> 20) & 0x0F] + HEX_CHARS[(h2 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h2 >> 12) & 0x0F] + HEX_CHARS[(h2 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h2 >> 4) & 0x0F] + HEX_CHARS[h2 & 0x0F] +\r\n            HEX_CHARS[(h3 >> 28) & 0x0F] + HEX_CHARS[(h3 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h3 >> 20) & 0x0F] + HEX_CHARS[(h3 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h3 >> 12) & 0x0F] + HEX_CHARS[(h3 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h3 >> 4) & 0x0F] + HEX_CHARS[h3 & 0x0F] +\r\n            HEX_CHARS[(h4 >> 28) & 0x0F] + HEX_CHARS[(h4 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h4 >> 20) & 0x0F] + HEX_CHARS[(h4 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h4 >> 12) & 0x0F] + HEX_CHARS[(h4 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h4 >> 4) & 0x0F] + HEX_CHARS[h4 & 0x0F] +\r\n            HEX_CHARS[(h5 >> 28) & 0x0F] + HEX_CHARS[(h5 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h5 >> 20) & 0x0F] + HEX_CHARS[(h5 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h5 >> 12) & 0x0F] + HEX_CHARS[(h5 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h5 >> 4) & 0x0F] + HEX_CHARS[h5 & 0x0F] +\r\n            HEX_CHARS[(h6 >> 28) & 0x0F] + HEX_CHARS[(h6 >> 24) & 0x0F] +\r\n            HEX_CHARS[(h6 >> 20) & 0x0F] + HEX_CHARS[(h6 >> 16) & 0x0F] +\r\n            HEX_CHARS[(h6 >> 12) & 0x0F] + HEX_CHARS[(h6 >> 8) & 0x0F] +\r\n            HEX_CHARS[(h6 >> 4) & 0x0F] + HEX_CHARS[h6 & 0x0F];\r\n        if (!this.is224) {\r\n            hex += HEX_CHARS[(h7 >> 28) & 0x0F] + HEX_CHARS[(h7 >> 24) & 0x0F] +\r\n                HEX_CHARS[(h7 >> 20) & 0x0F] + HEX_CHARS[(h7 >> 16) & 0x0F] +\r\n                HEX_CHARS[(h7 >> 12) & 0x0F] + HEX_CHARS[(h7 >> 8) & 0x0F] +\r\n                HEX_CHARS[(h7 >> 4) & 0x0F] + HEX_CHARS[h7 & 0x0F];\r\n        }\r\n        return hex;\r\n    };\r\n    Sha256.prototype.toString = Sha256.prototype.hex;\r\n    Sha256.prototype.digest = function () {\r\n        this.finalize();\r\n        var h0 = this.h0, h1 = this.h1, h2 = this.h2, h3 = this.h3, h4 = this.h4, h5 = this.h5, h6 = this.h6, h7 = this.h7;\r\n        var arr = [\r\n            (h0 >> 24) & 0xFF, (h0 >> 16) & 0xFF, (h0 >> 8) & 0xFF, h0 & 0xFF,\r\n            (h1 >> 24) & 0xFF, (h1 >> 16) & 0xFF, (h1 >> 8) & 0xFF, h1 & 0xFF,\r\n            (h2 >> 24) & 0xFF, (h2 >> 16) & 0xFF, (h2 >> 8) & 0xFF, h2 & 0xFF,\r\n            (h3 >> 24) & 0xFF, (h3 >> 16) & 0xFF, (h3 >> 8) & 0xFF, h3 & 0xFF,\r\n            (h4 >> 24) & 0xFF, (h4 >> 16) & 0xFF, (h4 >> 8) & 0xFF, h4 & 0xFF,\r\n            (h5 >> 24) & 0xFF, (h5 >> 16) & 0xFF, (h5 >> 8) & 0xFF, h5 & 0xFF,\r\n            (h6 >> 24) & 0xFF, (h6 >> 16) & 0xFF, (h6 >> 8) & 0xFF, h6 & 0xFF\r\n        ];\r\n        if (!this.is224) {\r\n            arr.push((h7 >> 24) & 0xFF, (h7 >> 16) & 0xFF, (h7 >> 8) & 0xFF, h7 & 0xFF);\r\n        }\r\n        return arr;\r\n    };\r\n    Sha256.prototype.array = Sha256.prototype.digest;\r\n    Sha256.prototype.arrayBuffer = function () {\r\n        this.finalize();\r\n        var buffer = new ArrayBuffer(this.is224 ? 28 : 32);\r\n        var dataView = new DataView(buffer);\r\n        dataView.setUint32(0, this.h0);\r\n        dataView.setUint32(4, this.h1);\r\n        dataView.setUint32(8, this.h2);\r\n        dataView.setUint32(12, this.h3);\r\n        dataView.setUint32(16, this.h4);\r\n        dataView.setUint32(20, this.h5);\r\n        dataView.setUint32(24, this.h6);\r\n        if (!this.is224) {\r\n            dataView.setUint32(28, this.h7);\r\n        }\r\n        return buffer;\r\n    };\r\n    function HmacSha256(key, is224, sharedMemory) {\r\n        var i, type = typeof key;\r\n        if (type === 'string') {\r\n            var bytes = [], length = key.length, index = 0, code;\r\n            for (i = 0; i < length; ++i) {\r\n                code = key.charCodeAt(i);\r\n                if (code < 0x80) {\r\n                    bytes[index++] = code;\r\n                }\r\n                else if (code < 0x800) {\r\n                    bytes[index++] = (0xc0 | (code >> 6));\r\n                    bytes[index++] = (0x80 | (code & 0x3f));\r\n                }\r\n                else if (code < 0xd800 || code >= 0xe000) {\r\n                    bytes[index++] = (0xe0 | (code >> 12));\r\n                    bytes[index++] = (0x80 | ((code >> 6) & 0x3f));\r\n                    bytes[index++] = (0x80 | (code & 0x3f));\r\n                }\r\n                else {\r\n                    code = 0x10000 + (((code & 0x3ff) << 10) | (key.charCodeAt(++i) & 0x3ff));\r\n                    bytes[index++] = (0xf0 | (code >> 18));\r\n                    bytes[index++] = (0x80 | ((code >> 12) & 0x3f));\r\n                    bytes[index++] = (0x80 | ((code >> 6) & 0x3f));\r\n                    bytes[index++] = (0x80 | (code & 0x3f));\r\n                }\r\n            }\r\n            key = bytes;\r\n        }\r\n        else {\r\n            if (type === 'object') {\r\n                if (key === null) {\r\n                    throw new Error(ERROR);\r\n                }\r\n                else if (ARRAY_BUFFER && key.constructor === ArrayBuffer) {\r\n                    key = new Uint8Array(key);\r\n                }\r\n                else if (!Array.isArray(key)) {\r\n                    if (!ARRAY_BUFFER || !ArrayBuffer.isView(key)) {\r\n                        throw new Error(ERROR);\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                throw new Error(ERROR);\r\n            }\r\n        }\r\n        if (key.length > 64) {\r\n            key = (new Sha256(is224, true)).update(key).array();\r\n        }\r\n        var oKeyPad = [], iKeyPad = [];\r\n        for (i = 0; i < 64; ++i) {\r\n            var b = key[i] || 0;\r\n            oKeyPad[i] = 0x5c ^ b;\r\n            iKeyPad[i] = 0x36 ^ b;\r\n        }\r\n        Sha256.call(this, is224, sharedMemory);\r\n        this.update(iKeyPad);\r\n        this.oKeyPad = oKeyPad;\r\n        this.inner = true;\r\n        this.sharedMemory = sharedMemory;\r\n    }\r\n    HmacSha256.prototype = new Sha256();\r\n    HmacSha256.prototype.finalize = function () {\r\n        Sha256.prototype.finalize.call(this);\r\n        if (this.inner) {\r\n            this.inner = false;\r\n            var innerHash = this.array();\r\n            Sha256.call(this, this.is224, this.sharedMemory);\r\n            this.update(this.oKeyPad);\r\n            this.update(innerHash);\r\n            Sha256.prototype.finalize.call(this);\r\n        }\r\n    };\r\n    var exports = createMethod();\r\n    exports.sha256 = exports;\r\n    exports.sha224 = createMethod(true);\r\n    exports.sha256.hmac = createHmacMethod();\r\n    exports.sha224.hmac = createHmacMethod(true);\r\n    return exports;\r\n}\n\nconst sha256 = factory();\r\n/**\r\n * Abstraction for crypto algorithms\r\n */\r\nclass HashHandler {\r\n}\r\nfunction decodeUTF8(s) {\r\n    if (typeof s !== 'string')\r\n        throw new TypeError('expected string');\r\n    var i, d = s, b = new Uint8Array(d.length);\r\n    for (i = 0; i < d.length; i++)\r\n        b[i] = d.charCodeAt(i);\r\n    return b;\r\n}\r\nfunction encodeUTF8(arr) {\r\n    var i, s = [];\r\n    for (i = 0; i < arr.length; i++)\r\n        s.push(String.fromCharCode(arr[i]));\r\n    return s.join('');\r\n}\r\nclass DefaultHashHandler {\r\n    calcHash(valueToHash, algorithm) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            // const encoder = new TextEncoder();\r\n            // const hashArray = await window.crypto.subtle.digest(algorithm, data);\r\n            // const data = encoder.encode(valueToHash);\r\n            // const fhash = fsha256(valueToHash);\r\n            const candHash = encodeUTF8(fsha256(decodeUTF8(valueToHash)));\r\n            // const hashArray = (sha256 as any).array(valueToHash);\r\n            // // const hashString = this.toHashString(hashArray);\r\n            // const hashString = this.toHashString2(hashArray);\r\n            // console.debug('hash orig - cand', candHash, hashString);\r\n            // alert(1);\r\n            return candHash;\r\n        });\r\n    }\r\n    toHashString2(byteArray) {\r\n        let result = '';\r\n        for (let e of byteArray) {\r\n            result += String.fromCharCode(e);\r\n        }\r\n        return result;\r\n    }\r\n    toHashString(buffer) {\r\n        const byteArray = new Uint8Array(buffer);\r\n        let result = '';\r\n        for (let e of byteArray) {\r\n            result += String.fromCharCode(e);\r\n        }\r\n        return result;\r\n    }\r\n}\r\nDefaultHashHandler.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultHashHandler, deps: [], target: i0.ɵɵFactoryTarget.Injectable });\r\nDefaultHashHandler.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultHashHandler });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultHashHandler, decorators: [{\r\n            type: Injectable\r\n        }] });\n\n/**\r\n * Service for logging in and logging out with\r\n * OIDC and OAuth2. Supports implicit flow and\r\n * password flow.\r\n */\r\nclass OAuthService extends AuthConfig {\r\n    constructor(ngZone, http, storage, tokenValidationHandler, config, urlHelper, logger, crypto, document, dateTimeService) {\r\n        var _a;\r\n        super();\r\n        this.ngZone = ngZone;\r\n        this.http = http;\r\n        this.config = config;\r\n        this.urlHelper = urlHelper;\r\n        this.logger = logger;\r\n        this.crypto = crypto;\r\n        this.dateTimeService = dateTimeService;\r\n        /**\r\n         * @internal\r\n         * Deprecated:  use property events instead\r\n         */\r\n        this.discoveryDocumentLoaded = false;\r\n        /**\r\n         * The received (passed around) state, when logging\r\n         * in with implicit flow.\r\n         */\r\n        this.state = '';\r\n        this.eventsSubject = new Subject();\r\n        this.discoveryDocumentLoadedSubject = new Subject();\r\n        this.grantTypesSupported = [];\r\n        this.inImplicitFlow = false;\r\n        this.saveNoncesInLocalStorage = false;\r\n        this.debug('angular-oauth2-oidc v10');\r\n        // See https://github.com/manfredsteyer/angular-oauth2-oidc/issues/773 for why this is needed\r\n        this.document = document;\r\n        if (!config) {\r\n            config = {};\r\n        }\r\n        this.discoveryDocumentLoaded$ =\r\n            this.discoveryDocumentLoadedSubject.asObservable();\r\n        this.events = this.eventsSubject.asObservable();\r\n        if (tokenValidationHandler) {\r\n            this.tokenValidationHandler = tokenValidationHandler;\r\n        }\r\n        if (config) {\r\n            this.configure(config);\r\n        }\r\n        try {\r\n            if (storage) {\r\n                this.setStorage(storage);\r\n            }\r\n            else if (typeof sessionStorage !== 'undefined') {\r\n                this.setStorage(sessionStorage);\r\n            }\r\n        }\r\n        catch (e) {\r\n            console.error('No OAuthStorage provided and cannot access default (sessionStorage).' +\r\n                'Consider providing a custom OAuthStorage implementation in your module.', e);\r\n        }\r\n        // in IE, sessionStorage does not always survive a redirect\r\n        if (this.checkLocalStorageAccessable()) {\r\n            const ua = (_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent;\r\n            const msie = (ua === null || ua === void 0 ? void 0 : ua.includes('MSIE ')) || (ua === null || ua === void 0 ? void 0 : ua.includes('Trident'));\r\n            if (msie) {\r\n                this.saveNoncesInLocalStorage = true;\r\n            }\r\n        }\r\n        this.setupRefreshTimer();\r\n    }\r\n    checkLocalStorageAccessable() {\r\n        if (typeof window === 'undefined')\r\n            return false;\r\n        const test = 'test';\r\n        try {\r\n            if (typeof window['localStorage'] === 'undefined')\r\n                return false;\r\n            localStorage.setItem(test, test);\r\n            localStorage.removeItem(test);\r\n            return true;\r\n        }\r\n        catch (e) {\r\n            return false;\r\n        }\r\n    }\r\n    /**\r\n     * Use this method to configure the service\r\n     * @param config the configuration\r\n     */\r\n    configure(config) {\r\n        // For the sake of downward compatibility with\r\n        // original configuration API\r\n        Object.assign(this, new AuthConfig(), config);\r\n        this.config = Object.assign({}, new AuthConfig(), config);\r\n        if (this.sessionChecksEnabled) {\r\n            this.setupSessionCheck();\r\n        }\r\n        this.configChanged();\r\n    }\r\n    configChanged() {\r\n        this.setupRefreshTimer();\r\n    }\r\n    restartSessionChecksIfStillLoggedIn() {\r\n        if (this.hasValidIdToken()) {\r\n            this.initSessionCheck();\r\n        }\r\n    }\r\n    restartRefreshTimerIfStillLoggedIn() {\r\n        this.setupExpirationTimers();\r\n    }\r\n    setupSessionCheck() {\r\n        this.events\r\n            .pipe(filter((e) => e.type === 'token_received'))\r\n            .subscribe((e) => {\r\n            this.initSessionCheck();\r\n        });\r\n    }\r\n    /**\r\n     * Will setup up silent refreshing for when the token is\r\n     * about to expire. When the user is logged out via this.logOut method, the\r\n     * silent refreshing will pause and not refresh the tokens until the user is\r\n     * logged back in via receiving a new token.\r\n     * @param params Additional parameter to pass\r\n     * @param listenTo Setup automatic refresh of a specific token type\r\n     */\r\n    setupAutomaticSilentRefresh(params = {}, listenTo, noPrompt = true) {\r\n        let shouldRunSilentRefresh = true;\r\n        this.clearAutomaticRefreshTimer();\r\n        this.automaticRefreshSubscription = this.events\r\n            .pipe(tap((e) => {\r\n            if (e.type === 'token_received') {\r\n                shouldRunSilentRefresh = true;\r\n            }\r\n            else if (e.type === 'logout') {\r\n                shouldRunSilentRefresh = false;\r\n            }\r\n        }), filter((e) => e.type === 'token_expires' &&\r\n            (listenTo == null || listenTo === 'any' || e.info === listenTo)), debounceTime(1000))\r\n            .subscribe((_) => {\r\n            if (shouldRunSilentRefresh) {\r\n                // this.silentRefresh(params, noPrompt).catch(_ => {\r\n                this.refreshInternal(params, noPrompt).catch((_) => {\r\n                    this.debug('Automatic silent refresh did not work');\r\n                });\r\n            }\r\n        });\r\n        this.restartRefreshTimerIfStillLoggedIn();\r\n    }\r\n    refreshInternal(params, noPrompt) {\r\n        if (!this.useSilentRefresh && this.responseType === 'code') {\r\n            return this.refreshToken();\r\n        }\r\n        else {\r\n            return this.silentRefresh(params, noPrompt);\r\n        }\r\n    }\r\n    /**\r\n     * Convenience method that first calls `loadDiscoveryDocument(...)` and\r\n     * directly chains using the `then(...)` part of the promise to call\r\n     * the `tryLogin(...)` method.\r\n     *\r\n     * @param options LoginOptions to pass through to `tryLogin(...)`\r\n     */\r\n    loadDiscoveryDocumentAndTryLogin(options = null) {\r\n        return this.loadDiscoveryDocument().then((doc) => {\r\n            return this.tryLogin(options);\r\n        });\r\n    }\r\n    /**\r\n     * Convenience method that first calls `loadDiscoveryDocumentAndTryLogin(...)`\r\n     * and if then chains to `initLoginFlow()`, but only if there is no valid\r\n     * IdToken or no valid AccessToken.\r\n     *\r\n     * @param options LoginOptions to pass through to `tryLogin(...)`\r\n     */\r\n    loadDiscoveryDocumentAndLogin(options = null) {\r\n        options = options || {};\r\n        return this.loadDiscoveryDocumentAndTryLogin(options).then((_) => {\r\n            if (!this.hasValidIdToken() || !this.hasValidAccessToken()) {\r\n                const state = typeof options.state === 'string' ? options.state : '';\r\n                this.initLoginFlow(state);\r\n                return false;\r\n            }\r\n            else {\r\n                return true;\r\n            }\r\n        });\r\n    }\r\n    debug(...args) {\r\n        if (this.showDebugInformation) {\r\n            this.logger.debug.apply(this.logger, args);\r\n        }\r\n    }\r\n    validateUrlFromDiscoveryDocument(url) {\r\n        const errors = [];\r\n        const httpsCheck = this.validateUrlForHttps(url);\r\n        const issuerCheck = this.validateUrlAgainstIssuer(url);\r\n        if (!httpsCheck) {\r\n            errors.push('https for all urls required. Also for urls received by discovery.');\r\n        }\r\n        if (!issuerCheck) {\r\n            errors.push('Every url in discovery document has to start with the issuer url.' +\r\n                'Also see property strictDiscoveryDocumentValidation.');\r\n        }\r\n        return errors;\r\n    }\r\n    validateUrlForHttps(url) {\r\n        if (!url) {\r\n            return true;\r\n        }\r\n        const lcUrl = url.toLowerCase();\r\n        if (this.requireHttps === false) {\r\n            return true;\r\n        }\r\n        if ((lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/) ||\r\n            lcUrl.match(/^http:\\/\\/localhost($|[:\\/])/)) &&\r\n            this.requireHttps === 'remoteOnly') {\r\n            return true;\r\n        }\r\n        return lcUrl.startsWith('https://');\r\n    }\r\n    assertUrlNotNullAndCorrectProtocol(url, description) {\r\n        if (!url) {\r\n            throw new Error(`'${description}' should not be null`);\r\n        }\r\n        if (!this.validateUrlForHttps(url)) {\r\n            throw new Error(`'${description}' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).`);\r\n        }\r\n    }\r\n    validateUrlAgainstIssuer(url) {\r\n        if (!this.strictDiscoveryDocumentValidation) {\r\n            return true;\r\n        }\r\n        if (!url) {\r\n            return true;\r\n        }\r\n        return url.toLowerCase().startsWith(this.issuer.toLowerCase());\r\n    }\r\n    setupRefreshTimer() {\r\n        if (typeof window === 'undefined') {\r\n            this.debug('timer not supported on this plattform');\r\n            return;\r\n        }\r\n        if (this.hasValidIdToken() || this.hasValidAccessToken()) {\r\n            this.clearAccessTokenTimer();\r\n            this.clearIdTokenTimer();\r\n            this.setupExpirationTimers();\r\n        }\r\n        if (this.tokenReceivedSubscription)\r\n            this.tokenReceivedSubscription.unsubscribe();\r\n        this.tokenReceivedSubscription = this.events\r\n            .pipe(filter((e) => e.type === 'token_received'))\r\n            .subscribe((_) => {\r\n            this.clearAccessTokenTimer();\r\n            this.clearIdTokenTimer();\r\n            this.setupExpirationTimers();\r\n        });\r\n    }\r\n    setupExpirationTimers() {\r\n        if (this.hasValidAccessToken()) {\r\n            this.setupAccessTokenTimer();\r\n        }\r\n        if (this.hasValidIdToken()) {\r\n            this.setupIdTokenTimer();\r\n        }\r\n    }\r\n    setupAccessTokenTimer() {\r\n        const expiration = this.getAccessTokenExpiration();\r\n        const storedAt = this.getAccessTokenStoredAt();\r\n        const timeout = this.calcTimeout(storedAt, expiration);\r\n        this.ngZone.runOutsideAngular(() => {\r\n            this.accessTokenTimeoutSubscription = of(new OAuthInfoEvent('token_expires', 'access_token'))\r\n                .pipe(delay(timeout))\r\n                .subscribe((e) => {\r\n                this.ngZone.run(() => {\r\n                    this.eventsSubject.next(e);\r\n                });\r\n            });\r\n        });\r\n    }\r\n    setupIdTokenTimer() {\r\n        const expiration = this.getIdTokenExpiration();\r\n        const storedAt = this.getIdTokenStoredAt();\r\n        const timeout = this.calcTimeout(storedAt, expiration);\r\n        this.ngZone.runOutsideAngular(() => {\r\n            this.idTokenTimeoutSubscription = of(new OAuthInfoEvent('token_expires', 'id_token'))\r\n                .pipe(delay(timeout))\r\n                .subscribe((e) => {\r\n                this.ngZone.run(() => {\r\n                    this.eventsSubject.next(e);\r\n                });\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Stops timers for automatic refresh.\r\n     * To restart it, call setupAutomaticSilentRefresh again.\r\n     */\r\n    stopAutomaticRefresh() {\r\n        this.clearAccessTokenTimer();\r\n        this.clearIdTokenTimer();\r\n        this.clearAutomaticRefreshTimer();\r\n    }\r\n    clearAccessTokenTimer() {\r\n        if (this.accessTokenTimeoutSubscription) {\r\n            this.accessTokenTimeoutSubscription.unsubscribe();\r\n        }\r\n    }\r\n    clearIdTokenTimer() {\r\n        if (this.idTokenTimeoutSubscription) {\r\n            this.idTokenTimeoutSubscription.unsubscribe();\r\n        }\r\n    }\r\n    clearAutomaticRefreshTimer() {\r\n        if (this.automaticRefreshSubscription) {\r\n            this.automaticRefreshSubscription.unsubscribe();\r\n        }\r\n    }\r\n    calcTimeout(storedAt, expiration) {\r\n        const now = this.dateTimeService.now();\r\n        const delta = (expiration - storedAt) * this.timeoutFactor - (now - storedAt);\r\n        return Math.max(0, delta);\r\n    }\r\n    /**\r\n     * DEPRECATED. Use a provider for OAuthStorage instead:\r\n     *\r\n     * { provide: OAuthStorage, useFactory: oAuthStorageFactory }\r\n     * export function oAuthStorageFactory(): OAuthStorage { return localStorage; }\r\n     * Sets a custom storage used to store the received\r\n     * tokens on client side. By default, the browser's\r\n     * sessionStorage is used.\r\n     * @ignore\r\n     *\r\n     * @param storage\r\n     */\r\n    setStorage(storage) {\r\n        this._storage = storage;\r\n        this.configChanged();\r\n    }\r\n    /**\r\n     * Loads the discovery document to configure most\r\n     * properties of this service. The url of the discovery\r\n     * document is infered from the issuer's url according\r\n     * to the OpenId Connect spec. To use another url you\r\n     * can pass it to to optional parameter fullUrl.\r\n     *\r\n     * @param fullUrl\r\n     */\r\n    loadDiscoveryDocument(fullUrl = null) {\r\n        return new Promise((resolve, reject) => {\r\n            if (!fullUrl) {\r\n                fullUrl = this.issuer || '';\r\n                if (!fullUrl.endsWith('/')) {\r\n                    fullUrl += '/';\r\n                }\r\n                fullUrl += '.well-known/openid-configuration';\r\n            }\r\n            if (!this.validateUrlForHttps(fullUrl)) {\r\n                reject(\"issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n                return;\r\n            }\r\n            this.http.get(fullUrl).subscribe((doc) => {\r\n                if (!this.validateDiscoveryDocument(doc)) {\r\n                    this.eventsSubject.next(new OAuthErrorEvent('discovery_document_validation_error', null));\r\n                    reject('discovery_document_validation_error');\r\n                    return;\r\n                }\r\n                this.loginUrl = doc.authorization_endpoint;\r\n                this.logoutUrl = doc.end_session_endpoint || this.logoutUrl;\r\n                this.grantTypesSupported = doc.grant_types_supported;\r\n                this.issuer = doc.issuer;\r\n                this.tokenEndpoint = doc.token_endpoint;\r\n                this.userinfoEndpoint =\r\n                    doc.userinfo_endpoint || this.userinfoEndpoint;\r\n                this.jwksUri = doc.jwks_uri;\r\n                this.sessionCheckIFrameUrl =\r\n                    doc.check_session_iframe || this.sessionCheckIFrameUrl;\r\n                this.discoveryDocumentLoaded = true;\r\n                this.discoveryDocumentLoadedSubject.next(doc);\r\n                this.revocationEndpoint =\r\n                    doc.revocation_endpoint || this.revocationEndpoint;\r\n                if (this.sessionChecksEnabled) {\r\n                    this.restartSessionChecksIfStillLoggedIn();\r\n                }\r\n                this.loadJwks()\r\n                    .then((jwks) => {\r\n                    const result = {\r\n                        discoveryDocument: doc,\r\n                        jwks: jwks,\r\n                    };\r\n                    const event = new OAuthSuccessEvent('discovery_document_loaded', result);\r\n                    this.eventsSubject.next(event);\r\n                    resolve(event);\r\n                    return;\r\n                })\r\n                    .catch((err) => {\r\n                    this.eventsSubject.next(new OAuthErrorEvent('discovery_document_load_error', err));\r\n                    reject(err);\r\n                    return;\r\n                });\r\n            }, (err) => {\r\n                this.logger.error('error loading discovery document', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('discovery_document_load_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    loadJwks() {\r\n        return new Promise((resolve, reject) => {\r\n            if (this.jwksUri) {\r\n                this.http.get(this.jwksUri).subscribe((jwks) => {\r\n                    this.jwks = jwks;\r\n                    this.eventsSubject.next(new OAuthSuccessEvent('discovery_document_loaded'));\r\n                    resolve(jwks);\r\n                }, (err) => {\r\n                    this.logger.error('error loading jwks', err);\r\n                    this.eventsSubject.next(new OAuthErrorEvent('jwks_load_error', err));\r\n                    reject(err);\r\n                });\r\n            }\r\n            else {\r\n                resolve(null);\r\n            }\r\n        });\r\n    }\r\n    validateDiscoveryDocument(doc) {\r\n        let errors;\r\n        if (!this.skipIssuerCheck && doc.issuer !== this.issuer) {\r\n            this.logger.error('invalid issuer in discovery document', 'expected: ' + this.issuer, 'current: ' + doc.issuer);\r\n            return false;\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.authorization_endpoint);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating authorization_endpoint in discovery document', errors);\r\n            return false;\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.end_session_endpoint);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating end_session_endpoint in discovery document', errors);\r\n            return false;\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.token_endpoint);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating token_endpoint in discovery document', errors);\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.revocation_endpoint);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating revocation_endpoint in discovery document', errors);\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.userinfo_endpoint);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating userinfo_endpoint in discovery document', errors);\r\n            return false;\r\n        }\r\n        errors = this.validateUrlFromDiscoveryDocument(doc.jwks_uri);\r\n        if (errors.length > 0) {\r\n            this.logger.error('error validating jwks_uri in discovery document', errors);\r\n            return false;\r\n        }\r\n        if (this.sessionChecksEnabled && !doc.check_session_iframe) {\r\n            this.logger.warn('sessionChecksEnabled is activated but discovery document' +\r\n                ' does not contain a check_session_iframe field');\r\n        }\r\n        return true;\r\n    }\r\n    /**\r\n     * Uses password flow to exchange userName and password for an\r\n     * access_token. After receiving the access_token, this method\r\n     * uses it to query the userinfo endpoint in order to get information\r\n     * about the user in question.\r\n     *\r\n     * When using this, make sure that the property oidc is set to false.\r\n     * Otherwise stricter validations take place that make this operation\r\n     * fail.\r\n     *\r\n     * @param userName\r\n     * @param password\r\n     * @param headers Optional additional http-headers.\r\n     */\r\n    fetchTokenUsingPasswordFlowAndLoadUserProfile(userName, password, headers = new HttpHeaders()) {\r\n        return this.fetchTokenUsingPasswordFlow(userName, password, headers).then(() => this.loadUserProfile());\r\n    }\r\n    /**\r\n     * Loads the user profile by accessing the user info endpoint defined by OpenId Connect.\r\n     *\r\n     * When using this with OAuth2 password flow, make sure that the property oidc is set to false.\r\n     * Otherwise stricter validations take place that make this operation fail.\r\n     */\r\n    loadUserProfile() {\r\n        if (!this.hasValidAccessToken()) {\r\n            throw new Error('Can not load User Profile without access_token');\r\n        }\r\n        if (!this.validateUrlForHttps(this.userinfoEndpoint)) {\r\n            throw new Error(\"userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n        }\r\n        return new Promise((resolve, reject) => {\r\n            const headers = new HttpHeaders().set('Authorization', 'Bearer ' + this.getAccessToken());\r\n            this.http\r\n                .get(this.userinfoEndpoint, {\r\n                headers,\r\n                observe: 'response',\r\n                responseType: 'text',\r\n            })\r\n                .subscribe((response) => {\r\n                this.debug('userinfo received', JSON.stringify(response));\r\n                if (response.headers\r\n                    .get('content-type')\r\n                    .startsWith('application/json')) {\r\n                    let info = JSON.parse(response.body);\r\n                    const existingClaims = this.getIdentityClaims() || {};\r\n                    if (!this.skipSubjectCheck) {\r\n                        if (this.oidc &&\r\n                            (!existingClaims['sub'] || info.sub !== existingClaims['sub'])) {\r\n                            const err = 'if property oidc is true, the received user-id (sub) has to be the user-id ' +\r\n                                'of the user that has logged in with oidc.\\n' +\r\n                                'if you are not using oidc but just oauth2 password flow set oidc to false';\r\n                            reject(err);\r\n                            return;\r\n                        }\r\n                    }\r\n                    info = Object.assign({}, existingClaims, info);\r\n                    this._storage.setItem('id_token_claims_obj', JSON.stringify(info));\r\n                    this.eventsSubject.next(new OAuthSuccessEvent('user_profile_loaded'));\r\n                    resolve({ info });\r\n                }\r\n                else {\r\n                    this.debug('userinfo is not JSON, treating it as JWE/JWS');\r\n                    this.eventsSubject.next(new OAuthSuccessEvent('user_profile_loaded'));\r\n                    resolve(JSON.parse(response.body));\r\n                }\r\n            }, (err) => {\r\n                this.logger.error('error loading user info', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('user_profile_load_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Uses password flow to exchange userName and password for an access_token.\r\n     * @param userName\r\n     * @param password\r\n     * @param headers Optional additional http-headers.\r\n     */\r\n    fetchTokenUsingPasswordFlow(userName, password, headers = new HttpHeaders()) {\r\n        const parameters = {\r\n            username: userName,\r\n            password: password,\r\n        };\r\n        return this.fetchTokenUsingGrant('password', parameters, headers);\r\n    }\r\n    /**\r\n     * Uses a custom grant type to retrieve tokens.\r\n     * @param grantType Grant type.\r\n     * @param parameters Parameters to pass.\r\n     * @param headers Optional additional HTTP headers.\r\n     */\r\n    fetchTokenUsingGrant(grantType, parameters, headers = new HttpHeaders()) {\r\n        this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\r\n        /**\r\n         * A `HttpParameterCodec` that uses `encodeURIComponent` and `decodeURIComponent` to\r\n         * serialize and parse URL parameter keys and values.\r\n         *\r\n         * @stable\r\n         */\r\n        let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() })\r\n            .set('grant_type', grantType)\r\n            .set('scope', this.scope);\r\n        if (this.useHttpBasicAuth) {\r\n            const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n            headers = headers.set('Authorization', 'Basic ' + header);\r\n        }\r\n        if (!this.useHttpBasicAuth) {\r\n            params = params.set('client_id', this.clientId);\r\n        }\r\n        if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n            params = params.set('client_secret', this.dummyClientSecret);\r\n        }\r\n        if (this.customQueryParams) {\r\n            for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n                params = params.set(key, this.customQueryParams[key]);\r\n            }\r\n        }\r\n        // set explicit parameters last, to allow overwriting\r\n        for (const key of Object.keys(parameters)) {\r\n            params = params.set(key, parameters[key]);\r\n        }\r\n        headers = headers.set('Content-Type', 'application/x-www-form-urlencoded');\r\n        return new Promise((resolve, reject) => {\r\n            this.http\r\n                .post(this.tokenEndpoint, params, { headers })\r\n                .subscribe((tokenResponse) => {\r\n                this.debug('tokenResponse', tokenResponse);\r\n                this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in ||\r\n                    this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\r\n                if (this.oidc && tokenResponse.id_token) {\r\n                    this.processIdToken(tokenResponse.id_token, tokenResponse.access_token).then((result) => {\r\n                        this.storeIdToken(result);\r\n                        resolve(tokenResponse);\r\n                    });\r\n                }\r\n                this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n                resolve(tokenResponse);\r\n            }, (err) => {\r\n                this.logger.error('Error performing ${grantType} flow', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('token_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Refreshes the token using a refresh_token.\r\n     * This does not work for implicit flow, b/c\r\n     * there is no refresh_token in this flow.\r\n     * A solution for this is provided by the\r\n     * method silentRefresh.\r\n     */\r\n    refreshToken() {\r\n        this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\r\n        return new Promise((resolve, reject) => {\r\n            let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() })\r\n                .set('grant_type', 'refresh_token')\r\n                .set('scope', this.scope)\r\n                .set('refresh_token', this._storage.getItem('refresh_token'));\r\n            let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\r\n            if (this.useHttpBasicAuth) {\r\n                const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n                headers = headers.set('Authorization', 'Basic ' + header);\r\n            }\r\n            if (!this.useHttpBasicAuth) {\r\n                params = params.set('client_id', this.clientId);\r\n            }\r\n            if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n                params = params.set('client_secret', this.dummyClientSecret);\r\n            }\r\n            if (this.customQueryParams) {\r\n                for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n                    params = params.set(key, this.customQueryParams[key]);\r\n                }\r\n            }\r\n            this.http\r\n                .post(this.tokenEndpoint, params, { headers })\r\n                .pipe(switchMap((tokenResponse) => {\r\n                if (tokenResponse.id_token) {\r\n                    return from(this.processIdToken(tokenResponse.id_token, tokenResponse.access_token, true)).pipe(tap((result) => this.storeIdToken(result)), map((_) => tokenResponse));\r\n                }\r\n                else {\r\n                    return of(tokenResponse);\r\n                }\r\n            }))\r\n                .subscribe((tokenResponse) => {\r\n                this.debug('refresh tokenResponse', tokenResponse);\r\n                this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in ||\r\n                    this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\r\n                this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n                this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\r\n                resolve(tokenResponse);\r\n            }, (err) => {\r\n                this.logger.error('Error refreshing token', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('token_refresh_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    removeSilentRefreshEventListener() {\r\n        if (this.silentRefreshPostMessageEventListener) {\r\n            window.removeEventListener('message', this.silentRefreshPostMessageEventListener);\r\n            this.silentRefreshPostMessageEventListener = null;\r\n        }\r\n    }\r\n    setupSilentRefreshEventListener() {\r\n        this.removeSilentRefreshEventListener();\r\n        this.silentRefreshPostMessageEventListener = (e) => {\r\n            const message = this.processMessageEventMessage(e);\r\n            this.tryLogin({\r\n                customHashFragment: message,\r\n                preventClearHashAfterLogin: true,\r\n                customRedirectUri: this.silentRefreshRedirectUri || this.redirectUri,\r\n            }).catch((err) => this.debug('tryLogin during silent refresh failed', err));\r\n        };\r\n        window.addEventListener('message', this.silentRefreshPostMessageEventListener);\r\n    }\r\n    /**\r\n     * Performs a silent refresh for implicit flow.\r\n     * Use this method to get new tokens when/before\r\n     * the existing tokens expire.\r\n     */\r\n    silentRefresh(params = {}, noPrompt = true) {\r\n        const claims = this.getIdentityClaims() || {};\r\n        if (this.useIdTokenHintForSilentRefresh && this.hasValidIdToken()) {\r\n            params['id_token_hint'] = this.getIdToken();\r\n        }\r\n        if (!this.validateUrlForHttps(this.loginUrl)) {\r\n            throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n        }\r\n        if (typeof this.document === 'undefined') {\r\n            throw new Error('silent refresh is not supported on this platform');\r\n        }\r\n        const existingIframe = this.document.getElementById(this.silentRefreshIFrameName);\r\n        if (existingIframe) {\r\n            this.document.body.removeChild(existingIframe);\r\n        }\r\n        this.silentRefreshSubject = claims['sub'];\r\n        const iframe = this.document.createElement('iframe');\r\n        iframe.id = this.silentRefreshIFrameName;\r\n        this.setupSilentRefreshEventListener();\r\n        const redirectUri = this.silentRefreshRedirectUri || this.redirectUri;\r\n        this.createLoginUrl(null, null, redirectUri, noPrompt, params).then((url) => {\r\n            iframe.setAttribute('src', url);\r\n            if (!this.silentRefreshShowIFrame) {\r\n                iframe.style['display'] = 'none';\r\n            }\r\n            this.document.body.appendChild(iframe);\r\n        });\r\n        const errors = this.events.pipe(filter((e) => e instanceof OAuthErrorEvent), first());\r\n        const success = this.events.pipe(filter((e) => e.type === 'token_received'), first());\r\n        const timeout = of(new OAuthErrorEvent('silent_refresh_timeout', null)).pipe(delay(this.silentRefreshTimeout));\r\n        return race([errors, success, timeout])\r\n            .pipe(map((e) => {\r\n            if (e instanceof OAuthErrorEvent) {\r\n                if (e.type === 'silent_refresh_timeout') {\r\n                    this.eventsSubject.next(e);\r\n                }\r\n                else {\r\n                    e = new OAuthErrorEvent('silent_refresh_error', e);\r\n                    this.eventsSubject.next(e);\r\n                }\r\n                throw e;\r\n            }\r\n            else if (e.type === 'token_received') {\r\n                e = new OAuthSuccessEvent('silently_refreshed');\r\n                this.eventsSubject.next(e);\r\n            }\r\n            return e;\r\n        }))\r\n            .toPromise();\r\n    }\r\n    /**\r\n     * This method exists for backwards compatibility.\r\n     * {@link OAuthService#initLoginFlowInPopup} handles both code\r\n     * and implicit flows.\r\n     */\r\n    initImplicitFlowInPopup(options) {\r\n        return this.initLoginFlowInPopup(options);\r\n    }\r\n    initLoginFlowInPopup(options) {\r\n        options = options || {};\r\n        return this.createLoginUrl(null, null, this.silentRefreshRedirectUri, false, {\r\n            display: 'popup',\r\n        }).then((url) => {\r\n            return new Promise((resolve, reject) => {\r\n                /**\r\n                 * Error handling section\r\n                 */\r\n                const checkForPopupClosedInterval = 500;\r\n                let windowRef = null;\r\n                // If we got no window reference we open a window\r\n                // else we are using the window already opened\r\n                if (!options.windowRef) {\r\n                    windowRef = window.open(url, 'ngx-oauth2-oidc-login', this.calculatePopupFeatures(options));\r\n                }\r\n                else if (options.windowRef && !options.windowRef.closed) {\r\n                    windowRef = options.windowRef;\r\n                    windowRef.location.href = url;\r\n                }\r\n                let checkForPopupClosedTimer;\r\n                const tryLogin = (hash) => {\r\n                    this.tryLogin({\r\n                        customHashFragment: hash,\r\n                        preventClearHashAfterLogin: true,\r\n                        customRedirectUri: this.silentRefreshRedirectUri,\r\n                    }).then(() => {\r\n                        cleanup();\r\n                        resolve(true);\r\n                    }, (err) => {\r\n                        cleanup();\r\n                        reject(err);\r\n                    });\r\n                };\r\n                const checkForPopupClosed = () => {\r\n                    if (!windowRef || windowRef.closed) {\r\n                        cleanup();\r\n                        reject(new OAuthErrorEvent('popup_closed', {}));\r\n                    }\r\n                };\r\n                if (!windowRef) {\r\n                    reject(new OAuthErrorEvent('popup_blocked', {}));\r\n                }\r\n                else {\r\n                    checkForPopupClosedTimer = window.setInterval(checkForPopupClosed, checkForPopupClosedInterval);\r\n                }\r\n                const cleanup = () => {\r\n                    window.clearInterval(checkForPopupClosedTimer);\r\n                    window.removeEventListener('storage', storageListener);\r\n                    window.removeEventListener('message', listener);\r\n                    if (windowRef !== null) {\r\n                        windowRef.close();\r\n                    }\r\n                    windowRef = null;\r\n                };\r\n                const listener = (e) => {\r\n                    const message = this.processMessageEventMessage(e);\r\n                    if (message && message !== null) {\r\n                        window.removeEventListener('storage', storageListener);\r\n                        tryLogin(message);\r\n                    }\r\n                    else {\r\n                        console.log('false event firing');\r\n                    }\r\n                };\r\n                const storageListener = (event) => {\r\n                    if (event.key === 'auth_hash') {\r\n                        window.removeEventListener('message', listener);\r\n                        tryLogin(event.newValue);\r\n                    }\r\n                };\r\n                window.addEventListener('message', listener);\r\n                window.addEventListener('storage', storageListener);\r\n            });\r\n        });\r\n    }\r\n    calculatePopupFeatures(options) {\r\n        // Specify an static height and width and calculate centered position\r\n        const height = options.height || 470;\r\n        const width = options.width || 500;\r\n        const left = window.screenLeft + (window.outerWidth - width) / 2;\r\n        const top = window.screenTop + (window.outerHeight - height) / 2;\r\n        return `location=no,toolbar=no,width=${width},height=${height},top=${top},left=${left}`;\r\n    }\r\n    processMessageEventMessage(e) {\r\n        let expectedPrefix = '#';\r\n        if (this.silentRefreshMessagePrefix) {\r\n            expectedPrefix += this.silentRefreshMessagePrefix;\r\n        }\r\n        if (!e || !e.data || typeof e.data !== 'string') {\r\n            return;\r\n        }\r\n        const prefixedMessage = e.data;\r\n        if (!prefixedMessage.startsWith(expectedPrefix)) {\r\n            return;\r\n        }\r\n        return '#' + prefixedMessage.substr(expectedPrefix.length);\r\n    }\r\n    canPerformSessionCheck() {\r\n        if (!this.sessionChecksEnabled) {\r\n            return false;\r\n        }\r\n        if (!this.sessionCheckIFrameUrl) {\r\n            console.warn('sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl');\r\n            return false;\r\n        }\r\n        const sessionState = this.getSessionState();\r\n        if (!sessionState) {\r\n            console.warn('sessionChecksEnabled is activated but there is no session_state');\r\n            return false;\r\n        }\r\n        if (typeof this.document === 'undefined') {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n    setupSessionCheckEventListener() {\r\n        this.removeSessionCheckEventListener();\r\n        this.sessionCheckEventListener = (e) => {\r\n            const origin = e.origin.toLowerCase();\r\n            const issuer = this.issuer.toLowerCase();\r\n            this.debug('sessionCheckEventListener');\r\n            if (!issuer.startsWith(origin)) {\r\n                this.debug('sessionCheckEventListener', 'wrong origin', origin, 'expected', issuer, 'event', e);\r\n                return;\r\n            }\r\n            // only run in Angular zone if it is 'changed' or 'error'\r\n            switch (e.data) {\r\n                case 'unchanged':\r\n                    this.ngZone.run(() => {\r\n                        this.handleSessionUnchanged();\r\n                    });\r\n                    break;\r\n                case 'changed':\r\n                    this.ngZone.run(() => {\r\n                        this.handleSessionChange();\r\n                    });\r\n                    break;\r\n                case 'error':\r\n                    this.ngZone.run(() => {\r\n                        this.handleSessionError();\r\n                    });\r\n                    break;\r\n            }\r\n            this.debug('got info from session check inframe', e);\r\n        };\r\n        // prevent Angular from refreshing the view on every message (runs in intervals)\r\n        this.ngZone.runOutsideAngular(() => {\r\n            window.addEventListener('message', this.sessionCheckEventListener);\r\n        });\r\n    }\r\n    handleSessionUnchanged() {\r\n        this.debug('session check', 'session unchanged');\r\n        this.eventsSubject.next(new OAuthInfoEvent('session_unchanged'));\r\n    }\r\n    handleSessionChange() {\r\n        this.eventsSubject.next(new OAuthInfoEvent('session_changed'));\r\n        this.stopSessionCheckTimer();\r\n        if (!this.useSilentRefresh && this.responseType === 'code') {\r\n            this.refreshToken()\r\n                .then((_) => {\r\n                this.debug('token refresh after session change worked');\r\n            })\r\n                .catch((_) => {\r\n                this.debug('token refresh did not work after session changed');\r\n                this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n                this.logOut(true);\r\n            });\r\n        }\r\n        else if (this.silentRefreshRedirectUri) {\r\n            this.silentRefresh().catch((_) => this.debug('silent refresh failed after session changed'));\r\n            this.waitForSilentRefreshAfterSessionChange();\r\n        }\r\n        else {\r\n            this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n            this.logOut(true);\r\n        }\r\n    }\r\n    waitForSilentRefreshAfterSessionChange() {\r\n        this.events\r\n            .pipe(filter((e) => e.type === 'silently_refreshed' ||\r\n            e.type === 'silent_refresh_timeout' ||\r\n            e.type === 'silent_refresh_error'), first())\r\n            .subscribe((e) => {\r\n            if (e.type !== 'silently_refreshed') {\r\n                this.debug('silent refresh did not work after session changed');\r\n                this.eventsSubject.next(new OAuthInfoEvent('session_terminated'));\r\n                this.logOut(true);\r\n            }\r\n        });\r\n    }\r\n    handleSessionError() {\r\n        this.stopSessionCheckTimer();\r\n        this.eventsSubject.next(new OAuthInfoEvent('session_error'));\r\n    }\r\n    removeSessionCheckEventListener() {\r\n        if (this.sessionCheckEventListener) {\r\n            window.removeEventListener('message', this.sessionCheckEventListener);\r\n            this.sessionCheckEventListener = null;\r\n        }\r\n    }\r\n    initSessionCheck() {\r\n        if (!this.canPerformSessionCheck()) {\r\n            return;\r\n        }\r\n        const existingIframe = this.document.getElementById(this.sessionCheckIFrameName);\r\n        if (existingIframe) {\r\n            this.document.body.removeChild(existingIframe);\r\n        }\r\n        const iframe = this.document.createElement('iframe');\r\n        iframe.id = this.sessionCheckIFrameName;\r\n        this.setupSessionCheckEventListener();\r\n        const url = this.sessionCheckIFrameUrl;\r\n        iframe.setAttribute('src', url);\r\n        iframe.style.display = 'none';\r\n        this.document.body.appendChild(iframe);\r\n        this.startSessionCheckTimer();\r\n    }\r\n    startSessionCheckTimer() {\r\n        this.stopSessionCheckTimer();\r\n        this.ngZone.runOutsideAngular(() => {\r\n            this.sessionCheckTimer = setInterval(this.checkSession.bind(this), this.sessionCheckIntervall);\r\n        });\r\n    }\r\n    stopSessionCheckTimer() {\r\n        if (this.sessionCheckTimer) {\r\n            clearInterval(this.sessionCheckTimer);\r\n            this.sessionCheckTimer = null;\r\n        }\r\n    }\r\n    checkSession() {\r\n        const iframe = this.document.getElementById(this.sessionCheckIFrameName);\r\n        if (!iframe) {\r\n            this.logger.warn('checkSession did not find iframe', this.sessionCheckIFrameName);\r\n        }\r\n        const sessionState = this.getSessionState();\r\n        if (!sessionState) {\r\n            this.stopSessionCheckTimer();\r\n        }\r\n        const message = this.clientId + ' ' + sessionState;\r\n        iframe.contentWindow.postMessage(message, this.issuer);\r\n    }\r\n    createLoginUrl(state = '', loginHint = '', customRedirectUri = '', noPrompt = false, params = {}) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const that = this;\r\n            let redirectUri;\r\n            if (customRedirectUri) {\r\n                redirectUri = customRedirectUri;\r\n            }\r\n            else {\r\n                redirectUri = this.redirectUri;\r\n            }\r\n            const nonce = yield this.createAndSaveNonce();\r\n            if (state) {\r\n                state =\r\n                    nonce + this.config.nonceStateSeparator + encodeURIComponent(state);\r\n            }\r\n            else {\r\n                state = nonce;\r\n            }\r\n            if (!this.requestAccessToken && !this.oidc) {\r\n                throw new Error('Either requestAccessToken or oidc or both must be true');\r\n            }\r\n            if (this.config.responseType) {\r\n                this.responseType = this.config.responseType;\r\n            }\r\n            else {\r\n                if (this.oidc && this.requestAccessToken) {\r\n                    this.responseType = 'id_token token';\r\n                }\r\n                else if (this.oidc && !this.requestAccessToken) {\r\n                    this.responseType = 'id_token';\r\n                }\r\n                else {\r\n                    this.responseType = 'token';\r\n                }\r\n            }\r\n            const seperationChar = that.loginUrl.indexOf('?') > -1 ? '&' : '?';\r\n            let scope = that.scope;\r\n            if (this.oidc && !scope.match(/(^|\\s)openid($|\\s)/)) {\r\n                scope = 'openid ' + scope;\r\n            }\r\n            let url = that.loginUrl +\r\n                seperationChar +\r\n                'response_type=' +\r\n                encodeURIComponent(that.responseType) +\r\n                '&client_id=' +\r\n                encodeURIComponent(that.clientId) +\r\n                '&state=' +\r\n                encodeURIComponent(state) +\r\n                '&redirect_uri=' +\r\n                encodeURIComponent(redirectUri) +\r\n                '&scope=' +\r\n                encodeURIComponent(scope);\r\n            if (this.responseType.includes('code') && !this.disablePKCE) {\r\n                const [challenge, verifier] = yield this.createChallangeVerifierPairForPKCE();\r\n                if (this.saveNoncesInLocalStorage &&\r\n                    typeof window['localStorage'] !== 'undefined') {\r\n                    localStorage.setItem('PKCE_verifier', verifier);\r\n                }\r\n                else {\r\n                    this._storage.setItem('PKCE_verifier', verifier);\r\n                }\r\n                url += '&code_challenge=' + challenge;\r\n                url += '&code_challenge_method=S256';\r\n            }\r\n            if (loginHint) {\r\n                url += '&login_hint=' + encodeURIComponent(loginHint);\r\n            }\r\n            if (that.resource) {\r\n                url += '&resource=' + encodeURIComponent(that.resource);\r\n            }\r\n            if (that.oidc) {\r\n                url += '&nonce=' + encodeURIComponent(nonce);\r\n            }\r\n            if (noPrompt) {\r\n                url += '&prompt=none';\r\n            }\r\n            for (const key of Object.keys(params)) {\r\n                url +=\r\n                    '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);\r\n            }\r\n            if (this.customQueryParams) {\r\n                for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n                    url +=\r\n                        '&' + key + '=' + encodeURIComponent(this.customQueryParams[key]);\r\n                }\r\n            }\r\n            return url;\r\n        });\r\n    }\r\n    initImplicitFlowInternal(additionalState = '', params = '') {\r\n        if (this.inImplicitFlow) {\r\n            return;\r\n        }\r\n        this.inImplicitFlow = true;\r\n        if (!this.validateUrlForHttps(this.loginUrl)) {\r\n            throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n        }\r\n        let addParams = {};\r\n        let loginHint = null;\r\n        if (typeof params === 'string') {\r\n            loginHint = params;\r\n        }\r\n        else if (typeof params === 'object') {\r\n            addParams = params;\r\n        }\r\n        this.createLoginUrl(additionalState, loginHint, null, false, addParams)\r\n            .then(this.config.openUri)\r\n            .catch((error) => {\r\n            console.error('Error in initImplicitFlow', error);\r\n            this.inImplicitFlow = false;\r\n        });\r\n    }\r\n    /**\r\n     * Starts the implicit flow and redirects to user to\r\n     * the auth servers' login url.\r\n     *\r\n     * @param additionalState Optional state that is passed around.\r\n     *  You'll find this state in the property `state` after `tryLogin` logged in the user.\r\n     * @param params Hash with additional parameter. If it is a string, it is used for the\r\n     *               parameter loginHint (for the sake of compatibility with former versions)\r\n     */\r\n    initImplicitFlow(additionalState = '', params = '') {\r\n        if (this.loginUrl !== '') {\r\n            this.initImplicitFlowInternal(additionalState, params);\r\n        }\r\n        else {\r\n            this.events\r\n                .pipe(filter((e) => e.type === 'discovery_document_loaded'))\r\n                .subscribe((_) => this.initImplicitFlowInternal(additionalState, params));\r\n        }\r\n    }\r\n    /**\r\n     * Reset current implicit flow\r\n     *\r\n     * @description This method allows resetting the current implict flow in order to be initialized again.\r\n     */\r\n    resetImplicitFlow() {\r\n        this.inImplicitFlow = false;\r\n    }\r\n    callOnTokenReceivedIfExists(options) {\r\n        const that = this;\r\n        if (options.onTokenReceived) {\r\n            const tokenParams = {\r\n                idClaims: that.getIdentityClaims(),\r\n                idToken: that.getIdToken(),\r\n                accessToken: that.getAccessToken(),\r\n                state: that.state,\r\n            };\r\n            options.onTokenReceived(tokenParams);\r\n        }\r\n    }\r\n    storeAccessTokenResponse(accessToken, refreshToken, expiresIn, grantedScopes, customParameters) {\r\n        this._storage.setItem('access_token', accessToken);\r\n        if (grantedScopes && !Array.isArray(grantedScopes)) {\r\n            this._storage.setItem('granted_scopes', JSON.stringify(grantedScopes.split(' ')));\r\n        }\r\n        else if (grantedScopes && Array.isArray(grantedScopes)) {\r\n            this._storage.setItem('granted_scopes', JSON.stringify(grantedScopes));\r\n        }\r\n        this._storage.setItem('access_token_stored_at', '' + this.dateTimeService.now());\r\n        if (expiresIn) {\r\n            const expiresInMilliSeconds = expiresIn * 1000;\r\n            const now = this.dateTimeService.new();\r\n            const expiresAt = now.getTime() + expiresInMilliSeconds;\r\n            this._storage.setItem('expires_at', '' + expiresAt);\r\n        }\r\n        if (refreshToken) {\r\n            this._storage.setItem('refresh_token', refreshToken);\r\n        }\r\n        if (customParameters) {\r\n            customParameters.forEach((value, key) => {\r\n                this._storage.setItem(key, value);\r\n            });\r\n        }\r\n    }\r\n    /**\r\n     * Delegates to tryLoginImplicitFlow for the sake of competability\r\n     * @param options Optional options.\r\n     */\r\n    tryLogin(options = null) {\r\n        if (this.config.responseType === 'code') {\r\n            return this.tryLoginCodeFlow(options).then((_) => true);\r\n        }\r\n        else {\r\n            return this.tryLoginImplicitFlow(options);\r\n        }\r\n    }\r\n    parseQueryString(queryString) {\r\n        if (!queryString || queryString.length === 0) {\r\n            return {};\r\n        }\r\n        if (queryString.charAt(0) === '?') {\r\n            queryString = queryString.substr(1);\r\n        }\r\n        return this.urlHelper.parseQueryString(queryString);\r\n    }\r\n    tryLoginCodeFlow(options = null) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            options = options || {};\r\n            const querySource = options.customHashFragment\r\n                ? options.customHashFragment.substring(1)\r\n                : window.location.search;\r\n            const parts = this.getCodePartsFromUrl(querySource);\r\n            const code = parts['code'];\r\n            const state = parts['state'];\r\n            const sessionState = parts['session_state'];\r\n            if (!options.preventClearHashAfterLogin) {\r\n                const href = location.origin +\r\n                    location.pathname +\r\n                    location.search\r\n                        .replace(/code=[^&\\$]*/, '')\r\n                        .replace(/scope=[^&\\$]*/, '')\r\n                        .replace(/state=[^&\\$]*/, '')\r\n                        .replace(/session_state=[^&\\$]*/, '')\r\n                        .replace(/^\\?&/, '?')\r\n                        .replace(/&$/, '')\r\n                        .replace(/^\\?$/, '')\r\n                        .replace(/&+/g, '&')\r\n                        .replace(/\\?&/, '?')\r\n                        .replace(/\\?$/, '') +\r\n                    location.hash;\r\n                history.replaceState(null, window.name, href);\r\n            }\r\n            let [nonceInState, userState] = this.parseState(state);\r\n            this.state = userState;\r\n            if (parts['error']) {\r\n                this.debug('error trying to login');\r\n                this.handleLoginError(options, parts);\r\n                const err = new OAuthErrorEvent('code_error', {}, parts);\r\n                this.eventsSubject.next(err);\r\n                return Promise.reject(err);\r\n            }\r\n            if (!options.disableNonceCheck) {\r\n                if (!nonceInState) {\r\n                    this.saveRequestedRoute();\r\n                    return Promise.resolve();\r\n                }\r\n                if (!options.disableOAuth2StateCheck) {\r\n                    const success = this.validateNonce(nonceInState);\r\n                    if (!success) {\r\n                        const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\r\n                        this.eventsSubject.next(event);\r\n                        return Promise.reject(event);\r\n                    }\r\n                }\r\n                this.storeSessionState(sessionState);\r\n                if (code) {\r\n                    yield this.getTokenFromCode(code, options);\r\n                    this.restoreRequestedRoute();\r\n                    return Promise.resolve();\r\n                }\r\n                else {\r\n                    return Promise.resolve();\r\n                }\r\n            }\r\n            return Promise.reject();\r\n        });\r\n    }\r\n    saveRequestedRoute() {\r\n        if (this.config.preserveRequestedRoute) {\r\n            this._storage.setItem('requested_route', window.location.pathname + window.location.search);\r\n        }\r\n    }\r\n    restoreRequestedRoute() {\r\n        const requestedRoute = this._storage.getItem('requested_route');\r\n        if (requestedRoute) {\r\n            history.replaceState(null, '', window.location.origin + requestedRoute);\r\n        }\r\n    }\r\n    /**\r\n     * Retrieve the returned auth code from the redirect uri that has been called.\r\n     * If required also check hash, as we could use hash location strategy.\r\n     */\r\n    getCodePartsFromUrl(queryString) {\r\n        if (!queryString || queryString.length === 0) {\r\n            return this.urlHelper.getHashFragmentParams();\r\n        }\r\n        // normalize query string\r\n        if (queryString.charAt(0) === '?') {\r\n            queryString = queryString.substr(1);\r\n        }\r\n        return this.urlHelper.parseQueryString(queryString);\r\n    }\r\n    /**\r\n     * Get token using an intermediate code. Works for the Authorization Code flow.\r\n     */\r\n    getTokenFromCode(code, options) {\r\n        let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() })\r\n            .set('grant_type', 'authorization_code')\r\n            .set('code', code)\r\n            .set('redirect_uri', options.customRedirectUri || this.redirectUri);\r\n        if (!this.disablePKCE) {\r\n            let PKCEVerifier;\r\n            if (this.saveNoncesInLocalStorage &&\r\n                typeof window['localStorage'] !== 'undefined') {\r\n                PKCEVerifier = localStorage.getItem('PKCE_verifier');\r\n            }\r\n            else {\r\n                PKCEVerifier = this._storage.getItem('PKCE_verifier');\r\n            }\r\n            if (!PKCEVerifier) {\r\n                console.warn('No PKCE verifier found in oauth storage!');\r\n            }\r\n            else {\r\n                params = params.set('code_verifier', PKCEVerifier);\r\n            }\r\n        }\r\n        return this.fetchAndProcessToken(params, options);\r\n    }\r\n    fetchAndProcessToken(params, options) {\r\n        options = options || {};\r\n        this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint, 'tokenEndpoint');\r\n        let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\r\n        if (this.useHttpBasicAuth) {\r\n            const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n            headers = headers.set('Authorization', 'Basic ' + header);\r\n        }\r\n        if (!this.useHttpBasicAuth) {\r\n            params = params.set('client_id', this.clientId);\r\n        }\r\n        if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n            params = params.set('client_secret', this.dummyClientSecret);\r\n        }\r\n        return new Promise((resolve, reject) => {\r\n            if (this.customQueryParams) {\r\n                for (let key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n                    params = params.set(key, this.customQueryParams[key]);\r\n                }\r\n            }\r\n            this.http\r\n                .post(this.tokenEndpoint, params, { headers })\r\n                .subscribe((tokenResponse) => {\r\n                this.debug('refresh tokenResponse', tokenResponse);\r\n                this.storeAccessTokenResponse(tokenResponse.access_token, tokenResponse.refresh_token, tokenResponse.expires_in ||\r\n                    this.fallbackAccessTokenExpirationTimeInSec, tokenResponse.scope, this.extractRecognizedCustomParameters(tokenResponse));\r\n                if (this.oidc && tokenResponse.id_token) {\r\n                    this.processIdToken(tokenResponse.id_token, tokenResponse.access_token, options.disableNonceCheck)\r\n                        .then((result) => {\r\n                        this.storeIdToken(result);\r\n                        this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n                        this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\r\n                        resolve(tokenResponse);\r\n                    })\r\n                        .catch((reason) => {\r\n                        this.eventsSubject.next(new OAuthErrorEvent('token_validation_error', reason));\r\n                        console.error('Error validating tokens');\r\n                        console.error(reason);\r\n                        reject(reason);\r\n                    });\r\n                }\r\n                else {\r\n                    this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n                    this.eventsSubject.next(new OAuthSuccessEvent('token_refreshed'));\r\n                    resolve(tokenResponse);\r\n                }\r\n            }, (err) => {\r\n                console.error('Error getting token', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('token_refresh_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Checks whether there are tokens in the hash fragment\r\n     * as a result of the implicit flow. These tokens are\r\n     * parsed, validated and used to sign the user in to the\r\n     * current client.\r\n     *\r\n     * @param options Optional options.\r\n     */\r\n    tryLoginImplicitFlow(options = null) {\r\n        options = options || {};\r\n        let parts;\r\n        if (options.customHashFragment) {\r\n            parts = this.urlHelper.getHashFragmentParams(options.customHashFragment);\r\n        }\r\n        else {\r\n            parts = this.urlHelper.getHashFragmentParams();\r\n        }\r\n        this.debug('parsed url', parts);\r\n        const state = parts['state'];\r\n        let [nonceInState, userState] = this.parseState(state);\r\n        this.state = userState;\r\n        if (parts['error']) {\r\n            this.debug('error trying to login');\r\n            this.handleLoginError(options, parts);\r\n            const err = new OAuthErrorEvent('token_error', {}, parts);\r\n            this.eventsSubject.next(err);\r\n            return Promise.reject(err);\r\n        }\r\n        const accessToken = parts['access_token'];\r\n        const idToken = parts['id_token'];\r\n        const sessionState = parts['session_state'];\r\n        const grantedScopes = parts['scope'];\r\n        if (!this.requestAccessToken && !this.oidc) {\r\n            return Promise.reject('Either requestAccessToken or oidc (or both) must be true.');\r\n        }\r\n        if (this.requestAccessToken && !accessToken) {\r\n            return Promise.resolve(false);\r\n        }\r\n        if (this.requestAccessToken && !options.disableOAuth2StateCheck && !state) {\r\n            return Promise.resolve(false);\r\n        }\r\n        if (this.oidc && !idToken) {\r\n            return Promise.resolve(false);\r\n        }\r\n        if (this.sessionChecksEnabled && !sessionState) {\r\n            this.logger.warn('session checks (Session Status Change Notification) ' +\r\n                'were activated in the configuration but the id_token ' +\r\n                'does not contain a session_state claim');\r\n        }\r\n        if (this.requestAccessToken && !options.disableNonceCheck) {\r\n            const success = this.validateNonce(nonceInState);\r\n            if (!success) {\r\n                const event = new OAuthErrorEvent('invalid_nonce_in_state', null);\r\n                this.eventsSubject.next(event);\r\n                return Promise.reject(event);\r\n            }\r\n        }\r\n        if (this.requestAccessToken) {\r\n            this.storeAccessTokenResponse(accessToken, null, parts['expires_in'] || this.fallbackAccessTokenExpirationTimeInSec, grantedScopes);\r\n        }\r\n        if (!this.oidc) {\r\n            this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n            if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n                this.clearLocationHash();\r\n            }\r\n            this.callOnTokenReceivedIfExists(options);\r\n            return Promise.resolve(true);\r\n        }\r\n        return this.processIdToken(idToken, accessToken, options.disableNonceCheck)\r\n            .then((result) => {\r\n            if (options.validationHandler) {\r\n                return options\r\n                    .validationHandler({\r\n                    accessToken: accessToken,\r\n                    idClaims: result.idTokenClaims,\r\n                    idToken: result.idToken,\r\n                    state: state,\r\n                })\r\n                    .then((_) => result);\r\n            }\r\n            return result;\r\n        })\r\n            .then((result) => {\r\n            this.storeIdToken(result);\r\n            this.storeSessionState(sessionState);\r\n            if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n                this.clearLocationHash();\r\n            }\r\n            this.eventsSubject.next(new OAuthSuccessEvent('token_received'));\r\n            this.callOnTokenReceivedIfExists(options);\r\n            this.inImplicitFlow = false;\r\n            return true;\r\n        })\r\n            .catch((reason) => {\r\n            this.eventsSubject.next(new OAuthErrorEvent('token_validation_error', reason));\r\n            this.logger.error('Error validating tokens');\r\n            this.logger.error(reason);\r\n            return Promise.reject(reason);\r\n        });\r\n    }\r\n    parseState(state) {\r\n        let nonce = state;\r\n        let userState = '';\r\n        if (state) {\r\n            const idx = state.indexOf(this.config.nonceStateSeparator);\r\n            if (idx > -1) {\r\n                nonce = state.substr(0, idx);\r\n                userState = state.substr(idx + this.config.nonceStateSeparator.length);\r\n            }\r\n        }\r\n        return [nonce, userState];\r\n    }\r\n    validateNonce(nonceInState) {\r\n        let savedNonce;\r\n        if (this.saveNoncesInLocalStorage &&\r\n            typeof window['localStorage'] !== 'undefined') {\r\n            savedNonce = localStorage.getItem('nonce');\r\n        }\r\n        else {\r\n            savedNonce = this._storage.getItem('nonce');\r\n        }\r\n        if (savedNonce !== nonceInState) {\r\n            const err = 'Validating access_token failed, wrong state/nonce.';\r\n            console.error(err, savedNonce, nonceInState);\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n    storeIdToken(idToken) {\r\n        this._storage.setItem('id_token', idToken.idToken);\r\n        this._storage.setItem('id_token_claims_obj', idToken.idTokenClaimsJson);\r\n        this._storage.setItem('id_token_expires_at', '' + idToken.idTokenExpiresAt);\r\n        this._storage.setItem('id_token_stored_at', '' + this.dateTimeService.now());\r\n    }\r\n    storeSessionState(sessionState) {\r\n        this._storage.setItem('session_state', sessionState);\r\n    }\r\n    getSessionState() {\r\n        return this._storage.getItem('session_state');\r\n    }\r\n    handleLoginError(options, parts) {\r\n        if (options.onLoginError) {\r\n            options.onLoginError(parts);\r\n        }\r\n        if (this.clearHashAfterLogin && !options.preventClearHashAfterLogin) {\r\n            this.clearLocationHash();\r\n        }\r\n    }\r\n    getClockSkewInMsec(defaultSkewMsc = 600000) {\r\n        if (!this.clockSkewInSec) {\r\n            return defaultSkewMsc;\r\n        }\r\n        return this.clockSkewInSec * 1000;\r\n    }\r\n    /**\r\n     * @ignore\r\n     */\r\n    processIdToken(idToken, accessToken, skipNonceCheck = false) {\r\n        const tokenParts = idToken.split('.');\r\n        const headerBase64 = this.padBase64(tokenParts[0]);\r\n        const headerJson = b64DecodeUnicode(headerBase64);\r\n        const header = JSON.parse(headerJson);\r\n        const claimsBase64 = this.padBase64(tokenParts[1]);\r\n        const claimsJson = b64DecodeUnicode(claimsBase64);\r\n        const claims = JSON.parse(claimsJson);\r\n        let savedNonce;\r\n        if (this.saveNoncesInLocalStorage &&\r\n            typeof window['localStorage'] !== 'undefined') {\r\n            savedNonce = localStorage.getItem('nonce');\r\n        }\r\n        else {\r\n            savedNonce = this._storage.getItem('nonce');\r\n        }\r\n        if (Array.isArray(claims.aud)) {\r\n            if (claims.aud.every((v) => v !== this.clientId)) {\r\n                const err = 'Wrong audience: ' + claims.aud.join(',');\r\n                this.logger.warn(err);\r\n                return Promise.reject(err);\r\n            }\r\n        }\r\n        else {\r\n            if (claims.aud !== this.clientId) {\r\n                const err = 'Wrong audience: ' + claims.aud;\r\n                this.logger.warn(err);\r\n                return Promise.reject(err);\r\n            }\r\n        }\r\n        if (!claims.sub) {\r\n            const err = 'No sub claim in id_token';\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        /* For now, we only check whether the sub against\r\n         * silentRefreshSubject when sessionChecksEnabled is on\r\n         * We will reconsider in a later version to do this\r\n         * in every other case too.\r\n         */\r\n        if (this.sessionChecksEnabled &&\r\n            this.silentRefreshSubject &&\r\n            this.silentRefreshSubject !== claims['sub']) {\r\n            const err = 'After refreshing, we got an id_token for another user (sub). ' +\r\n                `Expected sub: ${this.silentRefreshSubject}, received sub: ${claims['sub']}`;\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        if (!claims.iat) {\r\n            const err = 'No iat claim in id_token';\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        if (!this.skipIssuerCheck && claims.iss !== this.issuer) {\r\n            const err = 'Wrong issuer: ' + claims.iss;\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        if (!skipNonceCheck && claims.nonce !== savedNonce) {\r\n            const err = 'Wrong nonce: ' + claims.nonce;\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        // at_hash is not applicable to authorization code flow\r\n        // addressing https://github.com/manfredsteyer/angular-oauth2-oidc/issues/661\r\n        // i.e. Based on spec the at_hash check is only true for implicit code flow on Ping Federate\r\n        // https://www.pingidentity.com/developer/en/resources/openid-connect-developers-guide.html\r\n        if (this.hasOwnProperty('responseType') &&\r\n            (this.responseType === 'code' || this.responseType === 'id_token')) {\r\n            this.disableAtHashCheck = true;\r\n        }\r\n        if (!this.disableAtHashCheck &&\r\n            this.requestAccessToken &&\r\n            !claims['at_hash']) {\r\n            const err = 'An at_hash is needed!';\r\n            this.logger.warn(err);\r\n            return Promise.reject(err);\r\n        }\r\n        const now = this.dateTimeService.now();\r\n        const issuedAtMSec = claims.iat * 1000;\r\n        const expiresAtMSec = claims.exp * 1000;\r\n        const clockSkewInMSec = this.getClockSkewInMsec(); // (this.getClockSkewInMsec() || 600) * 1000;\r\n        if (issuedAtMSec - clockSkewInMSec >= now ||\r\n            expiresAtMSec + clockSkewInMSec <= now) {\r\n            const err = 'Token has expired';\r\n            console.error(err);\r\n            console.error({\r\n                now: now,\r\n                issuedAtMSec: issuedAtMSec,\r\n                expiresAtMSec: expiresAtMSec,\r\n            });\r\n            return Promise.reject(err);\r\n        }\r\n        const validationParams = {\r\n            accessToken: accessToken,\r\n            idToken: idToken,\r\n            jwks: this.jwks,\r\n            idTokenClaims: claims,\r\n            idTokenHeader: header,\r\n            loadKeys: () => this.loadJwks(),\r\n        };\r\n        if (this.disableAtHashCheck) {\r\n            return this.checkSignature(validationParams).then((_) => {\r\n                const result = {\r\n                    idToken: idToken,\r\n                    idTokenClaims: claims,\r\n                    idTokenClaimsJson: claimsJson,\r\n                    idTokenHeader: header,\r\n                    idTokenHeaderJson: headerJson,\r\n                    idTokenExpiresAt: expiresAtMSec,\r\n                };\r\n                return result;\r\n            });\r\n        }\r\n        return this.checkAtHash(validationParams).then((atHashValid) => {\r\n            if (!this.disableAtHashCheck && this.requestAccessToken && !atHashValid) {\r\n                const err = 'Wrong at_hash';\r\n                this.logger.warn(err);\r\n                return Promise.reject(err);\r\n            }\r\n            return this.checkSignature(validationParams).then((_) => {\r\n                const atHashCheckEnabled = !this.disableAtHashCheck;\r\n                const result = {\r\n                    idToken: idToken,\r\n                    idTokenClaims: claims,\r\n                    idTokenClaimsJson: claimsJson,\r\n                    idTokenHeader: header,\r\n                    idTokenHeaderJson: headerJson,\r\n                    idTokenExpiresAt: expiresAtMSec,\r\n                };\r\n                if (atHashCheckEnabled) {\r\n                    return this.checkAtHash(validationParams).then((atHashValid) => {\r\n                        if (this.requestAccessToken && !atHashValid) {\r\n                            const err = 'Wrong at_hash';\r\n                            this.logger.warn(err);\r\n                            return Promise.reject(err);\r\n                        }\r\n                        else {\r\n                            return result;\r\n                        }\r\n                    });\r\n                }\r\n                else {\r\n                    return result;\r\n                }\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Returns the received claims about the user.\r\n     */\r\n    getIdentityClaims() {\r\n        const claims = this._storage.getItem('id_token_claims_obj');\r\n        if (!claims) {\r\n            return null;\r\n        }\r\n        return JSON.parse(claims);\r\n    }\r\n    /**\r\n     * Returns the granted scopes from the server.\r\n     */\r\n    getGrantedScopes() {\r\n        const scopes = this._storage.getItem('granted_scopes');\r\n        if (!scopes) {\r\n            return null;\r\n        }\r\n        return JSON.parse(scopes);\r\n    }\r\n    /**\r\n     * Returns the current id_token.\r\n     */\r\n    getIdToken() {\r\n        return this._storage ? this._storage.getItem('id_token') : null;\r\n    }\r\n    padBase64(base64data) {\r\n        while (base64data.length % 4 !== 0) {\r\n            base64data += '=';\r\n        }\r\n        return base64data;\r\n    }\r\n    /**\r\n     * Returns the current access_token.\r\n     */\r\n    getAccessToken() {\r\n        return this._storage ? this._storage.getItem('access_token') : null;\r\n    }\r\n    getRefreshToken() {\r\n        return this._storage ? this._storage.getItem('refresh_token') : null;\r\n    }\r\n    /**\r\n     * Returns the expiration date of the access_token\r\n     * as milliseconds since 1970.\r\n     */\r\n    getAccessTokenExpiration() {\r\n        if (!this._storage.getItem('expires_at')) {\r\n            return null;\r\n        }\r\n        return parseInt(this._storage.getItem('expires_at'), 10);\r\n    }\r\n    getAccessTokenStoredAt() {\r\n        return parseInt(this._storage.getItem('access_token_stored_at'), 10);\r\n    }\r\n    getIdTokenStoredAt() {\r\n        return parseInt(this._storage.getItem('id_token_stored_at'), 10);\r\n    }\r\n    /**\r\n     * Returns the expiration date of the id_token\r\n     * as milliseconds since 1970.\r\n     */\r\n    getIdTokenExpiration() {\r\n        if (!this._storage.getItem('id_token_expires_at')) {\r\n            return null;\r\n        }\r\n        return parseInt(this._storage.getItem('id_token_expires_at'), 10);\r\n    }\r\n    /**\r\n     * Checkes, whether there is a valid access_token.\r\n     */\r\n    hasValidAccessToken() {\r\n        if (this.getAccessToken()) {\r\n            const expiresAt = this._storage.getItem('expires_at');\r\n            const now = this.dateTimeService.new();\r\n            if (expiresAt &&\r\n                parseInt(expiresAt, 10) < now.getTime() - this.getClockSkewInMsec()) {\r\n                return false;\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    /**\r\n     * Checks whether there is a valid id_token.\r\n     */\r\n    hasValidIdToken() {\r\n        if (this.getIdToken()) {\r\n            const expiresAt = this._storage.getItem('id_token_expires_at');\r\n            const now = this.dateTimeService.new();\r\n            if (expiresAt &&\r\n                parseInt(expiresAt, 10) < now.getTime() - this.getClockSkewInMsec()) {\r\n                return false;\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    /**\r\n     * Retrieve a saved custom property of the TokenReponse object. Only if predefined in authconfig.\r\n     */\r\n    getCustomTokenResponseProperty(requestedProperty) {\r\n        return this._storage &&\r\n            this.config.customTokenParameters &&\r\n            this.config.customTokenParameters.indexOf(requestedProperty) >= 0 &&\r\n            this._storage.getItem(requestedProperty) !== null\r\n            ? JSON.parse(this._storage.getItem(requestedProperty))\r\n            : null;\r\n    }\r\n    /**\r\n     * Returns the auth-header that can be used\r\n     * to transmit the access_token to a service\r\n     */\r\n    authorizationHeader() {\r\n        return 'Bearer ' + this.getAccessToken();\r\n    }\r\n    logOut(customParameters = {}, state = '') {\r\n        let noRedirectToLogoutUrl = false;\r\n        if (typeof customParameters === 'boolean') {\r\n            noRedirectToLogoutUrl = customParameters;\r\n            customParameters = {};\r\n        }\r\n        const id_token = this.getIdToken();\r\n        this._storage.removeItem('access_token');\r\n        this._storage.removeItem('id_token');\r\n        this._storage.removeItem('refresh_token');\r\n        if (this.saveNoncesInLocalStorage) {\r\n            localStorage.removeItem('nonce');\r\n            localStorage.removeItem('PKCE_verifier');\r\n        }\r\n        else {\r\n            this._storage.removeItem('nonce');\r\n            this._storage.removeItem('PKCE_verifier');\r\n        }\r\n        this._storage.removeItem('expires_at');\r\n        this._storage.removeItem('id_token_claims_obj');\r\n        this._storage.removeItem('id_token_expires_at');\r\n        this._storage.removeItem('id_token_stored_at');\r\n        this._storage.removeItem('access_token_stored_at');\r\n        this._storage.removeItem('granted_scopes');\r\n        this._storage.removeItem('session_state');\r\n        if (this.config.customTokenParameters) {\r\n            this.config.customTokenParameters.forEach((customParam) => this._storage.removeItem(customParam));\r\n        }\r\n        this.silentRefreshSubject = null;\r\n        this.eventsSubject.next(new OAuthInfoEvent('logout'));\r\n        if (!this.logoutUrl) {\r\n            return;\r\n        }\r\n        if (noRedirectToLogoutUrl) {\r\n            return;\r\n        }\r\n        if (!id_token && !this.postLogoutRedirectUri) {\r\n            return;\r\n        }\r\n        let logoutUrl;\r\n        if (!this.validateUrlForHttps(this.logoutUrl)) {\r\n            throw new Error(\"logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n        }\r\n        // For backward compatibility\r\n        if (this.logoutUrl.indexOf('{{') > -1) {\r\n            logoutUrl = this.logoutUrl\r\n                .replace(/\\{\\{id_token\\}\\}/, encodeURIComponent(id_token))\r\n                .replace(/\\{\\{client_id\\}\\}/, encodeURIComponent(this.clientId));\r\n        }\r\n        else {\r\n            let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() });\r\n            if (id_token) {\r\n                params = params.set('id_token_hint', id_token);\r\n            }\r\n            const postLogoutUrl = this.postLogoutRedirectUri ||\r\n                (this.redirectUriAsPostLogoutRedirectUriFallback && this.redirectUri) ||\r\n                '';\r\n            if (postLogoutUrl) {\r\n                params = params.set('post_logout_redirect_uri', postLogoutUrl);\r\n                if (state) {\r\n                    params = params.set('state', state);\r\n                }\r\n            }\r\n            for (let key in customParameters) {\r\n                params = params.set(key, customParameters[key]);\r\n            }\r\n            logoutUrl =\r\n                this.logoutUrl +\r\n                    (this.logoutUrl.indexOf('?') > -1 ? '&' : '?') +\r\n                    params.toString();\r\n        }\r\n        this.config.openUri(logoutUrl);\r\n    }\r\n    /**\r\n     * @ignore\r\n     */\r\n    createAndSaveNonce() {\r\n        const that = this;\r\n        return this.createNonce().then(function (nonce) {\r\n            // Use localStorage for nonce if possible\r\n            // localStorage is the only storage who survives a\r\n            // redirect in ALL browsers (also IE)\r\n            // Otherwiese we'd force teams who have to support\r\n            // IE into using localStorage for everything\r\n            if (that.saveNoncesInLocalStorage &&\r\n                typeof window['localStorage'] !== 'undefined') {\r\n                localStorage.setItem('nonce', nonce);\r\n            }\r\n            else {\r\n                that._storage.setItem('nonce', nonce);\r\n            }\r\n            return nonce;\r\n        });\r\n    }\r\n    /**\r\n     * @ignore\r\n     */\r\n    ngOnDestroy() {\r\n        this.clearAccessTokenTimer();\r\n        this.clearIdTokenTimer();\r\n        this.removeSilentRefreshEventListener();\r\n        const silentRefreshFrame = this.document.getElementById(this.silentRefreshIFrameName);\r\n        if (silentRefreshFrame) {\r\n            silentRefreshFrame.remove();\r\n        }\r\n        this.stopSessionCheckTimer();\r\n        this.removeSessionCheckEventListener();\r\n        const sessionCheckFrame = this.document.getElementById(this.sessionCheckIFrameName);\r\n        if (sessionCheckFrame) {\r\n            sessionCheckFrame.remove();\r\n        }\r\n    }\r\n    createNonce() {\r\n        return new Promise((resolve) => {\r\n            if (this.rngUrl) {\r\n                throw new Error('createNonce with rng-web-api has not been implemented so far');\r\n            }\r\n            /*\r\n             * This alphabet is from:\r\n             * https://tools.ietf.org/html/rfc7636#section-4.1\r\n             *\r\n             * [A-Z] / [a-z] / [0-9] / \"-\" / \".\" / \"_\" / \"~\"\r\n             */\r\n            const unreserved = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';\r\n            let size = 45;\r\n            let id = '';\r\n            const crypto = typeof self === 'undefined' ? null : self.crypto || self['msCrypto'];\r\n            if (crypto) {\r\n                let bytes = new Uint8Array(size);\r\n                crypto.getRandomValues(bytes);\r\n                // Needed for IE\r\n                if (!bytes.map) {\r\n                    bytes.map = Array.prototype.map;\r\n                }\r\n                bytes = bytes.map((x) => unreserved.charCodeAt(x % unreserved.length));\r\n                id = String.fromCharCode.apply(null, bytes);\r\n            }\r\n            else {\r\n                while (0 < size--) {\r\n                    id += unreserved[(Math.random() * unreserved.length) | 0];\r\n                }\r\n            }\r\n            resolve(base64UrlEncode(id));\r\n        });\r\n    }\r\n    checkAtHash(params) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.tokenValidationHandler) {\r\n                this.logger.warn('No tokenValidationHandler configured. Cannot check at_hash.');\r\n                return true;\r\n            }\r\n            return this.tokenValidationHandler.validateAtHash(params);\r\n        });\r\n    }\r\n    checkSignature(params) {\r\n        if (!this.tokenValidationHandler) {\r\n            this.logger.warn('No tokenValidationHandler configured. Cannot check signature.');\r\n            return Promise.resolve(null);\r\n        }\r\n        return this.tokenValidationHandler.validateSignature(params);\r\n    }\r\n    /**\r\n     * Start the implicit flow or the code flow,\r\n     * depending on your configuration.\r\n     */\r\n    initLoginFlow(additionalState = '', params = {}) {\r\n        if (this.responseType === 'code') {\r\n            return this.initCodeFlow(additionalState, params);\r\n        }\r\n        else {\r\n            return this.initImplicitFlow(additionalState, params);\r\n        }\r\n    }\r\n    /**\r\n     * Starts the authorization code flow and redirects to user to\r\n     * the auth servers login url.\r\n     */\r\n    initCodeFlow(additionalState = '', params = {}) {\r\n        if (this.loginUrl !== '') {\r\n            this.initCodeFlowInternal(additionalState, params);\r\n        }\r\n        else {\r\n            this.events\r\n                .pipe(filter((e) => e.type === 'discovery_document_loaded'))\r\n                .subscribe((_) => this.initCodeFlowInternal(additionalState, params));\r\n        }\r\n    }\r\n    initCodeFlowInternal(additionalState = '', params = {}) {\r\n        if (!this.validateUrlForHttps(this.loginUrl)) {\r\n            throw new Error(\"loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).\");\r\n        }\r\n        let addParams = {};\r\n        let loginHint = null;\r\n        if (typeof params === 'string') {\r\n            loginHint = params;\r\n        }\r\n        else if (typeof params === 'object') {\r\n            addParams = params;\r\n        }\r\n        this.createLoginUrl(additionalState, loginHint, null, false, addParams)\r\n            .then(this.config.openUri)\r\n            .catch((error) => {\r\n            console.error('Error in initAuthorizationCodeFlow');\r\n            console.error(error);\r\n        });\r\n    }\r\n    createChallangeVerifierPairForPKCE() {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.crypto) {\r\n                throw new Error('PKCE support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?');\r\n            }\r\n            const verifier = yield this.createNonce();\r\n            const challengeRaw = yield this.crypto.calcHash(verifier, 'sha-256');\r\n            const challenge = base64UrlEncode(challengeRaw);\r\n            return [challenge, verifier];\r\n        });\r\n    }\r\n    extractRecognizedCustomParameters(tokenResponse) {\r\n        let foundParameters = new Map();\r\n        if (!this.config.customTokenParameters) {\r\n            return foundParameters;\r\n        }\r\n        this.config.customTokenParameters.forEach((recognizedParameter) => {\r\n            if (tokenResponse[recognizedParameter]) {\r\n                foundParameters.set(recognizedParameter, JSON.stringify(tokenResponse[recognizedParameter]));\r\n            }\r\n        });\r\n        return foundParameters;\r\n    }\r\n    /**\r\n     * Revokes the auth token to secure the vulnarability\r\n     * of the token issued allowing the authorization server to clean\r\n     * up any security credentials associated with the authorization\r\n     */\r\n    revokeTokenAndLogout(customParameters = {}, ignoreCorsIssues = false) {\r\n        let revokeEndpoint = this.revocationEndpoint;\r\n        let accessToken = this.getAccessToken();\r\n        let refreshToken = this.getRefreshToken();\r\n        if (!accessToken) {\r\n            return;\r\n        }\r\n        let params = new HttpParams({ encoder: new WebHttpUrlEncodingCodec() });\r\n        let headers = new HttpHeaders().set('Content-Type', 'application/x-www-form-urlencoded');\r\n        if (this.useHttpBasicAuth) {\r\n            const header = btoa(`${this.clientId}:${this.dummyClientSecret}`);\r\n            headers = headers.set('Authorization', 'Basic ' + header);\r\n        }\r\n        if (!this.useHttpBasicAuth) {\r\n            params = params.set('client_id', this.clientId);\r\n        }\r\n        if (!this.useHttpBasicAuth && this.dummyClientSecret) {\r\n            params = params.set('client_secret', this.dummyClientSecret);\r\n        }\r\n        if (this.customQueryParams) {\r\n            for (const key of Object.getOwnPropertyNames(this.customQueryParams)) {\r\n                params = params.set(key, this.customQueryParams[key]);\r\n            }\r\n        }\r\n        return new Promise((resolve, reject) => {\r\n            let revokeAccessToken;\r\n            let revokeRefreshToken;\r\n            if (accessToken) {\r\n                let revokationParams = params\r\n                    .set('token', accessToken)\r\n                    .set('token_type_hint', 'access_token');\r\n                revokeAccessToken = this.http.post(revokeEndpoint, revokationParams, { headers });\r\n            }\r\n            else {\r\n                revokeAccessToken = of(null);\r\n            }\r\n            if (refreshToken) {\r\n                let revokationParams = params\r\n                    .set('token', refreshToken)\r\n                    .set('token_type_hint', 'refresh_token');\r\n                revokeRefreshToken = this.http.post(revokeEndpoint, revokationParams, { headers });\r\n            }\r\n            else {\r\n                revokeRefreshToken = of(null);\r\n            }\r\n            if (ignoreCorsIssues) {\r\n                revokeAccessToken = revokeAccessToken.pipe(catchError((err) => {\r\n                    if (err.status === 0) {\r\n                        return of(null);\r\n                    }\r\n                    return throwError(err);\r\n                }));\r\n                revokeRefreshToken = revokeRefreshToken.pipe(catchError((err) => {\r\n                    if (err.status === 0) {\r\n                        return of(null);\r\n                    }\r\n                    return throwError(err);\r\n                }));\r\n            }\r\n            combineLatest([revokeAccessToken, revokeRefreshToken]).subscribe((res) => {\r\n                this.logOut(customParameters);\r\n                resolve(res);\r\n                this.logger.info('Token successfully revoked');\r\n            }, (err) => {\r\n                this.logger.error('Error revoking token', err);\r\n                this.eventsSubject.next(new OAuthErrorEvent('token_revoke_error', err));\r\n                reject(err);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * Clear location.hash if it's present\r\n     */\r\n    clearLocationHash() {\r\n        // Checking for empty hash is necessary for Firefox\r\n        // as setting an empty hash to an empty string adds # to the URL\r\n        if (location.hash != '') {\r\n            location.hash = '';\r\n        }\r\n    }\r\n}\r\nOAuthService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthService, deps: [{ token: i0.NgZone }, { token: i1.HttpClient }, { token: OAuthStorage, optional: true }, { token: ValidationHandler, optional: true }, { token: AuthConfig, optional: true }, { token: UrlHelperService }, { token: OAuthLogger }, { token: HashHandler, optional: true }, { token: DOCUMENT }, { token: DateTimeProvider }], target: i0.ɵɵFactoryTarget.Injectable });\r\nOAuthService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthService });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthService, decorators: [{\r\n            type: Injectable\r\n        }], ctorParameters: function () {\r\n        return [{ type: i0.NgZone }, { type: i1.HttpClient }, { type: OAuthStorage, decorators: [{\r\n                        type: Optional\r\n                    }] }, { type: ValidationHandler, decorators: [{\r\n                        type: Optional\r\n                    }] }, { type: AuthConfig, decorators: [{\r\n                        type: Optional\r\n                    }] }, { type: UrlHelperService }, { type: OAuthLogger }, { type: HashHandler, decorators: [{\r\n                        type: Optional\r\n                    }] }, { type: undefined, decorators: [{\r\n                        type: Inject,\r\n                        args: [DOCUMENT]\r\n                    }] }, { type: DateTimeProvider }];\r\n    } });\n\nclass OAuthModuleConfig {\r\n}\r\nclass OAuthResourceServerConfig {\r\n}\n\nclass OAuthResourceServerErrorHandler {\r\n}\r\nclass OAuthNoopResourceServerErrorHandler {\r\n    handleError(err) {\r\n        return throwError(err);\r\n    }\r\n}\n\nclass DefaultOAuthInterceptor {\r\n    constructor(oAuthService, errorHandler, moduleConfig) {\r\n        this.oAuthService = oAuthService;\r\n        this.errorHandler = errorHandler;\r\n        this.moduleConfig = moduleConfig;\r\n    }\r\n    checkUrl(url) {\r\n        if (this.moduleConfig.resourceServer.customUrlValidation) {\r\n            return this.moduleConfig.resourceServer.customUrlValidation(url);\r\n        }\r\n        if (this.moduleConfig.resourceServer.allowedUrls) {\r\n            return !!this.moduleConfig.resourceServer.allowedUrls.find((u) => url.toLowerCase().startsWith(u.toLowerCase()));\r\n        }\r\n        return true;\r\n    }\r\n    intercept(req, next) {\r\n        const url = req.url.toLowerCase();\r\n        if (!this.moduleConfig ||\r\n            !this.moduleConfig.resourceServer ||\r\n            !this.checkUrl(url)) {\r\n            return next.handle(req);\r\n        }\r\n        const sendAccessToken = this.moduleConfig.resourceServer.sendAccessToken;\r\n        if (!sendAccessToken) {\r\n            return next\r\n                .handle(req)\r\n                .pipe(catchError((err) => this.errorHandler.handleError(err)));\r\n        }\r\n        return merge(of(this.oAuthService.getAccessToken()).pipe(filter((token) => !!token)), this.oAuthService.events.pipe(filter((e) => e.type === 'token_received'), timeout(this.oAuthService.waitForTokenInMsec || 0), catchError((_) => of(null)), // timeout is not an error\r\n        map((_) => this.oAuthService.getAccessToken()))).pipe(take(1), mergeMap((token) => {\r\n            if (token) {\r\n                const header = 'Bearer ' + token;\r\n                const headers = req.headers.set('Authorization', header);\r\n                req = req.clone({ headers });\r\n            }\r\n            return next\r\n                .handle(req)\r\n                .pipe(catchError((err) => this.errorHandler.handleError(err)));\r\n        }));\r\n    }\r\n}\r\nDefaultOAuthInterceptor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultOAuthInterceptor, deps: [{ token: OAuthService }, { token: OAuthResourceServerErrorHandler }, { token: OAuthModuleConfig, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });\r\nDefaultOAuthInterceptor.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultOAuthInterceptor });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: DefaultOAuthInterceptor, decorators: [{\r\n            type: Injectable\r\n        }], ctorParameters: function () {\r\n        return [{ type: OAuthService }, { type: OAuthResourceServerErrorHandler }, { type: OAuthModuleConfig, decorators: [{\r\n                        type: Optional\r\n                    }] }];\r\n    } });\n\n/**\r\n * A validation handler that isn't validating nothing.\r\n * Can be used to skip validation (at your own risk).\r\n */\r\nclass NullValidationHandler {\r\n    validateSignature(validationParams) {\r\n        return Promise.resolve(null);\r\n    }\r\n    validateAtHash(validationParams) {\r\n        return Promise.resolve(true);\r\n    }\r\n}\n\nfunction createDefaultLogger() {\r\n    return console;\r\n}\r\nfunction createDefaultStorage() {\r\n    return typeof sessionStorage !== 'undefined'\r\n        ? sessionStorage\r\n        : new MemoryStorage();\r\n}\n\nclass OAuthModule {\r\n    static forRoot(config = null, validationHandlerClass = NullValidationHandler) {\r\n        return {\r\n            ngModule: OAuthModule,\r\n            providers: [\r\n                OAuthService,\r\n                UrlHelperService,\r\n                { provide: OAuthLogger, useFactory: createDefaultLogger },\r\n                { provide: OAuthStorage, useFactory: createDefaultStorage },\r\n                { provide: ValidationHandler, useClass: validationHandlerClass },\r\n                { provide: HashHandler, useClass: DefaultHashHandler },\r\n                {\r\n                    provide: OAuthResourceServerErrorHandler,\r\n                    useClass: OAuthNoopResourceServerErrorHandler,\r\n                },\r\n                { provide: OAuthModuleConfig, useValue: config },\r\n                {\r\n                    provide: HTTP_INTERCEPTORS,\r\n                    useClass: DefaultOAuthInterceptor,\r\n                    multi: true,\r\n                },\r\n                { provide: DateTimeProvider, useClass: SystemDateTimeProvider },\r\n            ],\r\n        };\r\n    }\r\n}\r\nOAuthModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\r\nOAuthModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthModule, imports: [CommonModule] });\r\nOAuthModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthModule, imports: [[CommonModule]] });\r\ni0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"13.0.1\", ngImport: i0, type: OAuthModule, decorators: [{\r\n            type: NgModule,\r\n            args: [{\r\n                    imports: [CommonModule],\r\n                    declarations: [],\r\n                    exports: [],\r\n                }]\r\n        }] });\n\nconst err = `PLEASE READ THIS CAREFULLY:\n\nBeginning with angular-oauth2-oidc version 9, the JwksValidationHandler\nhas been moved to an library of its own. If you need it for implementing\nOAuth2/OIDC **implicit flow**, please install it using npm:\n\n  npm i angular-oauth2-oidc-jwks --save\n\nAfter that, you can import it into your application:\n\n  import { JwksValidationHandler } from 'angular-oauth2-oidc-jwks';\n\nPlease note, that this dependency is not needed for the **code flow**,\nwhich is nowadays the **recommented** one for single page applications.\nThis also results in smaller bundle sizes.\n`;\r\n/**\r\n * This is just a dummy of the JwksValidationHandler\r\n * telling the users that the real one has been moved\r\n * to an library of its own, namely angular-oauth2-oidc-utils\r\n */\r\nclass JwksValidationHandler extends NullValidationHandler {\r\n    constructor() {\r\n        super();\r\n        console.error(err);\r\n    }\r\n}\n\nconst AUTH_CONFIG = new InjectionToken('AUTH_CONFIG');\n\n/**\r\n * Generated bundle index. Do not edit.\r\n */\n\nexport { AUTH_CONFIG, AbstractValidationHandler, AuthConfig, DateTimeProvider, DefaultHashHandler, DefaultOAuthInterceptor, HashHandler, JwksValidationHandler, LoginOptions, MemoryStorage, NullValidationHandler, OAuthErrorEvent, OAuthEvent, OAuthInfoEvent, OAuthLogger, OAuthModule, OAuthModuleConfig, OAuthNoopResourceServerErrorHandler, OAuthResourceServerConfig, OAuthResourceServerErrorHandler, OAuthService, OAuthStorage, OAuthSuccessEvent, ReceivedTokens, SystemDateTimeProvider, UrlHelperService, ValidationHandler };\n"]},"metadata":{},"sourceType":"module"}